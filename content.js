var Re=Object.defineProperty;var Me=(T,P,M)=>P in T?Re(T,P,{enumerable:!0,configurable:!0,writable:!0,value:M}):T[P]=M;var h=(T,P,M)=>Me(T,typeof P!="symbol"?P+"":P,M);(function(){"use strict";class T{static isBacklogPage(){const e=window.location.hostname;return e.includes(".backlog.jp")||e.includes(".backlog.com")}static getPageInfo(){const e=window.location.href,t=window.location.pathname;let n;const s=t.match(/\/view\/([A-Z0-9_]+)/),r=t.match(/\/board\/([A-Z0-9_]+)/);s?n=s[1]:r&&(n=r[1]);let i="other";t.includes("/dashboard")?i="top":t.includes("/board/")?i="board":t.includes("/view/")&&!t.includes("/git/")?i="issue":t.includes("/wiki/")?i="wiki":t.includes("/git/")&&(i="git");let a;if(i==="issue"){const c=t.match(/\/view\/([A-Z0-9_]+-\d+)/);a=c?c[1]:void 0}return{type:i,projectKey:n,issueKey:a,url:e}}static waitForElement(e,t=5e3){return new Promise(n=>{const s=document.querySelector(e);if(s){n(s);return}const r=new MutationObserver(()=>{const i=document.querySelector(e);i&&(r.disconnect(),n(i))});r.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{r.disconnect(),n(null)},t)})}static findElementByCandidates(e){for(const t of e){const n=document.querySelector(t);if(n)return n}return null}static findElementsByCandidates(e){for(const t of e){const n=Array.from(document.querySelectorAll(t));if(n.length>0)return n}return[]}static observeChanges(e,t={childList:!0,subtree:!0}){const n=new MutationObserver(e);return n.observe(document.body,t),n}}const P={boardAccordion:{enabled:!0},shortcutKeys:{enabled:!0},issuePending:{enabled:!0,autoResolve:!0},prFormat:{enabled:!0,projectTemplates:{}},commentUrlCopy:{enabled:!0}};var M=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function de(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var te={exports:{}};(function(l){(function(e,t){l.exports?l.exports=t():e.log=t()})(M,function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),s=["trace","debug","info","warn","error"],r={},i=null;function a(p,S){var m=p[S];if(typeof m.bind=="function")return m.bind(p);try{return Function.prototype.bind.call(m,p)}catch{return function(){return Function.prototype.apply.apply(m,[p,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function u(p){return p==="debug"&&(p="log"),typeof console===t?!1:p==="trace"&&n?c:console[p]!==void 0?a(console,p):console.log!==void 0?a(console,"log"):e}function g(){for(var p=this.getLevel(),S=0;S<s.length;S++){var m=s[S];this[m]=S<p?e:this.methodFactory(m,p,this.name)}if(this.log=this.debug,typeof console===t&&p<this.levels.SILENT)return"No console available for logging"}function f(p){return function(){typeof console!==t&&(g.call(this),this[p].apply(this,arguments))}}function G(p,S,m){return u(p)||f.apply(this,arguments)}function O(p,S){var m=this,Y,ee,D,I="loglevel";typeof p=="string"?I+=":"+p:typeof p=="symbol"&&(I=void 0);function Oe(y){var E=(s[y]||"silent").toUpperCase();if(!(typeof window===t||!I)){try{window.localStorage[I]=E;return}catch{}try{window.document.cookie=encodeURIComponent(I)+"="+E+";"}catch{}}}function ae(){var y;if(!(typeof window===t||!I)){try{y=window.localStorage[I]}catch{}if(typeof y===t)try{var E=window.document.cookie,W=encodeURIComponent(I),le=E.indexOf(W+"=");le!==-1&&(y=/^([^;]+)/.exec(E.slice(le+W.length+1))[1])}catch{}return m.levels[y]===void 0&&(y=void 0),y}}function xe(){if(!(typeof window===t||!I)){try{window.localStorage.removeItem(I)}catch{}try{window.document.cookie=encodeURIComponent(I)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function H(y){var E=y;if(typeof E=="string"&&m.levels[E.toUpperCase()]!==void 0&&(E=m.levels[E.toUpperCase()]),typeof E=="number"&&E>=0&&E<=m.levels.SILENT)return E;throw new TypeError("log.setLevel() called with invalid level: "+y)}m.name=p,m.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},m.methodFactory=S||G,m.getLevel=function(){return D??ee??Y},m.setLevel=function(y,E){return D=H(y),E!==!1&&Oe(D),g.call(m)},m.setDefaultLevel=function(y){ee=H(y),ae()||m.setLevel(y,!1)},m.resetLevel=function(){D=null,xe(),g.call(m)},m.enableAll=function(y){m.setLevel(m.levels.TRACE,y)},m.disableAll=function(y){m.setLevel(m.levels.SILENT,y)},m.rebuild=function(){if(i!==m&&(Y=H(i.getLevel())),g.call(m),i===m)for(var y in r)r[y].rebuild()},Y=H(i?i.getLevel():"WARN");var ce=ae();ce!=null&&(D=H(ce)),g.call(m)}i=new O,i.getLogger=function(S){if(typeof S!="symbol"&&typeof S!="string"||S==="")throw new TypeError("You must supply a name when creating a logger.");var m=r[S];return m||(m=r[S]=new O(S,i.methodFactory)),m};var Q=typeof window!==t?window.log:void 0;return i.noConflict=function(){return typeof window!==t&&window.log===i&&(window.log=Q),i},i.getLoggers=function(){return r},i.default=i,i})})(te);var ue=te.exports;const v=de(ue),ne={level:"error",prefix:"[Backlog Enhancement]",timestamp:!0},$={},V=new Map;function ge(l){v.setLevel(l)}function F(l,e){const t=V.get(l);t&&t.setLevel(e),$[l]=e}function me(l){return $[l]||"info"}function he(){return{...$}}function fe(l){switch(l){case v.levels.DEBUG:return"debug";case v.levels.INFO:return"info";case v.levels.WARN:return"warn";case v.levels.ERROR:return"error";case v.levels.SILENT:return"silent";default:return"info"}}function pe(l){const e=V.get(l);if(e)return e;const t=v.getLogger(l),n=$[l]||fe(v.getLevel());t.setLevel(n);const s=t.methodFactory;return t.methodFactory=function(r,i,a){const c=s(r,i,a);return function(...u){const g=`[${new Date().toISOString()}]`,f=`${ne.prefix}`,G=`[${r.toUpperCase()}]`,O=`[${l.charAt(0).toUpperCase()+l.slice(1)}]`,Q=[`${g} ${f} ${G} ${O}`,...u].filter(Boolean);c(...Q)}},t.setLevel(t.getLevel()),V.set(l,t),t}function J(){if(typeof window>"u"||typeof chrome>"u")return!0;try{return window.location.hostname==="localhost"||window.location.hostname.includes("dev")||chrome.runtime.getManifest().version.includes("dev")}catch{return!0}}function ye(l){const e=v.methodFactory;v.methodFactory=function(t,n,s){const r=e(t,n,s);return function(...i){const a=l.timestamp?`[${new Date().toISOString()}]`:"",c=l.prefix?`${l.prefix}`:"",u=`[${t.toUpperCase()}]`,g=[`${a} ${c} ${u}`,...i].filter(Boolean);r(...g)}},v.setLevel(v.getLevel())}function be(l){const e={...ne,...l};J()?e.level="debug":e.level="warn",ye(e),ge(e.level),v.info("Logger initialized",{level:e.level,isDev:J()})}function _(l){const e=pe(l);return{debug:(...t)=>e.debug(...t),info:(...t)=>e.info(...t),warn:(...t)=>e.warn(...t),error:(...t)=>e.error(...t)}}const o={debug:(...l)=>v.debug(...l),info:(...l)=>v.info(...l),warn:(...l)=>v.warn(...l),error:(...l)=>v.error(...l),boardAccordion:_("boardAccordion"),issuePending:_("issuePending"),shortcutKeys:_("shortcutKeys"),storage:_("storage"),backlog:_("backlog"),background:_("background"),options:_("options"),content:_("content"),popup:_("popup")},Ce={setLevel:F,getLevel:me,showAll:()=>{console.table(he())},enable:l=>{F(l,"debug"),console.log(`✅ ${l} logging enabled (debug level)`)},disable:l=>{F(l,"silent"),console.log(`❌ ${l} logging disabled`)},enableAll:()=>{Object.keys($).forEach(l=>{F(l,"debug")}),console.log("✅ All feature logging enabled")},disableAll:()=>{Object.keys($).forEach(l=>{F(l,"error")}),console.log("❌ All feature logging disabled (error only)")}};typeof window<"u"&&J()&&(window.__backlogLoggerControl__=Ce),be();class w{static async getSettings(){try{const t=(await chrome.storage.sync.get(this.SETTINGS_KEY))[this.SETTINGS_KEY];return t?this.mergeWithDefaults(t):P}catch(e){return o.storage.error("Failed to get settings:",e),P}}static async saveSettings(e){try{await chrome.storage.sync.set({[this.SETTINGS_KEY]:e})}catch(t){throw o.storage.error("Failed to save settings:",t),t}}static onSettingsChanged(e){chrome.storage.onChanged.addListener((t,n)=>{if(n==="sync"&&t[this.SETTINGS_KEY]){const s=t[this.SETTINGS_KEY].newValue;s&&e(this.mergeWithDefaults(s))}})}static mergeWithDefaults(e){return{boardAccordion:{...P.boardAccordion,...e.boardAccordion},shortcutKeys:{...P.shortcutKeys,...e.shortcutKeys},issuePending:{...P.issuePending,...e.issuePending},prFormat:{...P.prFormat,...e.prFormat},commentUrlCopy:{...P.commentUrlCopy,...e.commentUrlCopy}}}}h(w,"SETTINGS_KEY","backlog_usability_enhance_settings");class q{static async get(e){try{return!chrome.storage||!chrome.storage.local?(o.storage.warn("Extension context invalidated, skipping storage access"),null):(await chrome.storage.local.get(e))[e]||null}catch(t){return t instanceof Error&&t.message.includes("Extension context invalidated")?(o.storage.warn(`Extension context invalidated for key: ${e}`),null):(o.storage.error(`Failed to get local storage data for key: ${e}`,t),null)}}static async set(e,t){try{if(!chrome.storage||!chrome.storage.local){o.storage.warn("Extension context invalidated, skipping storage save");return}await chrome.storage.local.set({[e]:t})}catch(n){if(n instanceof Error&&n.message.includes("Extension context invalidated")){o.storage.warn(`Extension context invalidated for key: ${e}`);return}throw o.storage.error(`Failed to set local storage data for key: ${e}`,n),n}}static async remove(e){try{await chrome.storage.local.remove(e)}catch(t){throw o.storage.error(`Failed to remove local storage data for key: ${e}`,t),t}}}class se{static async getProjectTemplate(e){try{return(await w.getSettings()).prFormat.projectTemplates[e]||null}catch(t){return o.storage.error("Failed to get project template:",{projectKey:e,error:t}),null}}static async setProjectTemplate(e,t){try{const n=await w.getSettings();n.prFormat.projectTemplates[e]=t,await w.saveSettings(n),o.storage.info("Project template saved:",{projectKey:e})}catch(n){throw o.storage.error("Failed to save project template:",{projectKey:e,error:n}),n}}static async removeProjectTemplate(e){try{const t=await w.getSettings();delete t.prFormat.projectTemplates[e],await w.saveSettings(t),o.storage.info("Project template removed:",{projectKey:e})}catch(t){throw o.storage.error("Failed to remove project template:",{projectKey:e,error:t}),t}}static async getAllProjectTemplates(){try{return(await w.getSettings()).prFormat.projectTemplates}catch(e){return o.storage.error("Failed to get all project templates:",e),{}}}static async isEnabled(){try{return(await w.getSettings()).prFormat.enabled}catch(e){return o.storage.error("Failed to get PR format enabled status:",e),!1}}static async setEnabled(e){try{const t=await w.getSettings();t.prFormat.enabled=e,await w.saveSettings(t),o.storage.info("PR format enabled status updated:",{enabled:e})}catch(t){throw o.storage.error("Failed to update PR format enabled status:",{enabled:e,error:t}),t}}}const N={COLLAPSE_BUTTON:"collapse-button",BUE_BUTTON:"bue-button",BUE_BUTTON_MINIMAL:"bue-button--minimal",BUE_BUTTON_XS:"bue-button--xs"},x={COLUMN:".css-hrpltn-col",SLOT_BOX:".css-15rua0m-box.SlotBox",STATUS_ICON:".StatusIcon"};class Te{constructor(){h(this,"observer",null);h(this,"keyboardHandler");h(this,"debounceTimeout",null);h(this,"abortController",new AbortController);h(this,"config",{COLLAPSED_WIDTH:"72px",BUTTON_DELAY:500,INIT_DELAY:1e3});this.keyboardHandler=this.handleKeyboardShortcuts.bind(this)}init(){o.boardAccordion.info("Initializing"),T.getPageInfo().type==="board"&&(setTimeout(()=>{this.addCollapseButtons(),this.setupKeyboardShortcuts()},this.config.INIT_DELAY),this.observeChanges())}destroy(){o.boardAccordion.info("Destroying"),this.observer&&(this.observer.disconnect(),this.observer=null),this.debounceTimeout&&(clearTimeout(this.debounceTimeout),this.debounceTimeout=null),this.abortController.abort(),this.abortController=new AbortController,document.removeEventListener("keydown",this.keyboardHandler),this.removeCollapseButtons()}addCollapseButtons(){const t=document.querySelectorAll('.css-hrpltn-col, [data-testid="board-column"], .board-column, [class*="column"], .lane');if(t.length>0&&o.boardAccordion.debug(`Found ${t.length} columns using optimized selector`),t.length===0){o.boardAccordion.warn("No status columns found");return}o.boardAccordion.info(`Found ${t.length} status columns`);const n=[];t.forEach((s,r)=>{const i=s.querySelector('.css-ujzck4-row, [class*="header"], [class*="title"], h1, h2, h3, h4, h5, h6');if(!i||i.querySelector(`.${N.COLLAPSE_BUTTON}`))return;const a=this.createCollapseButton();n.push({column:s,button:a,index:r});const c=i.querySelector('h3.SlotHead, h3, h2, h1, [class*="title"], [class*="header"]');if(c){c.appendChild(a);const u=s.querySelector(x.SLOT_BOX);u&&this.setupHeaderClickExpand(u,s,a,r),this.restoreColumnState(s,a)}else{i.appendChild(a);const u=s.querySelector(x.SLOT_BOX);u?this.setupHeaderClickExpand(u,s,a,r):this.setupHeaderClickExpand(i,s,a,r),this.restoreColumnState(s,a)}}),requestAnimationFrame(()=>{n.forEach(({column:s,button:r,index:i})=>{this.setupButtonInteractions(s,r,i)})})}createCollapseButton(){const e=document.createElement("button");return e.className=`${N.BUE_BUTTON} ${N.BUE_BUTTON_MINIMAL} ${N.BUE_BUTTON_XS} ${N.COLLAPSE_BUTTON}`,e.textContent="▼",e.title="ステータス列を折りたたむ",e.setAttribute("aria-label","ステータス列を折りたたむ"),e.setAttribute("aria-expanded","true"),e.setAttribute("type","button"),e.style.cssText=`
      margin-left: var(--spacing-sm, 4px);
      align-self: center;
      font-size: 12px;
    `,e}setupButtonInteractions(e,t,n){const s=new AbortController;t.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),this.toggleColumn(e,t,n)},{signal:s.signal}),t.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),r.stopPropagation(),this.toggleColumn(e,t,n))},{signal:s.signal}),t.__abortController=s}setupHeaderClickExpand(e,t,n,s){e.dataset.expandClickSetup!=="true"&&(e.addEventListener("click",r=>{const i=r.target;if(i.classList.contains(N.COLLAPSE_BUTTON)||i.tagName==="A"||i.tagName==="BUTTON"||i.tagName==="SVG"||i.tagName==="USE"||i.closest("a")||i.closest(`button:not(.${N.COLLAPSE_BUTTON})`)||i.closest("svg"))return;const a=this.getColumnElements(t);a.issueList&&a.issueList.style.display==="none"&&(r.preventDefault(),r.stopPropagation(),this.toggleColumn(t,n,s))}),e.addEventListener("mouseenter",()=>{const r=this.getColumnElements(t);if(r.issueList&&r.issueList.style.display==="none"){e.style.cursor="pointer";const i=e.querySelector(x.STATUS_ICON);i&&(i.style.cursor="pointer")}}),e.addEventListener("mouseleave",()=>{const r=this.getColumnElements(t);r.issueList&&r.issueList.style.display,e.style.cursor=""}),e.dataset.expandClickSetup="true")}toggleColumn(e,t,n){const s=this.getColumnElements(e);if(!s.issueList)return;const r=s.issueList.style.display==="none",i=this.getStatusName(e)||`column_${n}`;o.boardAccordion.debug(`Toggling column '${i}', isCollapsed: ${r}`),r?this.expandColumn(e,t,s):this.collapseColumn(e,t,s),this.saveColumnState(e,!r)}getColumnElements(e){const t=n=>{for(const s of n){const r=e.querySelector(s);if(r)return r}return null};return{issueList:t(["ul.SlotBox",'[class*="issue-list"]','[class*="card-list"]',"ul, ol",'[class*="list"]']),statusName:t(["h3.SlotHead > div:nth-child(2)",'[class*="status-name"]','[class*="column-title"]',"h1, h2, h3, h4, h5, h6"]),expandArea:t(["h3.SlotHead > div:nth-child(3)",'[class*="expand"]','[class*="action"]']),addIssueButton:t([".css-oslcxi-row",'[class*="add-issue"]','[class*="add-button"]','button[class*="add"]']),descriptionArea:t([".css-1vsmiu0-box",'[class*="description"]','[class*="summary"]'])}}expandColumn(e,t,n){var r,i,a,c,u;(r=n.issueList)!=null&&r.style&&(n.issueList.style.display=""),(i=n.statusName)!=null&&i.style&&(n.statusName.style.display=""),(a=n.expandArea)!=null&&a.style&&(n.expandArea.style.display=""),(c=n.addIssueButton)!=null&&c.style&&(n.addIssueButton.style.display=""),(u=n.descriptionArea)!=null&&u.style&&(n.descriptionArea.style.display=""),t.textContent="▼",t.title="ステータス列を折りたたむ",t.setAttribute("aria-label","ステータス列を折りたたむ"),t.setAttribute("aria-expanded","true"),e.style.width="",e.style.minWidth="",e.style.maxWidth="",e.style.paddingRight="";const s=e.firstElementChild;s&&(s.style.height=""),this.removeIconTooltip(e),this.refreshPendingStatesInColumn()}collapseColumn(e,t,n){var r,i,a,c,u;(r=n.issueList)!=null&&r.style&&(n.issueList.style.display="none"),(i=n.statusName)!=null&&i.style&&(n.statusName.style.display="none"),(a=n.expandArea)!=null&&a.style&&(n.expandArea.style.display="none"),(c=n.addIssueButton)!=null&&c.style&&(n.addIssueButton.style.display="none"),(u=n.descriptionArea)!=null&&u.style&&(n.descriptionArea.style.display="none"),t.textContent="▶",t.title="ステータス列を展開する",t.setAttribute("aria-label","ステータス列を展開する"),t.setAttribute("aria-expanded","false"),e.style.width=this.config.COLLAPSED_WIDTH,e.style.minWidth=this.config.COLLAPSED_WIDTH,e.style.maxWidth=this.config.COLLAPSED_WIDTH,e.matches(".css-hrpltn-col:last-of-type")&&(e.style.paddingRight="0");const s=e.firstElementChild;s&&(s.style.height="100%"),this.addIconTooltip(e,n)}addIconTooltip(e,t){var s;const n=e.querySelector(x.STATUS_ICON);if(n&&t.statusName){const r=((s=t.statusName.textContent)==null?void 0:s.trim())||"";n.title=r,n.style.cursor="pointer"}}removeIconTooltip(e){const t=e.querySelector(x.STATUS_ICON);t&&(t.title="",t.style.cursor="")}getStatusName(e){var r,i;const t=this.getColumnElements(e);if(t.statusName){const a=(r=t.statusName.textContent)==null?void 0:r.trim();if(a)return a}const n=e.dataset.statusName;return n||`column_${Array.from(((i=e.parentElement)==null?void 0:i.children)||[]).indexOf(e)}`}async saveColumnState(e,t){const n=this.getStatusName(e);if(!n){o.boardAccordion.warn("Cannot save state - status name not found");return}const r=`backlog_column_${T.getPageInfo().projectKey||"unknown"}_${n}`;try{await q.set(r,t),o.boardAccordion.debug(`Saved column '${n}' state: ${t}`)}catch(i){o.boardAccordion.error("Failed to save column state:",i)}}async restoreColumnState(e,t){const n=this.getStatusName(e);if(!n){o.boardAccordion.warn("Cannot restore state - status name not found");return}const r=`backlog_column_${T.getPageInfo().projectKey||"unknown"}_${n}`;try{if(await q.get(r)){const a=this.getColumnElements(e);this.collapseColumn(e,t,a),o.boardAccordion.debug(`Restored column '${n}' as collapsed`)}}catch(i){o.boardAccordion.error("Failed to restore column state:",i)}}observeChanges(){this.observer=T.observeChanges(e=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=window.setTimeout(()=>{e.some(n=>n.type==="childList"&&n.addedNodes.length>0&&Array.from(n.addedNodes).some(s=>s.nodeType===Node.ELEMENT_NODE&&s.matches('.css-hrpltn-col, [data-testid="board-column"], .board-column')))&&T.getPageInfo().type==="board"&&this.addCollapseButtons()},this.config.BUTTON_DELAY)})}setupKeyboardShortcuts(){document.addEventListener("keydown",this.keyboardHandler,{signal:this.abortController.signal})}refreshPendingStatesInColumn(){var e,t;try{const n=window.__backlog_usability_enhance__;if(!n){o.boardAccordion.debug("Global instance not available for pending state refresh");return}const s=(e=n.getFeature)==null?void 0:e.call(n,"issuePending");if(!((t=s==null?void 0:s._instance)!=null&&t.refreshAllVisibleCards)){o.boardAccordion.debug("IssuePending feature not available or method not found");return}setTimeout(()=>{var r,i;(i=(r=s._instance)==null?void 0:r.refreshAllVisibleCards)==null||i.call(r).catch(a=>{o.boardAccordion.error("Failed to refresh pending states in column:",a)}),o.boardAccordion.debug("Refreshed pending states in expanded column")},50)}catch(n){o.boardAccordion.error("Error while refreshing pending states:",n)}}handleKeyboardShortcuts(e){const t=document.activeElement;t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)||(e.ctrlKey&&e.shiftKey&&e.key==="E"&&(e.preventDefault(),this.expandAllColumns(),o.boardAccordion.info("Expand all columns via shortcut")),e.ctrlKey&&e.shiftKey&&e.key==="C"&&(e.preventDefault(),this.collapseAllColumns(),o.boardAccordion.info("Collapse all columns via shortcut")))}expandAllColumns(){document.querySelectorAll(x.COLUMN).forEach((t,n)=>{const s=t.querySelector(`.${N.COLLAPSE_BUTTON}`);s&&s.textContent==="▶"&&this.toggleColumn(t,s,n)}),this.refreshAllPendingStates()}refreshAllPendingStates(){var e,t;try{const n=window.__backlog_usability_enhance__;if(!n){o.boardAccordion.debug("Global instance not available for pending state refresh");return}const s=(e=n.getFeature)==null?void 0:e.call(n,"issuePending");if(!((t=s==null?void 0:s._instance)!=null&&t.refreshAllVisibleCards)){o.boardAccordion.debug("IssuePending feature not available or method not found");return}setTimeout(()=>{var r,i;(i=(r=s._instance)==null?void 0:r.refreshAllVisibleCards)==null||i.call(r).catch(a=>{o.boardAccordion.error("Failed to refresh all pending states:",a)}),o.boardAccordion.debug("Refreshed all pending states after column operations")},100)}catch(n){o.boardAccordion.error("Error while refreshing all pending states:",n)}}collapseAllColumns(){document.querySelectorAll(x.COLUMN).forEach((t,n)=>{const s=t.querySelector(`.${N.COLLAPSE_BUTTON}`);s&&s.textContent==="▼"&&this.toggleColumn(t,s,n)})}removeCollapseButtons(){document.querySelectorAll(`.${N.COLLAPSE_BUTTON}`).forEach(t=>{var r;const n=t.__abortController;n&&n.abort();const s=(r=t.closest(x.COLUMN))==null?void 0:r.querySelector('[data-expand-click-setup="true"]');s&&(s.removeAttribute("data-expand-click-setup"),s.style.cursor=""),t.remove()})}}const U={PROJECT_NAV_LIST:"#projectNavList",PROJECT_NAV_LIST_ALT:".project-nav-list",PROJECT_NAV_ITEM:".project-nav-list__item",PROJECT_NAV_TEXT:".project-nav-list__text span"},j=class j{constructor(){h(this,"observer",null);h(this,"originalLabels",new Map);h(this,"isUpdating",!1);o.shortcutKeys.debug("constructor()")}init(){try{const e=this.findProjectNavList();if(!e){o.shortcutKeys.debug("Project navigation list not found, retrying..."),setTimeout(()=>{this.retryInitialization()},300);return}this.integrateShortcutKeys(e),this.observeNavigationChanges(e),setTimeout(()=>{this.integrateShortcutKeys(e)},100),o.shortcutKeys.info("Feature initialized")}catch(e){o.shortcutKeys.error("Failed to initialize:",e)}}retryInitialization(){const e=this.findProjectNavList();e?(o.shortcutKeys.debug("Project navigation found on retry, initializing..."),this.integrateShortcutKeys(e),this.observeNavigationChanges(e)):o.shortcutKeys.warn("Project navigation still not found after retry")}destroy(){o.shortcutKeys.debug("destroy()");try{this.observer&&(this.observer.disconnect(),this.observer=null),this.restoreOriginalLabels(),o.shortcutKeys.info("Feature destroyed")}catch(e){o.shortcutKeys.error("Failed to destroy:",e)}}findProjectNavList(){const e=[U.PROJECT_NAV_LIST,U.PROJECT_NAV_LIST_ALT,'[role="navigation"][aria-label*="プロジェクト"]'];for(const t of e){const n=document.querySelector(t);if(n)return n}return null}integrateShortcutKeys(e){var t;if(!this.isUpdating){this.isUpdating=!0;try{this.restoreOriginalLabels();const n=e.querySelectorAll(`${U.PROJECT_NAV_ITEM} a, ${U.PROJECT_NAV_ITEM} span`);for(const s of n){const r=s,i=r.id;o.shortcutKeys.debug(`Processing nav item: id="${i}", href="${r.getAttribute("href")}", text="${(t=r.textContent)==null?void 0:t.trim()}"`);let a=j.SHORTCUT_MAPPINGS.find(c=>c.elementId===i);if(i==="navi-file"){const c=r.getAttribute("href");c&&c.includes("/git/")&&(a=j.SHORTCUT_MAPPINGS.find(u=>u.elementId==="navi-git"),o.shortcutKeys.debug("Detected Git menu with navi-file ID, using Git mapping"))}a&&this.integrateShortcutKeyToLabel(r,a)}}finally{setTimeout(()=>{this.isUpdating=!1},200)}}}integrateShortcutKeyToLabel(e,t){try{const n=e.querySelector(U.PROJECT_NAV_TEXT);if(!n||!n.textContent)return;const s=this.getUniqueElementKey(e,t);this.originalLabels.has(s)||this.originalLabels.set(s,n.textContent);const r=this.originalLabels.get(s)||n.textContent;if(r.includes(`(${t.key.toUpperCase()})`))return;const i=`${r} (${t.key.toUpperCase()})`;n.textContent=i,e.title=i;const a=e.getAttribute("data-tooltip");if(a&&!a.includes(`(${t.key.toUpperCase()})`)){e.hasAttribute("data-original-tooltip")||e.setAttribute("data-original-tooltip",a);const c=`${a} (${t.key.toUpperCase()})`;e.setAttribute("data-tooltip",c),o.shortcutKeys.debug(`Updated data-tooltip: ${a} -> ${c}`)}o.shortcutKeys.debug(`Integrated shortcut key '${t.key}' into label: ${r} -> ${i}`)}catch(n){o.shortcutKeys.error(`Failed to integrate shortcut key to ${t.elementId}:`,n)}}getUniqueElementKey(e,t){const n=e.getAttribute("href");return e.id==="navi-file"&&n&&n.includes("/git/")?"navi-git":t.elementId}restoreOriginalLabels(){for(const[e,t]of this.originalLabels)try{let n=null;if(e==="navi-git"){const s=document.querySelectorAll("#navi-file");for(const r of s){const i=r.getAttribute("href");if(i&&i.includes("/git/")){n=r;break}}}else n=document.getElementById(e);if(n){const s=n.querySelector(U.PROJECT_NAV_TEXT);if(s){s.textContent=t,n.title=n.getAttribute("data-tooltip")||"";const r=n.getAttribute("data-original-tooltip");r&&(n.setAttribute("data-tooltip",r),n.removeAttribute("data-original-tooltip"),o.shortcutKeys.debug(`Restored data-tooltip to: ${r}`))}}}catch(n){o.shortcutKeys.error(`Failed to restore label for ${e}:`,n)}this.originalLabels.clear()}observeNavigationChanges(e){this.observer=new MutationObserver(t=>{if(this.isUpdating)return;let n=!1;for(const s of t)if(s.type==="childList"&&s.addedNodes.length>0){for(const r of s.addedNodes)if(r.nodeType===Node.ELEMENT_NODE){const i=r,a=U.PROJECT_NAV_ITEM.slice(1);if(i.classList.contains(a)||i.querySelector(U.PROJECT_NAV_ITEM)){n=!0;break}}if(n)break}n&&setTimeout(()=>{this.integrateShortcutKeys(e)},100)}),this.observer.observe(e,{childList:!0,subtree:!0})}};h(j,"SHORTCUT_MAPPINGS",[{key:"h",description:"ホーム",elementId:"navi-home"},{key:"a",description:"課題の追加",elementId:"navi-add"},{key:"f",description:"課題",elementId:"navi-find"},{key:"r",description:"ボード",elementId:"navi-board"},{key:"g",description:"ガントチャート",elementId:"navi-gantt"},{key:"w",description:"Wiki",elementId:"navi-wiki"},{key:"s",description:"ファイル",elementId:"navi-file"},{key:"v",description:"Subversion",elementId:"navi-subversion"},{key:"t",description:"Git",elementId:"navi-git"}]);let X=j;class B{static getStorageKey(e){return`${this.STORAGE_KEY_PREFIX}${e}`}static async getPendingIssues(e){if(!this.validateProjectKey(e))return o.storage.warn(`Invalid project key: ${e}`),[];try{const t=this.getStorageKey(e),n=await q.get(t);return!n||!Array.isArray(n)?[]:n}catch(t){return o.storage.error(`Failed to get pending issues for project ${e}:`,t),[]}}static async savePendingIssues(e,t){if(!this.validateProjectKey(e))throw new Error(`Invalid project key: ${e}`);const n=t.filter(s=>this.validatePendingIssue(s));n.length!==t.length&&o.storage.warn(`Filtered invalid issues: ${t.length-n.length} removed`);try{const s=this.getStorageKey(e);await q.set(s,n)}catch(s){throw o.storage.error(`Failed to save pending issues for project ${e}:`,s),s}}static async setPendingIssue(e,t){if(!this.validatePendingIssue(t))throw new Error(`Invalid pending issue data: ${JSON.stringify(t)}`);try{const s=(await this.getPendingIssues(e)).filter(r=>r.issueKey!==t.issueKey);s.push(t),await this.savePendingIssues(e,s)}catch(n){throw o.storage.error(`Failed to set pending issue ${t.issueKey}:`,n),n}}static async removePendingIssue(e,t){if(!this.validateIssueKey(t))throw new Error(`Invalid issue key: ${t}`);try{const s=(await this.getPendingIssues(e)).filter(r=>r.issueKey!==t);await this.savePendingIssues(e,s)}catch(n){throw o.storage.error(`Failed to remove pending issue ${t}:`,n),n}}static async isPendingIssue(e,t){return(await this.getPendingIssues(e)).some(s=>s.issueKey===t)}static async clearPendingIssues(e){if(!this.validateProjectKey(e))throw new Error(`Invalid project key: ${e}`);try{const t=this.getStorageKey(e);await q.remove(t)}catch(t){throw o.storage.error(`Failed to clear pending issues for project ${e}:`,t),t}}static validateProjectKey(e){return typeof e=="string"&&e.length>0&&/^[A-Z0-9_]+$/.test(e)}static validateIssueKey(e){return typeof e=="string"&&/^[A-Z0-9_]+-\d+$/.test(e)}static validatePendingIssue(e){return e&&typeof e=="object"&&this.validateIssueKey(e.issueKey)&&this.validateProjectKey(e.projectKey)}static async getAllPendingData(){return o.storage.warn("getAllPendingData is for debugging purposes only"),{}}}h(B,"STORAGE_KEY_PREFIX","backlog_pending_issues_");const ve=["li.css-1og413z-box.card",".css-1og413z-box.card","li.card",".card:not(.card-label):not(.card-summary):not(.card-status)",".IssueCard","[data-issue-key]"],Se=[".card-label",'a[href*="/view/"]',"[data-issue-key]",".IssueKey"],b={className:"pending-toggle-button",activeClassName:"pending-toggle-button--active",icon:{pending:`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="4" y="4" width="2.25" height="8" fill="currentColor" rx="0.5"/>
      <rect x="9" y="4" width="2.25" height="8" fill="currentColor" rx="0.5"/>
    </svg>`,normal:`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="padding-left: 2px;">
      <path d="M4 3L12 8L4 13V3Z" fill="currentColor"/>
    </svg>`},tooltip:{pending:"Pending状態を解除",normal:"課題をPending状態にする"}},z={pending:"issue-card--pending",normal:"issue-card--normal"},k={className:"pending-card-tooltip",delay:200,width:250};class A{static findIssueCards(e=document.body){const t=[];for(const n of ve){e.matches&&e.matches(n)&&(o.issuePending.debug(`[PendingDom] Container itself matches selector: ${n}`),t.includes(e)||(o.issuePending.debug(`[PendingDom] Container element classes: ${e.className}`),t.push(e)));const s=e.querySelectorAll(n);if(s.length>0){o.issuePending.debug(`[PendingDom] Found ${s.length} child elements with selector: ${n}`);for(const r of s)t.includes(r)||(o.issuePending.debug(`[PendingDom] Child element classes: ${r.className}`),t.push(r))}}return o.issuePending.debug(`[PendingDom] Total ${t.length} unique cards found`),t}static extractIssueKey(e){var i;const t=e.getAttribute("data-issue-key");if(t&&this.validateIssueKey(t))return t;const n=e.querySelector(".card-label");if(n&&n.href){const a=n.href.match(/\/view\/([A-Z0-9_]+-\d+)/);if(a&&a[1])return a[1]}if(n&&n.textContent){const a=n.textContent.trim();if(this.validateIssueKey(a))return a}for(const a of Se){const c=e.querySelector(a);if(c){const u=c.getAttribute("href");if(u){const f=u.match(/\/view\/([A-Z0-9_]+-\d+)/);if(f&&f[1])return f[1]}const g=(i=c.textContent)==null?void 0:i.trim();if(g&&this.validateIssueKey(g))return g}}const r=(e.textContent||"").match(/\b([A-Z0-9_]+-\d+)\b/);return r&&r[1]?r[1]:null}static createPendingButton(e=!1){const t=document.createElement("button");return t.className=`bue-button bue-button--icon bue-button--ghost ${b.className}`,e&&t.classList.add(b.activeClassName),t.innerHTML=e?b.icon.pending:b.icon.normal,t.title=e?b.tooltip.pending:b.tooltip.normal,t.setAttribute("aria-label",e?b.tooltip.pending:b.tooltip.normal),t.setAttribute("aria-pressed",e.toString()),t.setAttribute("type","button"),this.applyButtonStyles(t),e&&this.updatePendingButton(t,!0),t}static applyButtonStyles(e){const t={position:"absolute",top:"8px",right:"40px",width:"22px",height:"22px",borderRadius:"11px",fontSize:"0",pointerEvents:"auto",boxShadow:"var(--shadow-sm, 0 2px 4px rgba(0, 0, 0, 0.1))",borderColor:"var(--text-secondary)",color:"var(--text-secondary, #666)"};Object.assign(e.style,t),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),n.stopPropagation(),e.click())})}static applyPendingVisual(e,t){var n;if(t){e.classList.add(z.pending),e.classList.remove(z.normal),e.style.borderLeft="4px solid var(--borderColorWeak, #9e8012)",e.style.backgroundColor="var(--backgroundColorWeak, rgba(76, 71, 54, 0.6))",e.style.boxShadow="0 0 0 1px rgba(158, 128, 18, 0.3), var(--shadowModuleSmall, 0 2px 6px 0 rgba(0, 0, 0, 0.8))";const s=e.querySelector(".card-summary");if(s){s.style.display="none";const a=(n=s.textContent)==null?void 0:n.trim();a&&this.setupCustomTooltip(e,a)}const r=e.querySelector(".card-status");r&&(r.style.display="none");const i=document.createElement("style");i.textContent=`
        .issue-card--pending [data-tooltip]:before,
        .issue-card--pending [data-tooltip]:after,
        .issue-card--pending .simptip-position-top:before,
        .issue-card--pending .simptip-position-top:after {
          background-color: var(--backgroundColorSchemeBase, #333333) !important;
          color: var(--textColorDefault, #dadada) !important;
          opacity: 0.95 !important;
        }
        .issue-card--pending .calendar__ttip {
          background-color: var(--backgroundColorSchemeBase, #333333) !important;
          color: var(--textColorDefault, #dadada) !important;
          opacity: 0.95 !important;
        }
      `,document.querySelector("#pending-tooltip-fix")||(i.id="pending-tooltip-fix",document.head.appendChild(i))}else{e.classList.remove(z.pending),e.classList.add(z.normal),e.style.borderLeft="",e.style.backgroundColor="",e.style.boxShadow="";const s=e.querySelector(".card-summary");s&&(s.style.display="");const r=e.querySelector(".card-status");r&&(r.style.display=""),this.cleanupCustomTooltip(e)}}static addPendingButton(e,t,n){if(!e||typeof n!="function")return null;const s=e.querySelector(`.${b.className}`);if(s)return o.issuePending.debug(`[PendingDom] Button already exists in card: ${e.className}`),s;o.issuePending.debug(`[PendingDom] Checking direct parent for existing button: ${e.className}`);const r=e.parentElement;if(r){const a=r.querySelectorAll(`.${b.className}`);for(const c of a)if(c.closest("li.css-1og413z-box.card, .css-1og413z-box.card")===e)return o.issuePending.debug("[PendingDom] Button already exists in same card - ABORTING"),null}o.issuePending.debug(`[PendingDom] Direct parent check passed for card: ${e.className}`),getComputedStyle(e).position==="static"&&(e.style.position="relative");const i=this.createPendingButton(t);return i.addEventListener("click",a=>{o.issuePending.debug(`[PendingDom] Button clicked for card: ${e.className}`),a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),setTimeout(()=>{try{n(),o.issuePending.debug("[PendingDom] Button onClick executed successfully")}catch(c){o.issuePending.error("Error in onClick:",c)}},10)},!0),i.addEventListener("dragstart",a=>(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1)),i.addEventListener("drag",a=>(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1)),e.appendChild(i),o.issuePending.debug(`[PendingDom] Added button to card: ${e.className}`),i}static updatePendingButton(e,t){t?(e.classList.add(b.activeClassName),e.innerHTML=b.icon.pending,e.title=b.tooltip.pending,e.setAttribute("aria-label",b.tooltip.pending),e.setAttribute("aria-pressed","true"),e.style.backgroundColor="var(--bg-warning-element, #ffc10714)",e.style.borderColor="var(--warning-color, #ffc107)",e.style.color="var(--warning-color, #fff)"):(e.classList.remove(b.activeClassName),e.innerHTML=b.icon.normal,e.title=b.tooltip.normal,e.setAttribute("aria-label",b.tooltip.normal),e.setAttribute("aria-pressed","false"),e.style.backgroundColor="transparent",e.style.borderColor="var(--text-secondary, #e9ecef)",e.style.color="var(--text-secondary, #666)")}static removePendingButton(e){const t=e.querySelector(`.${b.className}`);t&&t.remove()}static validateIssueKey(e){return!e||typeof e!="string"||e.length>100||/<|>|&|'|"|\n|\r|\t|javascript:|data:/.test(e)?!1:/^[A-Z0-9_]+-\d+$/.test(e)}static getMutationObserverConfig(){return{childList:!0,subtree:!0,attributes:!1,characterData:!1}}static isCompletedOrPostCompletionStatus(e){var t;try{const n=[".css-hrpltn-col",'[data-testid="board-column"]',".board-column",'[class*="column"]',".lane"];let s=null;for(const f of n)if(s=e.closest(f),s)break;if(!s)return o.issuePending.debug("Card not in a valid column (tried all selectors)"),!1;if(s.getAttribute("data-statusid")==="4")return!0;const i=["h3.SlotHead",".status-name",'[class*="status"]',"h1, h2, h3, h4, h5, h6",'[class*="title"]','[class*="header"]'];let a=null;for(const f of i)if(a=s.querySelector(f),a)break;const c=((t=a==null?void 0:a.textContent)==null?void 0:t.trim())||"";return["完了","Done","Completed","Complete","Closed"].some(f=>c.includes(f))}catch(n){return o.issuePending.error("Error in isCompletedOrPostCompletionStatus:",n),!1}}static findNewIssueCards(e,t){const n=[];for(const s of e)if(s.type==="childList"){for(const r of s.addedNodes)if(r.nodeType===Node.ELEMENT_NODE){const i=r;o.issuePending.debug(`[PendingDom] findNewIssueCards() check new item: ${i.className} ${i.tagName}`);const a=this.findIssueCards(i);for(const c of a)t.has(c)||(o.issuePending.debug(`[PendingDom] Found new card: ${c.className}`),n.push(c))}}return n}static createCustomTooltip(e){const t=document.createElement("div");return t.className=k.className,t.textContent=e,Object.assign(t.style,{position:"absolute",zIndex:"10000",background:"var(--backgroundColorSchemeBase, #333333)",color:"var(--textColorDefault, #dadada)",padding:"8px 12px",borderRadius:"4px",fontSize:"13px",lineHeight:"1.4",width:`${k.width}px`,overflowWrap:"break-word",whiteSpace:"normal",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.3)",border:"1px solid var(--borderColorDefault, rgba(78, 78, 78, 0.6))",opacity:"0",transform:"translateY(10px)",transition:"opacity 0.2s ease, transform 0.2s ease",pointerEvents:"none",visibility:"visible",display:"block"}),t}static positionTooltip(e,t){const n=t.getBoundingClientRect(),s=window.innerWidth,r=window.pageYOffset||document.documentElement.scrollTop,i=window.pageXOffset||document.documentElement.scrollLeft,a=k.width,c=50;let u=n.left+i+n.width/2-a/2,g=n.bottom+r+8;u<i+8&&(u=i+8);const f=i+s-8;u+a>f&&(u=f-a,u<i+8&&(u=i+8)),g+c>r+window.innerHeight-8&&(g=n.top+r-c-8),e.style.left=`${u}px`,e.style.top=`${g}px`}static setupCustomTooltip(e,t){let n=null,s=null,r=null;const i=()=>{r&&(clearTimeout(r),r=null),s=setTimeout(()=>{const c=document.querySelector(`.${k.className}`);c&&c.remove(),n=this.createCustomTooltip(t),document.body.appendChild(n),this.positionTooltip(n,e),requestAnimationFrame(()=>{n&&(n.style.opacity="1",n.style.transform="translateY(0)")})},k.delay)},a=()=>{s&&(clearTimeout(s),s=null),n&&(r=setTimeout(()=>{n&&(n.remove(),n=null)},100))};e.addEventListener("mouseenter",i),e.addEventListener("mouseleave",a),e._tooltipCleanup=()=>{s&&clearTimeout(s),r&&clearTimeout(r),n&&n.remove(),e.removeEventListener("mouseenter",i),e.removeEventListener("mouseleave",a)}}static cleanupCustomTooltip(e){const t=e,n=t._tooltipCleanup;n&&(n(),delete t._tooltipCleanup);const s=document.querySelector(`.${k.className}`);s&&s.remove()}}const Z={PENDING_TOGGLE_BUTTON:"pending-toggle-button"},oe={CARD:".css-1og413z-box.card",CARD_FALLBACK:".card"};class Ee{constructor(){h(this,"observer",null);h(this,"pendingStore",new Map);h(this,"issueCardMap",new Map);h(this,"projectKey",null);h(this,"settings",null);o.issuePending.debug("constructor()")}async init(){var e;try{const t=T.getPageInfo();if(t.type!=="board"){o.issuePending.debug("Not a board page, skipping initialization");return}if(this.projectKey=t.projectKey||null,!this.projectKey){o.issuePending.debug("No project key found");return}if(o.issuePending.debug(`Initializing for project ${this.projectKey}`),await this.loadSettings(),!((e=this.settings)!=null&&e.enabled))return;this.setupSettingsWatcher(),await this.loadPendingData(),this.scheduleButtonAddition(),this.observeIssueCards(),o.issuePending.info("Initialization completed")}catch(t){o.issuePending.error("Failed to initialize:",t)}}async loadSettings(){try{const e=await w.getSettings();this.settings=e.issuePending,o.issuePending.debug("Settings loaded:",this.settings)}catch(e){o.issuePending.error("Failed to load settings:",e),this.settings={enabled:!0,autoResolve:!0}}}setupSettingsWatcher(){w.onSettingsChanged(e=>{var n,s;const t=e.issuePending;o.issuePending.debug("Settings changed:",t),!t.enabled&&((n=this.settings)!=null&&n.enabled)&&(o.issuePending.info("Feature disabled, removing buttons"),this.removeAllPendingButtons(),this.disconnect()),t.enabled&&!((s=this.settings)!=null&&s.enabled)&&(o.issuePending.info("Feature enabled, reinitializing"),this.reconnect()),this.settings=t})}destroy(){o.issuePending.debug("destroy()"),this.observer&&(this.observer.disconnect(),this.observer=null),this.pendingStore.clear(),this.issueCardMap.clear(),this.projectKey=null,o.issuePending.info("Destroyed")}removeAllPendingButtons(){document.querySelectorAll(`.${Z.PENDING_TOGGLE_BUTTON}`).forEach(t=>t.remove()),o.issuePending.debug("All pending buttons removed")}disconnect(){this.observer&&(this.observer.disconnect(),this.observer=null),o.issuePending.debug("Observer disconnected")}async reconnect(){try{await this.loadPendingData(),this.scheduleButtonAddition(),this.observeIssueCards(),o.issuePending.info("Reconnected successfully")}catch(e){o.issuePending.error("Failed to reconnect:",e)}}async togglePending(e){if(!(!this.projectKey||!A.validateIssueKey(e)))try{const t=await this.isPending(e);if(t)await B.removePendingIssue(this.projectKey,e),this.pendingStore.delete(e);else{const n={issueKey:e,projectKey:this.projectKey};await B.setPendingIssue(this.projectKey,n),this.pendingStore.set(e,n)}await this.updateCardVisualState(e),o.issuePending.info(`Toggled pending state for ${e}, new state: ${!t}`)}catch(t){o.issuePending.error(`Failed to toggle pending state for ${e}:`,t)}}async removePendingState(e){if(!(!this.projectKey||!A.validateIssueKey(e)))try{await B.removePendingIssue(this.projectKey,e),this.pendingStore.delete(e),await this.updateCardVisualState(e),o.issuePending.debug(`Removed pending state for ${e}`)}catch(t){o.issuePending.error(`Failed to remove pending state for ${e}:`,t)}}async isPending(e){if(!this.projectKey||!A.validateIssueKey(e))return!1;try{return await B.isPendingIssue(this.projectKey,e)}catch(t){return o.issuePending.error(`Failed to check pending status for ${e}:`,t),!1}}getPendingIssues(){return Array.from(this.pendingStore.values())}getProjectKey(){return this.projectKey}async loadPendingData(){if(this.projectKey)try{const e=await B.getPendingIssues(this.projectKey);this.pendingStore.clear();for(const t of e)this.pendingStore.set(t.issueKey,t);o.issuePending.debug(`Loaded ${e.length} pending issues`)}catch(e){o.issuePending.error("Failed to load pending data:",e)}}scheduleButtonAddition(){requestAnimationFrame(async()=>{await this.addPendingButtonsToCards(!0),setTimeout(async()=>{await this.addPendingButtonsToCards(!0)},1e3)})}async addPendingButtonsToCards(e=!1){const t=A.findIssueCards();o.issuePending.debug(`Found ${t.length} cards during initialization`);let n=0;for(const s of t){const r=A.extractIssueKey(s);if(r){const i=this.issueCardMap.has(r),a=s.querySelector(`.${Z.PENDING_TOGGLE_BUTTON}`);o.issuePending.debug(`Processing card ${r}: inMap=${i}, hasButton=${!!a}, forceAdd=${e}`),(e||!i)&&!a?(await this.addPendingButtonToCard(s),n++,o.issuePending.debug(`Successfully added button to ${r}`)):o.issuePending.debug(`Skipped ${r}: inMap=${i}, hasButton=${!!a}`)}else o.issuePending.debug(`Could not extract issue key from card: ${s.className}`)}o.issuePending.info(`Added pending buttons to ${n} new cards (${t.length} total found)`)}async addPendingButtonToCard(e){var r;const t=A.extractIssueKey(e);if(!t){o.issuePending.debug(`Failed to extract issue key from card: ${e.className}`);return}o.issuePending.debug(`Attempting to add button to ${t}`),this.issueCardMap.set(t,e);let n=await this.isPending(t);o.issuePending.debug(`${t} isPending: ${n}`),n&&((r=this.settings)!=null&&r.autoResolve)&&A.isCompletedOrPostCompletionStatus(e)&&(o.issuePending.info(`Auto-resolving pending state for ${t} (completed or post-completion status)`),await this.removePendingState(t),n=!1),A.addPendingButton(e,n,()=>{this.togglePending(t)})?(A.applyPendingVisual(e,n),o.issuePending.debug(`Successfully added pending button to ${t}`)):o.issuePending.warn(`Failed to add button to ${t} - button creation returned null`)}async updateCardVisualState(e){const t=this.issueCardMap.get(e);if(!t)return;const n=await this.isPending(e),s=t.querySelector(`.${Z.PENDING_TOGGLE_BUTTON}`);s&&A.updatePendingButton(s,n),A.applyPendingVisual(t,n)}async refreshCardVisualState(e){const t=A.extractIssueKey(e);if(!t)return;const n=await this.isPending(t);A.applyPendingVisual(e,n),o.issuePending.debug(`Refreshed visual state for ${t}, isPending: ${n}`)}async refreshAllVisibleCards(){const e=document.querySelectorAll(`${oe.CARD}, ${oe.CARD_FALLBACK}`),t=[];e.forEach(n=>{t.push(this.refreshCardVisualState(n))}),await Promise.all(t),o.issuePending.debug(`Refreshed visual state for ${e.length} visible cards`)}observeIssueCards(){this.observer=T.observeChanges(e=>{this.handleMutations(e)})}async handleMutations(e){const t=new Set(this.issueCardMap.values()),n=A.findNewIssueCards(e,t);for(const s of n)await this.addPendingButtonToCard(s);n.length>0&&o.issuePending.debug(`Added buttons to ${n.length} new cards`)}}const re={PROSE_MIRROR:"#description.ProseMirror",HIDDEN_TEXTAREA:"#hidden-description"};class Pe{constructor(){h(this,"observer",null);h(this,"isInitialized",!1);o.content.debug("[PrFormatAutoInsert] Constructor called")}init(){if(this.isInitialized){o.content.warn("[PrFormatAutoInsert] Already initialized");return}if(o.content.info("[PrFormatAutoInsert] Initializing..."),!this.isPullRequestAddPage()){o.content.debug("[PrFormatAutoInsert] Not a pull request add page");return}const e=this.getProjectKey();if(!e){o.content.debug("[PrFormatAutoInsert] Could not extract project key from URL");return}o.content.info(`[PrFormatAutoInsert] Detected project: ${e}`),this.startObserving(e),this.isInitialized=!0}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.isInitialized=!1,o.content.info("[PrFormatAutoInsert] Destroyed")}updateSettings(){o.content.debug("[PrFormatAutoInsert] Settings updated")}isPullRequestAddPage(){const e=window.location.pathname;return/\/git\/[^/]+\/[^/]+\/pullRequests\/add\//.test(e)}getProjectKey(){const t=window.location.pathname.match(/\/git\/([^/]+)\/[^/]+\/pullRequests\/add\//);return t?t[1]:null}startObserving(e){if(this.getDescriptionEditor()){o.content.debug("[PrFormatAutoInsert] Editor already exists, inserting template immediately"),this.insertTemplate(e);return}this.observer=new MutationObserver(()=>{var s;this.getDescriptionEditor()&&(o.content.debug("[PrFormatAutoInsert] Editor detected, inserting template"),(s=this.observer)==null||s.disconnect(),this.insertTemplate(e))}),this.observer.observe(document.body,{childList:!0,subtree:!0}),o.content.debug("[PrFormatAutoInsert] Started observing for editor appearance")}getDescriptionEditor(){const e=document.querySelector(re.PROSE_MIRROR);if(e)return o.content.debug("[PrFormatAutoInsert] Found ProseMirror editor"),e;const t=document.querySelector(re.HIDDEN_TEXTAREA);return t?(o.content.debug("[PrFormatAutoInsert] Found hidden textarea"),t):null}async insertTemplate(e){try{if(!await se.isEnabled()){o.content.debug("[PrFormatAutoInsert] Feature is disabled");return}const n=await se.getProjectTemplate(e);if(!n){o.content.debug(`[PrFormatAutoInsert] No template found for project: ${e}`);return}const s=this.getDescriptionEditor();if(!s){o.content.warn("[PrFormatAutoInsert] Editor not found when trying to insert template");return}if(!this.isEditorEmpty(s)){o.content.debug("[PrFormatAutoInsert] Editor is not empty, skipping template insertion");return}s.classList.contains("ProseMirror")?this.insertToProseMirror(s,n):s.tagName==="TEXTAREA"&&(s.value=n),s.focus(),o.content.info(`[PrFormatAutoInsert] Template inserted for project: ${e}`)}catch(t){o.content.error("[PrFormatAutoInsert] Failed to insert template:",t)}}isEditorEmpty(e){var t;if(e.classList.contains("ProseMirror")){const n=e.querySelector("p");return n?(((t=n.textContent)==null?void 0:t.trim())||"")===""||n.classList.contains("empty-node"):!0}else if(e.tagName==="TEXTAREA")return e.value.trim()==="";return!0}insertToProseMirror(e,t){const n=t.split(`
`);e.innerHTML="",n.forEach(s=>{const r=document.createElement("p");s.trim()===""?r.innerHTML="<br>":r.textContent=s,e.appendChild(r)})}}const C={COPY_BUTTON:"comment-url-copy-btn",INJECTED:"comment-url-copy-injected"},d={CONTAINER:".comment-item",INNER:".comment-item__inner",HEADER:".comment-item__header",ACTIONS:".comment-item__actions",ACTIONS_ALT:".comment-actions",TICKET_ACTIONS:".ticket-comment-actions",ISSUE_ACTIONS:".issue-comment-actions",COMMENT_HEADER:".comment-header",COMMENT_META:".comment-meta",COMMENT_CONTENT:".comment-content",MARKDOWN_BODY:".markdown-body",LOOM:".loom",ITEM_CONTAINER:".comment-item__container",TICKET_COMMENT:".ticket-comment",ISSUE_COMMENT:".issue-comment",COMMENT_LIST:".comment-list",TICKET_COMMENT_LIST:".TicketCommentList",PR_COMMENT_LIST:".pr-comment-list",COMMENT_LIST_MASK:".comment-list__mask",LOADING_CIRCLE:".loading--circle",LOADING:".loading",SPINNER:".spinner",MASK:".mask",OVERLAY:".overlay",DROPDOWN:".dropdown",DROPDOWN_MENU:".dropdown-menu",TOOLTIP:".tooltip",POPUP:".popup",MODAL:".modal"},L={PAGE_SECTION:".page-section-anchor",PAGE_SECTION_LINK:"a.page-section-anchor",COMMENT_ID:'[id^="comment-"]',ANCHOR_CLASS:'[class*="anchor"]',HASH_LINK:'a[href*="#"]',DATA_COMMENT_ID:"[data-comment-id]"},R={STAR:".star-button",QUOTE:".ticket__quote",COPY_URL_ISSUE:"#copyURL",COPY_URL_PR:'a[data-bind*="copyURL.bind"]'},K={PRIMARY:'button[type="submit"][aria-label*="コメントを登録"]',PRIMARY_ALT:'button.button--primary[aria-label*="登録"]',INPUT_SUBMIT:'input[type="submit"][value*="登録"]',GENERAL_SUBMIT:'button[type="submit"]',INPUT_GENERAL:'input[type="submit"]'};class we{detectPageType(){const e=window.location.pathname,t=new URLSearchParams(window.location.search);return e.includes("/view/")&&!e.includes("/git/")?t.has("dialogMode")?"issueModal":"issue":e.includes("/git/")&&e.includes("/pullRequests/")?"pullRequest":"other"}isIssuePage(){return this.detectPageType()==="issue"}isPullRequestPage(){return this.detectPageType()==="pullRequest"}isIssueModalPage(){return this.detectPageType()==="issueModal"}isTargetPage(){const e=this.detectPageType();return e==="issue"||e==="pullRequest"||e==="issueModal"}}class Ae{constructor(){}async handleCopy(e,t,n){try{let s=!1;if(n==="issueModal"?(s=await this.fallbackCopy(t),s&&o.content.debug("Comment URL copied using fallback functionality for modal")):this.triggerExistingCopy(e,n)?(s=!0,o.content.debug("Comment URL copied using existing functionality")):(s=await this.fallbackCopy(t),s&&o.content.debug("Comment URL copied using fallback functionality")),!s)throw new Error("Failed to copy comment URL")}catch(s){o.content.error("Failed to copy comment URL:",s)}}triggerExistingCopy(e,t){try{const n=this.getSelectors(),s=n.EXISTING_COPY_BUTTON[t],r=e.querySelector(n.DROPDOWN_MENU);if(!r)return!1;const i=r.querySelector(s);return i?(i.click(),!0):!1}catch(n){return o.content.warn("Failed to trigger existing copy functionality:",n),!1}}async fallbackCopy(e){try{const t=this.generateCommentUrl(e);if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(t),!0;const n=document.createElement("textarea");n.value=t,n.style.cssText="position: fixed; left: -9999px; opacity: 0;",document.body.appendChild(n),n.select(),n.setSelectionRange(0,99999);const s=document.execCommand("copy");return document.body.removeChild(n),s}catch(t){return o.content.error("Fallback copy failed:",t),!1}}generateCommentUrl(e){const t=new URL(location.href);return t.searchParams.has("dialogMode")?(t.searchParams.delete("dialogMode"),`${t.origin}${t.pathname}${t.search}#${e}`):`${location.origin}${location.pathname}#${e}`}getSelectors(){return{COMMENT_CONTAINER:d.CONTAINER,COMMENT_HEADER:d.HEADER,ACTIONS_CONTAINER:d.ACTIONS,ANCHOR_ELEMENT:{issue:L.PAGE_SECTION,pullRequest:L.PAGE_SECTION_LINK},DROPDOWN_MENU:d.DROPDOWN,EXISTING_COPY_BUTTON:{issue:R.COPY_URL_ISSUE,pullRequest:R.COPY_URL_PR},STAR_BUTTON:R.STAR,QUOTE_BUTTON:R.QUOTE}}}class Ie{createButton(e,t){return this.createButtonElement(e)}injectButton(e,t,n){try{if(e.classList.contains(C.INJECTED))return o.content.debug("Button already injected for this comment element"),!0;if(e.querySelector(`.${C.COPY_BUTTON}`))return o.content.debug("Button already exists for this comment element"),e.classList.add(C.INJECTED),!0;o.content.debug("Attempting to inject button into:",e.outerHTML.substring(0,200));const r=[d.ACTIONS,d.ACTIONS_ALT,d.TICKET_ACTIONS,d.ISSUE_ACTIONS,'[class*="action"]',d.COMMENT_HEADER,d.COMMENT_META];let i=null;for(const c of r)if(i=e.querySelector(c),i){o.content.debug(`Found actions container with selector: ${c}`);break}if(!i)return o.content.debug("No actions container found, appending to comment element"),e.appendChild(t),e.classList.add(C.INJECTED),!0;const a=this.findInsertionPoint(i,n);return a?a.position==="before"?a.element.insertAdjacentElement("beforebegin",t):a.element.insertAdjacentElement("afterend",t):i.appendChild(t),e.classList.add(C.INJECTED),!0}catch(s){return o.content.error("Failed to inject button:",s),!1}}findInsertionPoint(e,t){const n=this.getSelectors(),s=e.querySelector(n.QUOTE_BUTTON);if(s)return{element:s,position:"after"};const r=e.querySelector(n.STAR_BUTTON);if(r)return{element:r,position:"after"};const i=e.querySelector(".dropdown");return i?{element:i,position:"before"}:e.children.length>0?{element:e.children[e.children.length-1],position:"before"}:null}createButtonElement(e){const t=document.createElement("button");return t.type="button",t.className=`icon-button icon-button--default ${C.COPY_BUTTON}`,t.title="URLをコピー",t.setAttribute("aria-label","コメントのURLをコピー"),t.setAttribute("data-comment-id",e),t.innerHTML=`
      <svg role="image" class="icon -medium card-copy-icon"><use xlink:href="/images/svg/sprite.symbol.svg#icon_copy"></use></svg>
      <span class="_assistive-text">URLをコピー</span>
    `,t.style.cssText=`
      transition: all 0.2s ease;
    `,t}getSelectors(){return{COMMENT_CONTAINER:d.CONTAINER,COMMENT_HEADER:d.HEADER,ACTIONS_CONTAINER:d.ACTIONS,ANCHOR_ELEMENT:{issue:L.PAGE_SECTION,pullRequest:L.PAGE_SECTION_LINK},DROPDOWN_MENU:d.DROPDOWN,EXISTING_COPY_BUTTON:{issue:R.COPY_URL_ISSUE,pullRequest:R.COPY_URL_PR},STAR_BUTTON:R.STAR,QUOTE_BUTTON:R.QUOTE}}}class Ne{constructor(e,t,n){h(this,"mutationObserver",null);h(this,"onCommentAdded");h(this,"pageType");h(this,"throttledHandler");this.isCommentElementFn=n,this.onCommentAdded=e,this.pageType=t,this.throttledHandler=this.throttle(this.handleMutations.bind(this),100)}start(){this.mutationObserver&&this.stop();const e={childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"],attributeOldValue:!1,characterData:!1,characterDataOldValue:!1};this.mutationObserver=new MutationObserver(this.throttledHandler);const t=this.getObserverTarget(this.pageType);t?(this.mutationObserver.observe(t,e),o.content.debug("CommentObserver started")):o.content.warn("Observer target not found")}stop(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null,o.content.debug("CommentObserver stopped"))}updatePageType(e){this.pageType=e,this.mutationObserver&&(this.stop(),this.start())}handleMutations(e){var t,n,s,r,i,a,c;try{for(const u of e)if(u.type==="childList")u.addedNodes.forEach(g=>{if(g.nodeType===Node.ELEMENT_NODE){const f=g;if(f.classList.contains(C.COPY_BUTTON)||f.closest(`.${C.COPY_BUTTON}`))return;this.isCommentElementFn(f)&&(o.content.debug("New comment element detected:",f.className),this.onCommentAdded(f,this.pageType)),f.querySelectorAll(`${d.INNER}, ${d.CONTAINER}`).forEach(O=>{this.isCommentElementFn(O)&&(o.content.debug("New comment element found in subtree:",O.className),this.onCommentAdded(O,this.pageType))})}});else if(u.type==="attributes"){const g=u.target;if((t=g.classList)!=null&&t.contains("comment-url-copy-btn")||(n=g.closest)!=null&&n.call(g,".comment-url-copy-btn")||!(((s=g.classList)==null?void 0:s.contains("comment-item__inner"))||((r=g.classList)==null?void 0:r.contains("comment-item"))||((i=g.classList)==null?void 0:i.contains("ticket-comment"))||((a=g.classList)==null?void 0:a.contains("issue-comment")))||(c=g.classList)!=null&&c.contains("comment-url-copy-injected"))return;g.style.display!=="none"&&!g.hidden&&!g.classList.contains("hidden")&&!g.classList.contains("is-hidden")&&(g.querySelector(".comment-content")||g.querySelector(".markdown-body")||g.querySelector(".loom")||g.querySelector(".comment-item__container"))&&(o.content.debug("Comment element became visible (lazy-loaded):",g.className),this.onCommentAdded(g,this.pageType))}}catch(u){o.content.error("Error handling mutations:",u)}}getObserverTarget(e){const t=[d.COMMENT_LIST,d.TICKET_COMMENT_LIST,d.PR_COMMENT_LIST,'[data-bind*="foreach: comments"]',"#content","body"];for(const n of t){const s=document.querySelector(n);if(s)return s}return document.body}throttle(e,t){let n=null,s=[];return r=>{s.push(...r),n&&clearTimeout(n),n=window.setTimeout(()=>{try{e(s)}catch(i){o.content.error("Error in throttled function:",i)}finally{s=[]}},t)}}}class Le{constructor(e){h(this,"pageDetector");h(this,"observer",null);h(this,"buttonInjector");h(this,"copyHandler");h(this,"isEnabled",!1);h(this,"currentPageType","other");h(this,"eventListeners",new Map);h(this,"settings",null);h(this,"submitButtonListener",null);h(this,"keyboardSubmitListener",null);this.pageDetector=new we,this.copyHandler=new Ae,this.buttonInjector=new Ie,e&&(this.isEnabled=e.enabled)}async init(){try{if(o.content.info("CommentUrlCopy: Starting initialization"),await this.loadSettings(),o.content.info(`CommentUrlCopy: Settings loaded, enabled: ${this.isEnabled}`),!this.isEnabled){o.content.debug("CommentUrlCopy feature is disabled");return}if(this.currentPageType=this.pageDetector.detectPageType(),o.content.info(`CommentUrlCopy: Detected page type: ${this.currentPageType}`),o.content.info(`CommentUrlCopy: Current URL: ${window.location.href}`),!this.pageDetector.isTargetPage()){o.content.debug("Not a target page for CommentUrlCopy feature");return}o.content.info("CommentUrlCopy: Initializing on target page"),this.cleanupInvalidButtons(),o.content.debug("CommentUrlCopy: Current DOM structure:",document.body.innerHTML.substring(0,500)),this.processExistingComments(),this.scheduleRetryProcessing(),(this.currentPageType==="issue"||this.currentPageType==="pullRequest"||this.currentPageType==="issueModal")&&(this.observer=new Ne((e,t)=>this.handleNewComment(e,t),this.currentPageType,e=>this.isCommentElement(e)),this.observer.start(),o.content.info("CommentUrlCopy: Observer started"),this.watchCommentSubmitButton(),this.watchCommentKeyboardSubmit()),this.watchPageChanges(),o.content.info("CommentUrlCopy feature initialized successfully")}catch(e){o.content.error("Failed to initialize CommentUrlCopy feature:",e)}}destroy(){o.content.info("Destroying CommentUrlCopy feature"),this.observer&&(this.observer.stop(),this.observer=null),this.removeAllEventListeners(),this.removeSubmitButtonListener(),this.removeKeyboardSubmitListener(),this.removeAllButtons(),this.isEnabled=!1}enable(){this.isEnabled=!0,this.init()}disable(){this.destroy()}async updateSettings(){var e,t;await this.loadSettings(),((e=this.settings)==null?void 0:e.commentUrlCopy.enabled)!==this.isEnabled&&((t=this.settings)!=null&&t.commentUrlCopy.enabled?this.enable():this.disable())}async loadSettings(){var e;this.settings=await w.getSettings(),this.isEnabled=((e=this.settings)==null?void 0:e.commentUrlCopy.enabled)??!0}processExistingComments(){try{const e=[d.CONTAINER,d.INNER,d.TICKET_COMMENT,d.ISSUE_COMMENT];let t=[];for(const n of e){const s=document.querySelectorAll(n);if(s.length>0){o.content.debug(`Found ${s.length} elements with selector: ${n}`),t=Array.from(s).filter(r=>this.isCommentElement(r));break}}o.content.info(`CommentUrlCopy: Page type is ${this.currentPageType}, found ${t.length} valid comment elements`),(this.currentPageType==="issue"||this.currentPageType==="pullRequest"||this.currentPageType==="issueModal")&&t.forEach((n,s)=>{o.content.debug(`Processing comment element ${s}:`,n.className),this.handleNewComment(n,this.currentPageType)}),o.content.debug(`Processed ${t.length} existing comments`)}catch(e){o.content.error("Error processing existing comments:",e)}}handleNewComment(e,t){try{const n=this.extractCommentId(e);if(!n){o.content.warn("Could not extract comment ID");return}if(this.currentPageType==="issue"||this.currentPageType==="pullRequest"||this.currentPageType==="issueModal"){const s=this.buttonInjector.createButton(n,this.currentPageType);if(this.buttonInjector.injectButton(e,s,this.currentPageType)){const r=i=>{i.preventDefault(),i.stopPropagation(),this.copyHandler.handleCopy(e,n,this.currentPageType)};s.addEventListener("click",r),this.eventListeners.set(s,r),o.content.debug(`Button injected for comment: ${n}`)}}}catch(n){o.content.error("Error handling new comment:",n)}}extractCommentId(e){try{if(this.currentPageType!=="issue"&&this.currentPageType!=="pullRequest"&&this.currentPageType!=="issueModal")return null;const t=[L.PAGE_SECTION,L.PAGE_SECTION_LINK,L.COMMENT_ID,L.ANCHOR_CLASS,L.HASH_LINK,L.DATA_COMMENT_ID];for(const i of t){const a=e.querySelector(i);if(a){o.content.debug(`Found anchor with selector: ${i}`);const c=a.id;if(c)return o.content.debug(`Found comment ID from element.id: ${c}`),c;const u=a.getAttribute("data-comment-id");if(u)return o.content.debug(`Found comment ID from data-comment-id: ${u}`),u;const g=a.getAttribute("href");if(g&&g.includes("#")){const f=g.split("#")[1];if(f)return o.content.debug(`Found comment ID from href fragment: ${f}`),f}}}if(e.id)return o.content.debug(`Using comment element ID as fallback: ${e.id}`),e.id;const n=Date.now(),s=Math.random().toString(36).substring(2,11),r=`comment-${n}-${s}`;return o.content.debug(`Generated fallback comment ID: ${r}`),r}catch(t){return o.content.error("Error extracting comment ID:",t),null}}watchPageChanges(){let e=window.location.href;const t=()=>{const n=window.location.href;if(n!==e){e=n;const s=this.pageDetector.detectPageType(),r=s!==this.currentPageType,i=this.isPullRequestTabChange(window.location.href,e);if(r&&(this.currentPageType=s,this.observer&&(this.currentPageType==="issue"||this.currentPageType==="pullRequest"||this.currentPageType==="issueModal")&&this.observer.updatePageType(this.currentPageType)),r||i){o.content.debug(`CommentUrlCopy: Page change detected - pageType: ${r?"changed":"same"}, prTab: ${i?"changed":"same"}`);const a=i&&this.isPullRequestCommentsTab()?200:500;setTimeout(()=>{this.processExistingComments(),i&&this.isPullRequestCommentsTab()&&this.scheduleRetryProcessing()},a)}}};T.observeChanges(t)}isPullRequestTabChange(e,t){if(!this.isPullRequestUrl(e)||!this.isPullRequestUrl(t))return!1;const n=i=>i.replace(/\/(diff|files)(\?.*)?$/,""),s=n(e),r=n(t);if(s===r){const i=e!==s,a=t!==r;return i!==a||i&&a&&e!==t}return!1}isPullRequestUrl(e){try{const t=new URL(e);return t.pathname.includes("/git/")&&t.pathname.includes("/pullRequests/")}catch{return!1}}isPullRequestCommentsTab(){const e=window.location.pathname;return this.isPullRequestUrl(window.location.href)&&!e.endsWith("/diff")&&!e.endsWith("/history")}isCommentElement(e){const n=[d.INNER.slice(1),d.CONTAINER.slice(1),d.TICKET_COMMENT.slice(1),d.ISSUE_COMMENT.slice(1)].some(g=>e.classList.contains(g)),s=e.classList.contains(C.INJECTED),i=[d.COMMENT_LIST.slice(1),d.TICKET_COMMENT_LIST.slice(1),d.PR_COMMENT_LIST.slice(1),d.COMMENT_LIST_MASK.slice(1),d.LOADING_CIRCLE.slice(1),d.LOADING.slice(1),d.SPINNER.slice(1),d.MASK.slice(1),d.OVERLAY.slice(1),d.DROPDOWN.slice(1),d.DROPDOWN_MENU.slice(1),d.TOOLTIP.slice(1),d.POPUP.slice(1),d.MODAL.slice(1)].some(g=>e.classList.contains(g)),a=e.classList.contains(d.ACTIONS.slice(1))||e.classList.contains(d.ACTIONS_ALT.slice(1)),c=e.style.display==="none"||e.hidden||e.classList.contains("hidden")||e.classList.contains("is-hidden"),u=!!(e.querySelector(d.COMMENT_CONTENT)||e.querySelector(d.MARKDOWN_BODY)||e.querySelector(d.LOOM)||e.querySelector(d.ITEM_CONTAINER));return n&&!s&&!i&&!a&&!c&&u}removeAllEventListeners(){this.eventListeners.forEach((e,t)=>{t.removeEventListener("click",e)}),this.eventListeners.clear()}removeAllButtons(){document.querySelectorAll(`.${C.COPY_BUTTON}`).forEach(n=>{n.remove()}),document.querySelectorAll(`.${C.INJECTED}`).forEach(n=>{n.classList.remove(C.INJECTED)})}cleanupInvalidButtons(){try{o.content.debug("Cleaning up invalid buttons...");const e=document.querySelectorAll(`.${C.COPY_BUTTON}`);let t=0;e.forEach(s=>{var i;const r=s.closest(`${d.CONTAINER}, ${d.INNER}, ${d.TICKET_COMMENT}, ${d.ISSUE_COMMENT}`);(!r||!this.isCommentElement(r))&&(o.content.debug("Removing invalid button from:",(i=s.parentElement)==null?void 0:i.className),s.remove(),t++)}),document.querySelectorAll(`.${C.INJECTED}`).forEach(s=>{this.isCommentElement(s)||s.classList.remove(C.INJECTED)}),t>0&&o.content.info(`Cleaned up ${t} invalid buttons`)}catch(e){o.content.error("Error during cleanup:",e)}}scheduleRetryProcessing(){const e=window.location.hash.startsWith("#comment-"),t=e?[500,1e3,2e3,3e3,4e3]:[500,1e3,2e3];let n=0;const s=document.querySelectorAll(`.${C.COPY_BUTTON}`).length;e&&o.content.info(`CommentUrlCopy: Detected comment fragment in URL: ${window.location.hash}, using extended retry schedule`);const r=()=>{if(n>=t.length){o.content.debug("CommentUrlCopy: Max retry attempts reached");return}const i=document.querySelectorAll(`.${C.COPY_BUTTON}`).length;o.content.debug(`CommentUrlCopy: Retry ${n+1} starting, current buttons: ${i}`);const a=document.querySelectorAll(`${d.CONTAINER}, ${d.INNER}, ${d.TICKET_COMMENT}, ${d.ISSUE_COMMENT}`).length;if(o.content.debug(`CommentUrlCopy: Found ${a} potential comment elements`),e){const u=document.querySelector(window.location.hash);o.content.debug(`CommentUrlCopy: Fragment target ${window.location.hash} ${u?"found":"not found"}`)}this.processExistingComments();const c=document.querySelectorAll(`.${C.COPY_BUTTON}`).length;if(o.content.debug(`CommentUrlCopy: Retry ${n+1}, buttons before: ${i}, after: ${c}`),c>s||c>i){o.content.info(`CommentUrlCopy: Successfully processed comments on retry ${n+1}`);return}if(a>0&&c===i){o.content.debug("CommentUrlCopy: Comment elements exist but no buttons added, may already be processed");const u=e?2:1;if(n>=u){o.content.debug(`CommentUrlCopy: Stopping retries - comments exist but no new buttons needed (threshold: ${u})`);return}}n++,n<t.length&&setTimeout(r,t[n])};setTimeout(r,t[0])}schedulePostSubmitProcessing(e="button"){o.content.info(`CommentUrlCopy: Comment submit triggered by ${e}, scheduling post-submit processing`),[1e3,2e3,3e3].forEach((n,s)=>{setTimeout(()=>{o.content.debug(`CommentUrlCopy: Post-submit processing attempt ${s+1} (triggered by ${e})`),this.processExistingComments()},n)})}watchCommentSubmitButton(){const e=()=>{this.schedulePostSubmitProcessing("button")};this.submitButtonListener=e;const t=()=>{const s=document.querySelectorAll(`${K.PRIMARY}, ${K.PRIMARY_ALT}, ${K.INPUT_SUBMIT}`);s.forEach(r=>{!r.hasAttribute("data-comment-submit-listener")&&this.submitButtonListener&&(r.addEventListener("click",this.submitButtonListener),r.setAttribute("data-comment-submit-listener","true"),o.content.debug("CommentUrlCopy: Added submit button listener"))}),s.length===0&&document.querySelectorAll(`${K.GENERAL_SUBMIT}, ${K.INPUT_GENERAL}`).forEach(i=>{var u;const a=((u=i.textContent)==null?void 0:u.trim())||"",c=i.getAttribute("aria-label")||"";(a.includes("登録")||c.includes("登録")||c.includes("コメント"))&&!i.hasAttribute("data-comment-submit-listener")&&this.submitButtonListener&&(i.addEventListener("click",this.submitButtonListener),i.setAttribute("data-comment-submit-listener","true"),o.content.debug(`CommentUrlCopy: Added general submit button listener: ${a||c}`))})};t(),new MutationObserver(()=>{t()}).observe(document.body,{childList:!0,subtree:!0}),o.content.info("CommentUrlCopy: Submit button monitoring started")}watchCommentKeyboardSubmit(){const e=t=>{if((t.ctrlKey||t.metaKey)&&t.key==="Enter"){const n=t.target;this.isCommentInputElement(n)&&(o.content.debug("CommentUrlCopy: Ctrl+Enter detected in comment input field"),this.schedulePostSubmitProcessing("keyboard"))}};this.keyboardSubmitListener=e,this.keyboardSubmitListener&&document.addEventListener("keydown",this.keyboardSubmitListener,!0),o.content.info("CommentUrlCopy: Keyboard shortcut monitoring started (Ctrl+Enter)")}isCommentInputElement(e){if(!e)return!1;if(e.tagName.toLowerCase()==="textarea"){const t=e.classList.toString(),n=e.getAttribute("name")||"",s=e.id||"";return t.includes("comment")||t.includes("ticket")||t.includes("issue")||n.includes("comment")||n.includes("content")||s.includes("comment")||s.includes("content")}if(e.getAttribute("contenteditable")==="true"){const t=e.classList.toString(),n=e.closest('form, .comment-form, .ticket-form, [class*="comment"]');return t.includes("comment")||t.includes("editor")||n!==null}return!1}removeSubmitButtonListener(){this.submitButtonListener&&(document.querySelectorAll("[data-comment-submit-listener]").forEach(t=>{this.submitButtonListener&&t.removeEventListener("click",this.submitButtonListener),t.removeAttribute("data-comment-submit-listener")}),this.submitButtonListener=null,o.content.debug("CommentUrlCopy: Submit button listeners removed"))}removeKeyboardSubmitListener(){this.keyboardSubmitListener&&(document.removeEventListener("keydown",this.keyboardSubmitListener,!0),this.keyboardSubmitListener=null,o.content.debug("CommentUrlCopy: Keyboard shortcut listeners removed"))}}o.content.info("Content script loaded",{url:window.location.href,time:new Date().toISOString()});class _e{constructor(){h(this,"settings",null);h(this,"features",new Map);o.content.debug("BacklogUsabilityEnhance constructor called"),this.init(),this.setupMessageListener()}getFeature(e){return this.features.get(e)||null}async init(){try{o.content.info("Starting initialization process"),o.content.info("Current URL:",window.location.href),o.content.info("Current hostname:",window.location.hostname);const e=T.isBacklogPage();if(o.content.info("Is Backlog page:",e),!e){o.content.info("Not a Backlog page, skipping initialization");return}o.content.info("Initializing Backlog Usability Enhance"),this.injectDesignSystemCSS(),await this.loadSettings(),this.watchSettingsChanges(),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.onDOMReady()):this.onDOMReady(),o.content.debug("Initialization completed")}catch(e){o.content.error("Failed to initialize Backlog Usability Enhance:",e)}}async loadSettings(){this.settings=await w.getSettings(),o.content.debug("Settings loaded:",this.settings)}watchSettingsChanges(){w.onSettingsChanged(e=>{o.content.debug("Settings changed (from storage):",e),this.handleSettingsChange(e)})}setupMessageListener(){typeof chrome<"u"&&chrome.runtime&&(chrome.runtime.onMessage.addListener((e,t,n)=>(this.handleExtensionMessage(e,t,n),!0)),o.content.info("Extension message listener setup complete"))}async handleExtensionMessage(e,t,n){try{if(o.content.debug("Received extension message:",e),!e||typeof e.type!="string"){o.content.warn("Invalid message format:",e),n({success:!1,error:"Invalid message format"});return}switch(e.type){case"SETTINGS_CHANGED":{const s=e;if(!s.settings){o.content.warn("Missing settings in SETTINGS_CHANGED message"),n({success:!1,error:"Missing settings data"});return}o.content.info("Settings changed (from popup):",s.settings),this.handleSettingsChange(s.settings),n({success:!0});break}default:o.content.warn("Unknown message type:",e.type),n({success:!1,error:"Unknown message type"})}}catch(s){o.content.error("Error in handleExtensionMessage:",s);const r=s instanceof Error?s.message:"Unknown error";n({success:!1,error:r})}}handleSettingsChange(e){const t=this.settings;this.settings=e,this.updateFeatureSettings(t,e),this.applySettings()}updateFeatureSettings(e,t){if(!e)return;const n={boardAccordion:e.boardAccordion.enabled!==t.boardAccordion.enabled,shortcutKeys:e.shortcutKeys.enabled!==t.shortcutKeys.enabled,issuePending:e.issuePending.enabled!==t.issuePending.enabled,prFormat:e.prFormat.enabled!==t.prFormat.enabled,commentUrlCopy:e.commentUrlCopy.enabled!==t.commentUrlCopy.enabled};if(n.boardAccordion){const s=this.features.get("boardAccordion");s&&(s.destroy(),this.features.delete("boardAccordion"),o.content.debug("Destroyed boardAccordion feature due to enabled status change"))}if(n.shortcutKeys){const s=this.features.get("shortcutKeys");s&&(s.destroy(),this.features.delete("shortcutKeys"),o.content.debug("Destroyed shortcutKeys feature due to enabled status change"))}if(n.issuePending){const s=this.features.get("issuePending");s&&(s.destroy(),this.features.delete("issuePending"),o.content.debug("Destroyed issuePending feature due to enabled status change"))}if(n.prFormat){const s=this.features.get("prFormat");s&&(s.destroy(),this.features.delete("prFormat"),o.content.debug("Destroyed prFormat feature due to enabled status change"))}if(n.commentUrlCopy){const s=this.features.get("commentUrlCopy");s&&(s.destroy(),this.features.delete("commentUrlCopy"),o.content.debug("Destroyed commentUrlCopy feature due to enabled status change"))}for(const[s,r]of this.features)if(r.updateSettings)try{r.updateSettings(t),o.content.debug(`Updated settings for feature '${s}'`)}catch(i){o.error(`Failed to update settings for feature '${s}':`,i)}}onDOMReady(){if(!this.settings){o.content.debug("Settings not loaded yet");return}o.content.debug("DOM ready, applying settings"),this.applySettings(),this.watchPageChanges()}applySettings(){if(!this.settings)return;const e=T.getPageInfo();o.content.debug("Current page info:",e),this.toggleFeature("boardAccordion",this.settings.boardAccordion.enabled,()=>{if(e.type==="board"){o.content.debug("Initializing board accordion feature");const t=new Te;t.init(),this.features.set("boardAccordion",{init:()=>t.init(),destroy:()=>t.destroy(),updateSettings:()=>{},_instance:t})}}),this.toggleFeature("shortcutKeys",this.settings.shortcutKeys.enabled,()=>{if(e.type!=="top"){o.content.debug("Initializing shortcut keys feature");const t=new X;t.init(),this.features.set("shortcutKeys",{init:()=>t.init(),destroy:()=>t.destroy()})}else o.content.debug("Shortcut keys feature not initialized - no project navigation on this page type:",e.type)}),this.toggleFeature("issuePending",this.settings.issuePending.enabled,()=>{if(e.type==="board"){o.content.debug("Initializing issue pending feature");const t=new Ee;t.init(),this.features.set("issuePending",{init:()=>t.init(),destroy:()=>t.destroy(),_instance:t})}}),this.toggleFeature("prFormat",this.settings.prFormat.enabled,()=>{if(e.type==="git"){o.content.debug("Initializing PR format auto insert feature");const t=new Pe;t.init(),this.features.set("prFormat",{init:()=>t.init(),destroy:()=>t.destroy(),updateSettings:()=>t.updateSettings(),_instance:t})}}),this.toggleFeature("commentUrlCopy",this.settings.commentUrlCopy.enabled,()=>{var t;if(e.type==="issue"||e.type==="git"){o.content.debug("Initializing comment URL copy feature for page type:",e.type);const n=new Le({enabled:((t=this.settings)==null?void 0:t.commentUrlCopy.enabled)??!0});n.init(),this.features.set("commentUrlCopy",{init:()=>n.init(),destroy:()=>n.destroy(),updateSettings:()=>n.updateSettings(),_instance:n})}else o.content.debug("CommentUrlCopy feature not initialized - wrong page type:",e.type)})}toggleFeature(e,t,n){const s=this.features.get(e);if(t){if(!s)try{n(),o.content.debug(`Feature '${e}' enabled`)}catch(r){o.error(`Failed to enable feature '${e}':`,r)}}else if(s)try{s.destroy(),this.features.delete(e),o.content.debug(`Feature '${e}' disabled`)}catch(r){o.error(`Failed to disable feature '${e}':`,r)}}watchPageChanges(){let e=window.location.href;T.observeChanges(()=>{const t=window.location.href;t!==e&&(e=t,o.content.debug("Page changed:",t),setTimeout(()=>{this.applySettings()},100))})}injectDesignSystemCSS(){try{if(document.querySelector("#bue-design-system")){o.content.debug("Design system CSS already injected");return}const e=`
        /* Backlog Usability Enhance - Design System Variables */
        :root {
          /* プライマリーカラー */
          --primary-color: #007bff;
          --primary-hover: #0056b3;
          --primary-active: #004494;
          --primary-light: #f0f7ff;

          /* セカンダリーカラー */
          --secondary-color: #6c757d;
          --secondary-hover: #545b62;
          --secondary-light: #f8f9fa;

          /* アクセントカラー */
          --success-color: #28a745;
          --success-hover: #218838;
          --warning-color: #ffc107;
          --warning-hover: #e0a800;
          --error-color: #dc3545;
          --error-hover: #c82333;

          /* ニュートラルカラー */
          --gray-50: #f8f9fa;
          --gray-100: #f0f0f0;
          --gray-200: #e9ecef;
          --gray-300: #dee2e6;
          --gray-400: #ced4da;
          --gray-500: #adb5bd;
          --gray-600: #6c757d;
          --gray-700: #495057;
          --gray-800: #343a40;
          --gray-900: #212529;

          /* テキストカラー */
          --text-primary: #333;
          --text-secondary: #666;
          --text-muted: #999;
          --text-inverse: #fff;

          /* 背景色 */
          --bg-primary: #ffffff;
          --bg-secondary: #f8f9fa;
          --bg-tertiary: #f5f5f5;

          /* ボーダー */
          --border-color: #e9ecef;
          --border-radius-sm: 3px;
          --border-radius: 4px;
          --border-radius-md: 6px;
          --border-radius-lg: 8px;

          /* スペーシング */
          --spacing-xs: 2px;
          --spacing-sm: 4px;
          --spacing-md: 8px;
          --spacing-lg: 12px;
          --spacing-xl: 16px;
          --spacing-xxl: 24px;

          /* フォント */
          --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          --font-size-xs: 10px;
          --font-size-sm: 11px;
          --font-size-base: 13px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 600;

          /* 行間 */
          --line-height-tight: 1.2;
          --line-height-base: 1.4;
          --line-height-relaxed: 1.6;

          /* シャドウ */
          --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
          --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
          --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.15);

          /* トランジション */
          --transition-fast: 0.15s ease;
          --transition-base: 0.2s ease;
          --transition-slow: 0.3s ease;
        }

        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
          :root {
            --primary-color: #60a5fa;
            --primary-hover: #3b82f6;
            --primary-active: #2563eb;
            --primary-light: #1e3a8a;

            --success-color: #10b981;
            --success-hover: #059669;
            --warning-color: #f59e0b;
            --warning-hover: #d97706;
            --error-color: #ef4444;
            --error-hover: #dc2626;

            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --text-inverse: #000;

            --bg-primary: #2a2a2a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #404040;

            --border-color: #404040;

            --gray-50: #525252;
            --gray-100: #404040;
            --gray-200: #374151;
            --gray-300: #4b5563;
            --gray-400: #6b7280;
            --gray-500: #9ca3af;
            --gray-600: #d1d5db;
            --gray-700: #e5e7eb;
            --gray-800: #f3f4f6;
            --gray-900: #f9fafb;
          }
        }

        /* ベースボタンスタイル */
        .bue-button {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--spacing-sm) var(--spacing-lg);
          font-family: var(--font-family);
          font-size: var(--font-size-base);
          font-weight: var(--font-weight-medium);
          line-height: var(--line-height-tight);
          text-decoration: none;
          border: 1px solid transparent;
          border-radius: var(--border-radius);
          cursor: pointer;
          transition: all var(--transition-base);
          user-select: none;
          white-space: nowrap;
          background: none;
          outline: none;
        }

        .bue-button:focus {
          outline: 2px solid var(--primary-color);
          outline-offset: 2px;
        }

        .bue-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          pointer-events: none;
        }

        /* ボタンバリエーション */
        .bue-button--primary {
          background-color: var(--primary-color);
          color: var(--text-inverse);
          border-color: var(--primary-color);
        }

        .bue-button--primary:hover:not(:disabled) {
          background-color: var(--primary-hover);
          border-color: var(--primary-hover);
        }

        .bue-button--secondary {
          background-color: var(--secondary-color);
          color: var(--text-inverse);
          border-color: var(--secondary-color);
        }

        .bue-button--secondary:hover:not(:disabled) {
          background-color: var(--secondary-hover);
          border-color: var(--secondary-hover);
        }

        .bue-button--ghost {
          background-color: transparent;
          color: var(--text-primary);
          border-color: var(--border-color);
        }

        .bue-button--ghost:hover:not(:disabled) {
          background-color: var(--gray-50);
          color: var(--text-primary);
        }

        .bue-button--minimal {
          background-color: transparent;
          color: var(--text-secondary);
          border: none;
          padding: var(--spacing-xs) var(--spacing-sm);
        }

        .bue-button--minimal:hover:not(:disabled) {
          background-color: var(--gray-100);
          color: var(--text-primary);
        }

        /* ボタンサイズ */
        .bue-button--xs {
          padding: var(--spacing-xs) var(--spacing-sm);
          font-size: var(--font-size-xs);
          border-radius: var(--border-radius-sm);
        }

        .bue-button--sm {
          padding: var(--spacing-sm) var(--spacing-md);
          font-size: var(--font-size-sm);
          border-radius: var(--border-radius-sm);
        }

        .bue-button--lg {
          padding: var(--spacing-lg) var(--spacing-xxl);
          font-size: var(--font-size-lg);
          border-radius: var(--border-radius-md);
        }

        /* アイコンボタン */
        .bue-button--icon {
          width: 32px;
          height: 32px;
          padding: 0;
          border-radius: var(--border-radius);
        }

        .bue-button--icon.bue-button--sm {
          width: 24px;
          height: 24px;
        }

        .bue-button--icon.bue-button--lg {
          width: 40px;
          height: 40px;
        }

        /* フォーカス管理 */
        .bue-focus-visible:focus {
          outline: 2px solid var(--primary-color);
          outline-offset: 2px;
        }

        /* モーションを避けたいユーザー向け */
        @media (prefers-reduced-motion: reduce) {
          .bue-button {
            transition: none !important;
          }
        }
      `,t=document.createElement("style");t.id="bue-design-system",t.textContent=e,document.head.insertBefore(t,document.head.firstChild),o.content.info("Design system CSS injected successfully")}catch(e){o.content.error("Failed to inject design system CSS:",e)}}destroy(){o.content.debug("Destroying Backlog Usability Enhance");for(const[t,n]of this.features)try{n.destroy(),o.content.debug(`Feature '${t}' destroyed`)}catch(s){o.error(`Failed to destroy feature '${t}':`,s)}this.features.clear();const e=document.querySelector("#bue-design-system");e&&e.remove()}}o.content.info("Creating BacklogUsabilityEnhance instance...");const ie=new _e;o.content.info("BacklogUsabilityEnhance instance created successfully"),window.__backlog_usability_enhance__=ie,window.__backlog_usability_enhance_dev__=!0,window.addEventListener("beforeunload",()=>{ie.destroy()})})();
