var be=Object.defineProperty;var me=(T,I,L)=>I in T?be(T,I,{enumerable:!0,configurable:!0,writable:!0,value:L}):T[I]=L;var h=(T,I,L)=>me(T,typeof I!="symbol"?I+"":I,L);(function(){"use strict";var T=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function I(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var L={exports:{}};(function(l){(function(e,t){l.exports?l.exports=t():e.log=t()})(T,function(){var e=function(){},t="undefined",o=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),s=["trace","debug","info","warn","error"],r={},i=null;function a(f,v){var u=f[v];if(typeof u.bind=="function")return u.bind(f);try{return Function.prototype.bind.call(u,f)}catch{return function(){return Function.prototype.apply.apply(u,[f,arguments])}}}function d(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function g(f){return f==="debug"&&(f="log"),typeof console===t?!1:f==="trace"&&o?d:console[f]!==void 0?a(console,f):console.log!==void 0?a(console,"log"):e}function b(){for(var f=this.getLevel(),v=0;v<s.length;v++){var u=s[v];this[u]=v<f?e:this.methodFactory(u,f,this.name)}if(this.log=this.debug,typeof console===t&&f<this.levels.SILENT)return"No console available for logging"}function m(f){return function(){typeof console!==t&&(b.call(this),this[f].apply(this,arguments))}}function G(f,v,u){return g(f)||m.apply(this,arguments)}function M(f,v){var u=this,q,W,_,x="loglevel";typeof f=="string"?x+=":"+f:typeof f=="symbol"&&(x=void 0);function pe(p){var w=(s[p]||"silent").toUpperCase();if(!(typeof window===t||!x)){try{window.localStorage[x]=w;return}catch{}try{window.document.cookie=encodeURIComponent(x)+"="+w+";"}catch{}}}function X(){var p;if(!(typeof window===t||!x)){try{p=window.localStorage[x]}catch{}if(typeof p===t)try{var w=window.document.cookie,O=encodeURIComponent(x),Q=w.indexOf(O+"=");Q!==-1&&(p=/^([^;]+)/.exec(w.slice(Q+O.length+1))[1])}catch{}return u.levels[p]===void 0&&(p=void 0),p}}function he(){if(!(typeof window===t||!x)){try{window.localStorage.removeItem(x)}catch{}try{window.document.cookie=encodeURIComponent(x)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function K(p){var w=p;if(typeof w=="string"&&u.levels[w.toUpperCase()]!==void 0&&(w=u.levels[w.toUpperCase()]),typeof w=="number"&&w>=0&&w<=u.levels.SILENT)return w;throw new TypeError("log.setLevel() called with invalid level: "+p)}u.name=f,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=v||G,u.getLevel=function(){return _??W??q},u.setLevel=function(p,w){return _=K(p),w!==!1&&pe(_),b.call(u)},u.setDefaultLevel=function(p){W=K(p),X()||u.setLevel(p,!1)},u.resetLevel=function(){_=null,he(),b.call(u)},u.enableAll=function(p){u.setLevel(u.levels.TRACE,p)},u.disableAll=function(p){u.setLevel(u.levels.SILENT,p)},u.rebuild=function(){if(i!==u&&(q=K(i.getLevel())),b.call(u),i===u)for(var p in r)r[p].rebuild()},q=K(i?i.getLevel():"WARN");var J=X();J!=null&&(_=K(J)),b.call(u)}i=new M,i.getLogger=function(v){if(typeof v!="symbol"&&typeof v!="string"||v==="")throw new TypeError("You must supply a name when creating a logger.");var u=r[v];return u||(u=r[v]=new M(v,i.methodFactory)),u};var H=typeof window!==t?window.log:void 0;return i.noConflict=function(){return typeof window!==t&&window.log===i&&(window.log=H),i},i.getLoggers=function(){return r},i.default=i,i})})(L);var ee=L.exports;const S=I(ee),V={level:"info",prefix:"[Backlog Enhancement]",timestamp:!0},F={boardAccordion:"error",issuePending:"error",shortcutKeys:"error",storage:"error",backlog:"error",background:"error",options:"error",content:"error"},R=new Map;function te(l){S.setLevel(l)}function N(l,e){const t=R.get(l);t&&t.setLevel(e),F[l]=e}function oe(l){return F[l]||"info"}function se(){return{...F}}function re(l){const e=R.get(l);if(e)return e;const t=S.getLogger(l),o=F[l]||"info";t.setLevel(o);const s=t.methodFactory;return t.methodFactory=function(r,i,a){const d=s(r,i,a);return function(...g){const b=`[${new Date().toISOString()}]`,m=`${V.prefix}`,G=`[${r.toUpperCase()}]`,M=`[${l.charAt(0).toUpperCase()+l.slice(1)}]`,H=[`${b} ${m} ${G} ${M}`,...g].filter(Boolean);d(...H)}},t.setLevel(t.getLevel()),R.set(l,t),t}function U(){if(typeof window>"u"||typeof chrome>"u")return!0;try{return window.location.hostname==="localhost"||window.location.hostname.includes("dev")||chrome.runtime.getManifest().version.includes("dev")}catch{return!0}}function ne(l){const e=S.methodFactory;S.methodFactory=function(t,o,s){const r=e(t,o,s);return function(...i){const a=l.timestamp?`[${new Date().toISOString()}]`:"",d=l.prefix?`${l.prefix}`:"",g=`[${t.toUpperCase()}]`,b=[`${a} ${d} ${g}`,...i].filter(Boolean);r(...b)}},S.setLevel(S.getLevel())}function ie(l){const e={...V,...l};U()?e.level="debug":e.level="warn",ne(e),te(e.level),S.info("Logger initialized",{level:e.level,isDev:U()})}function A(l){const e=re(l);return{debug:(...t)=>e.debug(...t),info:(...t)=>e.info(...t),warn:(...t)=>e.warn(...t),error:(...t)=>e.error(...t)}}const n={debug:(...l)=>S.debug(...l),info:(...l)=>S.info(...l),warn:(...l)=>S.warn(...l),error:(...l)=>S.error(...l),boardAccordion:A("boardAccordion"),issuePending:A("issuePending"),shortcutKeys:A("shortcutKeys"),storage:A("storage"),backlog:A("backlog"),background:A("background"),options:A("options"),content:A("content"),popup:A("popup")},ae={setLevel:N,getLevel:oe,showAll:()=>{console.table(se())},enable:l=>{N(l,"debug"),console.log(`✅ ${l} logging enabled (debug level)`)},disable:l=>{N(l,"silent"),console.log(`❌ ${l} logging disabled`)},enableAll:()=>{Object.keys(F).forEach(l=>{N(l,"debug")}),console.log("✅ All feature logging enabled")},disableAll:()=>{Object.keys(F).forEach(l=>{N(l,"error")}),console.log("❌ All feature logging disabled (error only)")}};typeof window<"u"&&U()&&(window.__backlogLoggerControl__=ae),ie();class c{static isBacklogPage(){const e=window.location.hostname;return e.includes(".backlog.jp")||e.includes(".backlog.com")}static getPageInfo(){const e=window.location.href,t=window.location.pathname;let o;const s=t.match(/\/view\/([A-Z0-9_]+)/),r=t.match(/\/board\/([A-Z0-9_]+)/);s?o=s[1]:r&&(o=r[1]);let i="other";t.includes("/ProjectBoard")||t.includes("/board/")?i="board":t.includes("/view/")&&t.includes("#")?i="issue":t.includes("/projects/")?i="project":t.includes("/wiki/")?i="wiki":t.includes("/git/")&&(i="git");let a;if(i==="issue"){const d=t.match(/\/view\/([A-Z0-9_]+-\d+)/);a=d?d[1]:void 0}return{type:i,projectKey:o,issueKey:a,url:e}}static waitForElement(e,t=5e3){return new Promise(o=>{const s=document.querySelector(e);if(s){o(s);return}const r=new MutationObserver(()=>{const i=document.querySelector(e);i&&(r.disconnect(),o(i))});r.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{r.disconnect(),o(null)},t)})}static findElementByCandidates(e){for(const t of e){const o=document.querySelector(t);if(o)return o}return null}static findElementsByCandidates(e){for(const t of e){const o=Array.from(document.querySelectorAll(t));if(o.length>0)return o}return[]}static observeChanges(e,t={childList:!0,subtree:!0}){const o=new MutationObserver(e);return o.observe(document.body,t),o}static log(e,...t){window.__backlog_usability_enhance_dev__&&n.backlog.debug(e,...t)}}const E={boardAccordion:{enabled:!0},shortcutKeys:{enabled:!0},issuePending:{enabled:!0,autoResolve:!0},prFormat:{enabled:!0,projectTemplates:{}}};class C{static async getSettings(){try{const t=(await chrome.storage.sync.get(this.SETTINGS_KEY))[this.SETTINGS_KEY];return t?this.mergeWithDefaults(t):E}catch(e){return n.storage.error("Failed to get settings:",e),E}}static async saveSettings(e){try{await chrome.storage.sync.set({[this.SETTINGS_KEY]:e})}catch(t){throw n.storage.error("Failed to save settings:",t),t}}static onSettingsChanged(e){chrome.storage.onChanged.addListener((t,o)=>{if(o==="sync"&&t[this.SETTINGS_KEY]){const s=t[this.SETTINGS_KEY].newValue;s&&e(this.mergeWithDefaults(s))}})}static mergeWithDefaults(e){return{boardAccordion:{...E.boardAccordion,...e.boardAccordion},shortcutKeys:{...E.shortcutKeys,...e.shortcutKeys},issuePending:{...E.issuePending,...e.issuePending},prFormat:{...E.prFormat,...e.prFormat}}}}h(C,"SETTINGS_KEY","backlog_usability_enhance_settings");class D{static async get(e){try{return!chrome.storage||!chrome.storage.local?(n.storage.warn("Extension context invalidated, skipping storage access"),null):(await chrome.storage.local.get(e))[e]||null}catch(t){return t instanceof Error&&t.message.includes("Extension context invalidated")?(n.storage.warn(`Extension context invalidated for key: ${e}`),null):(n.storage.error(`Failed to get local storage data for key: ${e}`,t),null)}}static async set(e,t){try{if(!chrome.storage||!chrome.storage.local){n.storage.warn("Extension context invalidated, skipping storage save");return}await chrome.storage.local.set({[e]:t})}catch(o){if(o instanceof Error&&o.message.includes("Extension context invalidated")){n.storage.warn(`Extension context invalidated for key: ${e}`);return}throw n.storage.error(`Failed to set local storage data for key: ${e}`,o),o}}static async remove(e){try{await chrome.storage.local.remove(e)}catch(t){throw n.storage.error(`Failed to remove local storage data for key: ${e}`,t),t}}}class Y{static async getProjectTemplate(e){try{return(await C.getSettings()).prFormat.projectTemplates[e]||null}catch(t){return n.storage.error("Failed to get project template:",{projectKey:e,error:t}),null}}static async setProjectTemplate(e,t){try{const o=await C.getSettings();o.prFormat.projectTemplates[e]=t,await C.saveSettings(o),n.storage.info("Project template saved:",{projectKey:e})}catch(o){throw n.storage.error("Failed to save project template:",{projectKey:e,error:o}),o}}static async removeProjectTemplate(e){try{const t=await C.getSettings();delete t.prFormat.projectTemplates[e],await C.saveSettings(t),n.storage.info("Project template removed:",{projectKey:e})}catch(t){throw n.storage.error("Failed to remove project template:",{projectKey:e,error:t}),t}}static async getAllProjectTemplates(){try{return(await C.getSettings()).prFormat.projectTemplates}catch(e){return n.storage.error("Failed to get all project templates:",e),{}}}static async isEnabled(){try{return(await C.getSettings()).prFormat.enabled}catch(e){return n.storage.error("Failed to get PR format enabled status:",e),!1}}static async setEnabled(e){try{const t=await C.getSettings();t.prFormat.enabled=e,await C.saveSettings(t),n.storage.info("PR format enabled status updated:",{enabled:e})}catch(t){throw n.storage.error("Failed to update PR format enabled status:",{enabled:e,error:t}),t}}}class le{constructor(){h(this,"observer",null);h(this,"keyboardHandler");h(this,"debounceTimeout",null);h(this,"abortController",new AbortController);h(this,"config",{COLLAPSED_WIDTH:"72px",BUTTON_DELAY:500,INIT_DELAY:1e3});this.keyboardHandler=this.handleKeyboardShortcuts.bind(this)}init(){if(n.boardAccordion.info("Initializing"),c.getPageInfo().type!=="board"){n.boardAccordion.debug("Not a board page, skipping");return}setTimeout(()=>{this.addCollapseButtons(),this.setupKeyboardShortcuts()},this.config.INIT_DELAY),this.observeChanges()}destroy(){n.boardAccordion.info("Destroying"),this.observer&&(this.observer.disconnect(),this.observer=null),this.debounceTimeout&&(clearTimeout(this.debounceTimeout),this.debounceTimeout=null),this.abortController.abort(),this.abortController=new AbortController,document.removeEventListener("keydown",this.keyboardHandler),this.removeCollapseButtons()}addCollapseButtons(){const t=document.querySelectorAll('.css-hrpltn-col, [data-testid="board-column"], .board-column, [class*="column"], .lane');if(t.length>0&&n.boardAccordion.debug(`Found ${t.length} columns using optimized selector`),t.length===0){n.boardAccordion.warn("No status columns found");return}n.boardAccordion.info(`Found ${t.length} status columns`);const o=[];t.forEach((s,r)=>{const i=s.querySelector('.css-ujzck4-row, [class*="header"], [class*="title"], h1, h2, h3, h4, h5, h6');if(!i||i.querySelector(".collapse-button"))return;const a=this.createCollapseButton();o.push({column:s,button:a,index:r});const d=i.querySelector('h3.SlotHead, h3, h2, h1, [class*="title"], [class*="header"]');if(d){d.appendChild(a);const g=s.querySelector(".css-15rua0m-box.SlotBox");g&&this.setupHeaderClickExpand(g,s,a,r),this.restoreColumnState(s,a)}else{i.appendChild(a);const g=s.querySelector(".css-15rua0m-box.SlotBox");g?this.setupHeaderClickExpand(g,s,a,r):this.setupHeaderClickExpand(i,s,a,r),this.restoreColumnState(s,a)}}),requestAnimationFrame(()=>{o.forEach(({column:s,button:r,index:i})=>{this.setupButtonInteractions(s,r,i)})})}createCollapseButton(){const e=document.createElement("button");return e.className="bue-button bue-button--minimal bue-button--xs collapse-button",e.textContent="▼",e.title="ステータス列を折りたたむ",e.setAttribute("aria-label","ステータス列を折りたたむ"),e.setAttribute("aria-expanded","true"),e.setAttribute("type","button"),e.style.cssText=`
      margin-left: var(--spacing-sm, 4px);
      align-self: center;
      font-size: 12px;
    `,e}setupButtonInteractions(e,t,o){const s=new AbortController;t.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),this.toggleColumn(e,t,o)},{signal:s.signal}),t.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),r.stopPropagation(),this.toggleColumn(e,t,o))},{signal:s.signal}),t.__abortController=s}setupHeaderClickExpand(e,t,o,s){e.dataset.expandClickSetup!=="true"&&(e.addEventListener("click",r=>{const i=r.target;if(i.classList.contains("collapse-button")||i.tagName==="A"||i.tagName==="BUTTON"||i.tagName==="SVG"||i.tagName==="USE"||i.closest("a")||i.closest("button:not(.collapse-button)")||i.closest("svg"))return;const a=this.getColumnElements(t);a.issueList&&a.issueList.style.display==="none"&&(r.preventDefault(),r.stopPropagation(),this.toggleColumn(t,o,s))}),e.addEventListener("mouseenter",()=>{const r=this.getColumnElements(t);if(r.issueList&&r.issueList.style.display==="none"){e.style.cursor="pointer";const i=e.querySelector(".StatusIcon");i&&(i.style.cursor="pointer")}}),e.addEventListener("mouseleave",()=>{const r=this.getColumnElements(t);r.issueList&&r.issueList.style.display,e.style.cursor=""}),e.dataset.expandClickSetup="true")}toggleColumn(e,t,o){const s=this.getColumnElements(e);if(!s.issueList)return;const r=s.issueList.style.display==="none",i=this.getStatusName(e)||`column_${o}`;n.boardAccordion.debug(`Toggling column '${i}', isCollapsed: ${r}`),r?this.expandColumn(e,t,s):this.collapseColumn(e,t,s),this.saveColumnState(e,!r)}getColumnElements(e){const t=o=>{for(const s of o){const r=e.querySelector(s);if(r)return r}return null};return{issueList:t(["ul.SlotBox",'[class*="issue-list"]','[class*="card-list"]',"ul, ol",'[class*="list"]']),statusName:t(["h3.SlotHead > div:nth-child(2)",'[class*="status-name"]','[class*="column-title"]',"h1, h2, h3, h4, h5, h6"]),expandArea:t(["h3.SlotHead > div:nth-child(3)",'[class*="expand"]','[class*="action"]']),addIssueButton:t([".css-oslcxi-row",'[class*="add-issue"]','[class*="add-button"]','button[class*="add"]']),descriptionArea:t([".css-1vsmiu0-box",'[class*="description"]','[class*="summary"]'])}}expandColumn(e,t,o){var r,i,a,d,g;(r=o.issueList)!=null&&r.style&&(o.issueList.style.display=""),(i=o.statusName)!=null&&i.style&&(o.statusName.style.display=""),(a=o.expandArea)!=null&&a.style&&(o.expandArea.style.display=""),(d=o.addIssueButton)!=null&&d.style&&(o.addIssueButton.style.display=""),(g=o.descriptionArea)!=null&&g.style&&(o.descriptionArea.style.display=""),t.textContent="▼",t.title="ステータス列を折りたたむ",t.setAttribute("aria-label","ステータス列を折りたたむ"),t.setAttribute("aria-expanded","true"),e.style.width="",e.style.minWidth="",e.style.maxWidth="",e.style.paddingRight="";const s=e.firstElementChild;s&&(s.style.height=""),this.removeIconTooltip(e),this.refreshPendingStatesInColumn()}collapseColumn(e,t,o){var r,i,a,d,g;(r=o.issueList)!=null&&r.style&&(o.issueList.style.display="none"),(i=o.statusName)!=null&&i.style&&(o.statusName.style.display="none"),(a=o.expandArea)!=null&&a.style&&(o.expandArea.style.display="none"),(d=o.addIssueButton)!=null&&d.style&&(o.addIssueButton.style.display="none"),(g=o.descriptionArea)!=null&&g.style&&(o.descriptionArea.style.display="none"),t.textContent="▶",t.title="ステータス列を展開する",t.setAttribute("aria-label","ステータス列を展開する"),t.setAttribute("aria-expanded","false"),e.style.width=this.config.COLLAPSED_WIDTH,e.style.minWidth=this.config.COLLAPSED_WIDTH,e.style.maxWidth=this.config.COLLAPSED_WIDTH,e.matches(".css-hrpltn-col:last-of-type")&&(e.style.paddingRight="0");const s=e.firstElementChild;s&&(s.style.height="100%"),this.addIconTooltip(e,o)}addIconTooltip(e,t){var s;const o=e.querySelector(".StatusIcon");if(o&&t.statusName){const r=((s=t.statusName.textContent)==null?void 0:s.trim())||"";o.title=r,o.style.cursor="pointer"}}removeIconTooltip(e){const t=e.querySelector(".StatusIcon");t&&(t.title="",t.style.cursor="")}getStatusName(e){var r,i;const t=this.getColumnElements(e);if(t.statusName){const a=(r=t.statusName.textContent)==null?void 0:r.trim();if(a)return a}const o=e.dataset.statusName;return o||`column_${Array.from(((i=e.parentElement)==null?void 0:i.children)||[]).indexOf(e)}`}async saveColumnState(e,t){const o=this.getStatusName(e);if(!o){n.boardAccordion.warn("Cannot save state - status name not found");return}const r=`backlog_column_${c.getPageInfo().projectKey||"unknown"}_${o}`;try{await D.set(r,t),n.boardAccordion.debug(`Saved column '${o}' state: ${t}`)}catch(i){n.boardAccordion.error("Failed to save column state:",i)}}async restoreColumnState(e,t){const o=this.getStatusName(e);if(!o){n.boardAccordion.warn("Cannot restore state - status name not found");return}const r=`backlog_column_${c.getPageInfo().projectKey||"unknown"}_${o}`;try{if(await D.get(r)){const a=this.getColumnElements(e);this.collapseColumn(e,t,a),n.boardAccordion.debug(`Restored column '${o}' as collapsed`)}}catch(i){n.boardAccordion.error("Failed to restore column state:",i)}}observeChanges(){this.observer=c.observeChanges(e=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=window.setTimeout(()=>{e.some(o=>o.type==="childList"&&o.addedNodes.length>0&&Array.from(o.addedNodes).some(s=>s.nodeType===Node.ELEMENT_NODE&&s.matches('.css-hrpltn-col, [data-testid="board-column"], .board-column')))&&c.getPageInfo().type==="board"&&this.addCollapseButtons()},this.config.BUTTON_DELAY)})}setupKeyboardShortcuts(){document.addEventListener("keydown",this.keyboardHandler,{signal:this.abortController.signal})}refreshPendingStatesInColumn(){var e;try{const t=window.__backlog_usability_enhance__;if(!t){n.boardAccordion.debug("Global instance not available for pending state refresh");return}const o=(e=t.getFeature("issuePending"))==null?void 0:e._instance;if(!o||typeof o.refreshAllVisibleCards!="function"){n.boardAccordion.debug("IssuePending feature not available or method not found");return}setTimeout(()=>{o.refreshAllVisibleCards().catch(s=>{n.boardAccordion.error("Failed to refresh pending states in column:",s)}),n.boardAccordion.debug("Refreshed pending states in expanded column")},50)}catch(t){n.boardAccordion.error("Error while refreshing pending states:",t)}}handleKeyboardShortcuts(e){const t=document.activeElement;t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)||(e.ctrlKey&&e.shiftKey&&e.key==="E"&&(e.preventDefault(),this.expandAllColumns(),n.boardAccordion.info("Expand all columns via shortcut")),e.ctrlKey&&e.shiftKey&&e.key==="C"&&(e.preventDefault(),this.collapseAllColumns(),n.boardAccordion.info("Collapse all columns via shortcut")))}expandAllColumns(){document.querySelectorAll(".css-hrpltn-col").forEach((t,o)=>{const s=t.querySelector(".collapse-button");s&&s.textContent==="▶"&&this.toggleColumn(t,s,o)}),this.refreshAllPendingStates()}refreshAllPendingStates(){var e;try{const t=window.__backlog_usability_enhance__;if(!t){n.boardAccordion.debug("Global instance not available for pending state refresh");return}const o=(e=t.getFeature("issuePending"))==null?void 0:e._instance;if(!o||typeof o.refreshAllVisibleCards!="function"){n.boardAccordion.debug("IssuePending feature not available or method not found");return}setTimeout(()=>{o.refreshAllVisibleCards().catch(s=>{n.boardAccordion.error("Failed to refresh all pending states:",s)}),n.boardAccordion.debug("Refreshed all pending states after column operations")},100)}catch(t){n.boardAccordion.error("Error while refreshing all pending states:",t)}}collapseAllColumns(){document.querySelectorAll(".css-hrpltn-col").forEach((t,o)=>{const s=t.querySelector(".collapse-button");s&&s.textContent==="▼"&&this.toggleColumn(t,s,o)})}removeCollapseButtons(){document.querySelectorAll(".collapse-button").forEach(t=>{var r;const o=t.__abortController;o&&o.abort();const s=(r=t.closest(".css-hrpltn-col"))==null?void 0:r.querySelector('[data-expand-click-setup="true"]');s&&(s.removeAttribute("data-expand-click-setup"),s.style.cursor=""),t.remove()})}}const B=class B{constructor(){h(this,"observer",null);h(this,"originalLabels",new Map);h(this,"isUpdating",!1);n.shortcutKeys.debug("constructor()")}init(){try{const e=this.findProjectNavList();if(!e){n.shortcutKeys.debug("Project navigation list not found, retrying..."),setTimeout(()=>{this.retryInitialization()},300);return}this.integrateShortcutKeys(e),this.observeNavigationChanges(e),setTimeout(()=>{this.integrateShortcutKeys(e)},100),n.shortcutKeys.info("Feature initialized")}catch(e){n.shortcutKeys.error("Failed to initialize:",e)}}retryInitialization(){const e=this.findProjectNavList();e?(n.shortcutKeys.debug("Project navigation found on retry, initializing..."),this.integrateShortcutKeys(e),this.observeNavigationChanges(e)):n.shortcutKeys.warn("Project navigation still not found after retry")}destroy(){n.shortcutKeys.debug("destroy()");try{this.observer&&(this.observer.disconnect(),this.observer=null),this.restoreOriginalLabels(),n.shortcutKeys.info("Feature destroyed")}catch(e){n.shortcutKeys.error("Failed to destroy:",e)}}findProjectNavList(){const e=["#projectNavList",".project-nav-list",'[role="navigation"][aria-label*="プロジェクト"]'];for(const t of e){const o=document.querySelector(t);if(o)return o}return null}integrateShortcutKeys(e){var t;if(!this.isUpdating){this.isUpdating=!0;try{this.restoreOriginalLabels();const o=e.querySelectorAll(".project-nav-list__item a, .project-nav-list__item span");for(const s of o){const r=s,i=r.id;n.shortcutKeys.debug(`Processing nav item: id="${i}", href="${r.getAttribute("href")}", text="${(t=r.textContent)==null?void 0:t.trim()}"`);let a=B.SHORTCUT_MAPPINGS.find(d=>d.elementId===i);if(i==="navi-file"){const d=r.getAttribute("href");d&&d.includes("/git/")&&(a=B.SHORTCUT_MAPPINGS.find(g=>g.elementId==="navi-git"),n.shortcutKeys.debug("Detected Git menu with navi-file ID, using Git mapping"))}a&&this.integrateShortcutKeyToLabel(r,a)}}finally{setTimeout(()=>{this.isUpdating=!1},200)}}}integrateShortcutKeyToLabel(e,t){try{const o=e.querySelector(".project-nav-list__text span");if(!o||!o.textContent)return;const s=this.getUniqueElementKey(e,t);this.originalLabels.has(s)||this.originalLabels.set(s,o.textContent);const r=this.originalLabels.get(s)||o.textContent;if(r.includes(`(${t.key.toUpperCase()})`))return;const i=`${r} (${t.key.toUpperCase()})`;o.textContent=i,e.title=i;const a=e.getAttribute("data-tooltip");if(a&&!a.includes(`(${t.key.toUpperCase()})`)){e.hasAttribute("data-original-tooltip")||e.setAttribute("data-original-tooltip",a);const d=`${a} (${t.key.toUpperCase()})`;e.setAttribute("data-tooltip",d),n.shortcutKeys.debug(`Updated data-tooltip: ${a} -> ${d}`)}n.shortcutKeys.debug(`Integrated shortcut key '${t.key}' into label: ${r} -> ${i}`)}catch(o){n.shortcutKeys.error(`Failed to integrate shortcut key to ${t.elementId}:`,o)}}getUniqueElementKey(e,t){const o=e.getAttribute("href");return e.id==="navi-file"&&o&&o.includes("/git/")?"navi-git":t.elementId}restoreOriginalLabels(){for(const[e,t]of this.originalLabels)try{let o=null;if(e==="navi-git"){const s=document.querySelectorAll("#navi-file");for(const r of s){const i=r.getAttribute("href");if(i&&i.includes("/git/")){o=r;break}}}else o=document.getElementById(e);if(o){const s=o.querySelector(".project-nav-list__text span");if(s){s.textContent=t,o.title=o.getAttribute("data-tooltip")||"";const r=o.getAttribute("data-original-tooltip");r&&(o.setAttribute("data-tooltip",r),o.removeAttribute("data-original-tooltip"),n.shortcutKeys.debug(`Restored data-tooltip to: ${r}`))}}}catch(o){n.shortcutKeys.error(`Failed to restore label for ${e}:`,o)}this.originalLabels.clear()}observeNavigationChanges(e){this.observer=new MutationObserver(t=>{if(this.isUpdating)return;let o=!1;for(const s of t)if(s.type==="childList"&&s.addedNodes.length>0){for(const r of s.addedNodes)if(r.nodeType===Node.ELEMENT_NODE){const i=r;if(i.classList.contains("project-nav-list__item")||i.querySelector(".project-nav-list__item")){o=!0;break}}if(o)break}o&&setTimeout(()=>{this.integrateShortcutKeys(e)},100)}),this.observer.observe(e,{childList:!0,subtree:!0})}};h(B,"SHORTCUT_MAPPINGS",[{key:"h",description:"ホーム",elementId:"navi-home"},{key:"a",description:"課題の追加",elementId:"navi-add"},{key:"f",description:"課題",elementId:"navi-find"},{key:"r",description:"ボード",elementId:"navi-board"},{key:"g",description:"ガントチャート",elementId:"navi-gantt"},{key:"w",description:"Wiki",elementId:"navi-wiki"},{key:"s",description:"ファイル",elementId:"navi-file"},{key:"v",description:"Subversion",elementId:"navi-subversion"},{key:"t",description:"Git",elementId:"navi-git"}]);let z=B;class k{static getStorageKey(e){return`${this.STORAGE_KEY_PREFIX}${e}`}static async getPendingIssues(e){if(!this.validateProjectKey(e))return n.storage.warn(`Invalid project key: ${e}`),[];try{const t=this.getStorageKey(e),o=await D.get(t);return!o||!Array.isArray(o)?[]:o}catch(t){return n.storage.error(`Failed to get pending issues for project ${e}:`,t),[]}}static async savePendingIssues(e,t){if(!this.validateProjectKey(e))throw new Error(`Invalid project key: ${e}`);const o=t.filter(s=>this.validatePendingIssue(s));o.length!==t.length&&n.storage.warn(`Filtered invalid issues: ${t.length-o.length} removed`);try{const s=this.getStorageKey(e);await D.set(s,o)}catch(s){throw n.storage.error(`Failed to save pending issues for project ${e}:`,s),s}}static async setPendingIssue(e,t){if(!this.validatePendingIssue(t))throw new Error(`Invalid pending issue data: ${JSON.stringify(t)}`);try{const s=(await this.getPendingIssues(e)).filter(r=>r.issueKey!==t.issueKey);s.push(t),await this.savePendingIssues(e,s)}catch(o){throw n.storage.error(`Failed to set pending issue ${t.issueKey}:`,o),o}}static async removePendingIssue(e,t){if(!this.validateIssueKey(t))throw new Error(`Invalid issue key: ${t}`);try{const s=(await this.getPendingIssues(e)).filter(r=>r.issueKey!==t);await this.savePendingIssues(e,s)}catch(o){throw n.storage.error(`Failed to remove pending issue ${t}:`,o),o}}static async isPendingIssue(e,t){return(await this.getPendingIssues(e)).some(s=>s.issueKey===t)}static async clearPendingIssues(e){if(!this.validateProjectKey(e))throw new Error(`Invalid project key: ${e}`);try{const t=this.getStorageKey(e);await D.remove(t)}catch(t){throw n.storage.error(`Failed to clear pending issues for project ${e}:`,t),t}}static validateProjectKey(e){return typeof e=="string"&&e.length>0&&/^[A-Z0-9_]+$/.test(e)}static validateIssueKey(e){return typeof e=="string"&&/^[A-Z0-9_]+-\d+$/.test(e)}static validatePendingIssue(e){return e&&typeof e=="object"&&this.validateIssueKey(e.issueKey)&&this.validateProjectKey(e.projectKey)}static async getAllPendingData(){return n.storage.warn("getAllPendingData is for debugging purposes only"),{}}}h(k,"STORAGE_KEY_PREFIX","backlog_pending_issues_");const ce=["li.css-1og413z-box.card",".css-1og413z-box.card","li.card",".card:not(.card-label):not(.card-summary):not(.card-status)",".IssueCard","[data-issue-key]"],de=[".card-label",'a[href*="/view/"]',"[data-issue-key]",".IssueKey"],y={className:"pending-toggle-button",activeClassName:"pending-toggle-button--active",icon:{pending:`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="4" y="4" width="2.25" height="8" fill="currentColor" rx="0.5"/>
      <rect x="9" y="4" width="2.25" height="8" fill="currentColor" rx="0.5"/>
    </svg>`,normal:`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="padding-left: 2px;">
      <path d="M4 3L12 8L4 13V3Z" fill="currentColor"/>
    </svg>`},tooltip:{pending:"Pending状態を解除",normal:"課題をPending状態にする"}},j={pending:"issue-card--pending",normal:"issue-card--normal"},$={className:"pending-card-tooltip",delay:200,width:250};class P{static findIssueCards(e=document.body){const t=[];for(const o of ce){e.matches&&e.matches(o)&&(c.log(`[PendingDom] Container itself matches selector: ${o}`),t.includes(e)||(c.log(`[PendingDom] Container element classes: ${e.className}`),t.push(e)));const s=e.querySelectorAll(o);if(s.length>0){c.log(`[PendingDom] Found ${s.length} child elements with selector: ${o}`);for(const r of s)t.includes(r)||(c.log(`[PendingDom] Child element classes: ${r.className}`),t.push(r))}}return c.log(`[PendingDom] Total ${t.length} unique cards found`),t}static extractIssueKey(e){var i;const t=e.getAttribute("data-issue-key");if(t&&this.validateIssueKey(t))return t;const o=e.querySelector(".card-label");if(o&&o.href){const a=o.href.match(/\/view\/([A-Z0-9_]+-\d+)/);if(a&&a[1])return a[1]}if(o&&o.textContent){const a=o.textContent.trim();if(this.validateIssueKey(a))return a}for(const a of de){const d=e.querySelector(a);if(d){const g=d.getAttribute("href");if(g){const m=g.match(/\/view\/([A-Z0-9_]+-\d+)/);if(m&&m[1])return m[1]}const b=(i=d.textContent)==null?void 0:i.trim();if(b&&this.validateIssueKey(b))return b}}const r=(e.textContent||"").match(/\b([A-Z0-9_]+-\d+)\b/);return r&&r[1]?r[1]:null}static createPendingButton(e=!1){const t=document.createElement("button");return t.className=`bue-button bue-button--icon bue-button--ghost ${y.className}`,e&&t.classList.add(y.activeClassName),t.innerHTML=e?y.icon.pending:y.icon.normal,t.title=e?y.tooltip.pending:y.tooltip.normal,t.setAttribute("aria-label",e?y.tooltip.pending:y.tooltip.normal),t.setAttribute("aria-pressed",e.toString()),t.setAttribute("type","button"),this.applyButtonStyles(t),e&&this.updatePendingButton(t,!0),t}static applyButtonStyles(e){const t={position:"absolute",top:"8px",right:"40px",width:"22px",height:"22px",borderRadius:"11px",fontSize:"0",pointerEvents:"auto",boxShadow:"var(--shadow-sm, 0 2px 4px rgba(0, 0, 0, 0.1))",borderColor:"var(--text-secondary)",color:"var(--text-secondary, #666)"};Object.assign(e.style,t),e.addEventListener("keydown",o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),o.stopPropagation(),e.click())})}static applyPendingVisual(e,t){var o;if(t){e.classList.add(j.pending),e.classList.remove(j.normal),e.style.borderLeft="4px solid var(--borderColorWeak, #9e8012)",e.style.backgroundColor="var(--backgroundColorWeak, rgba(76, 71, 54, 0.6))",e.style.boxShadow="0 0 0 1px rgba(158, 128, 18, 0.3), var(--shadowModuleSmall, 0 2px 6px 0 rgba(0, 0, 0, 0.8))";const s=e.querySelector(".card-summary");if(s){s.style.display="none";const a=(o=s.textContent)==null?void 0:o.trim();a&&this.setupCustomTooltip(e,a)}const r=e.querySelector(".card-status");r&&(r.style.display="none");const i=document.createElement("style");i.textContent=`
        .issue-card--pending [data-tooltip]:before,
        .issue-card--pending [data-tooltip]:after,
        .issue-card--pending .simptip-position-top:before,
        .issue-card--pending .simptip-position-top:after {
          background-color: var(--backgroundColorSchemeBase, #333333) !important;
          color: var(--textColorDefault, #dadada) !important;
          opacity: 0.95 !important;
        }
        .issue-card--pending .calendar__ttip {
          background-color: var(--backgroundColorSchemeBase, #333333) !important;
          color: var(--textColorDefault, #dadada) !important;
          opacity: 0.95 !important;
        }
      `,document.querySelector("#pending-tooltip-fix")||(i.id="pending-tooltip-fix",document.head.appendChild(i))}else{e.classList.remove(j.pending),e.classList.add(j.normal),e.style.borderLeft="",e.style.backgroundColor="",e.style.boxShadow="";const s=e.querySelector(".card-summary");s&&(s.style.display="");const r=e.querySelector(".card-status");r&&(r.style.display=""),this.cleanupCustomTooltip(e)}}static addPendingButton(e,t,o){if(!e||typeof o!="function")return null;const s=e.querySelector(`.${y.className}`);if(s)return c.log(`[PendingDom] Button already exists in card: ${e.className}`),s;c.log(`[PendingDom] Checking direct parent for existing button: ${e.className}`);const r=e.parentElement;if(r){const a=r.querySelectorAll(`.${y.className}`);for(const d of a)if(d.closest("li.css-1og413z-box.card, .css-1og413z-box.card")===e)return c.log("[PendingDom] Button already exists in same card - ABORTING"),null}c.log(`[PendingDom] Direct parent check passed for card: ${e.className}`),getComputedStyle(e).position==="static"&&(e.style.position="relative");const i=this.createPendingButton(t);return i.addEventListener("click",a=>{c.log(`[PendingDom] Button clicked for card: ${e.className}`),a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),setTimeout(()=>{try{o(),c.log("[PendingDom] Button onClick executed successfully")}catch(d){n.issuePending.error("Error in onClick:",d)}},10)},!0),i.addEventListener("dragstart",a=>(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1)),i.addEventListener("drag",a=>(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1)),e.appendChild(i),c.log(`[PendingDom] Added button to card: ${e.className}`),i}static updatePendingButton(e,t){t?(e.classList.add(y.activeClassName),e.innerHTML=y.icon.pending,e.title=y.tooltip.pending,e.setAttribute("aria-label",y.tooltip.pending),e.setAttribute("aria-pressed","true"),e.style.backgroundColor="var(--bg-warning-element, #ffc10714)",e.style.borderColor="var(--warning-color, #ffc107)",e.style.color="var(--warning-color, #fff)"):(e.classList.remove(y.activeClassName),e.innerHTML=y.icon.normal,e.title=y.tooltip.normal,e.setAttribute("aria-label",y.tooltip.normal),e.setAttribute("aria-pressed","false"),e.style.backgroundColor="transparent",e.style.borderColor="var(--text-secondary, #e9ecef)",e.style.color="var(--text-secondary, #666)")}static removePendingButton(e){const t=e.querySelector(`.${y.className}`);t&&t.remove()}static validateIssueKey(e){return!e||typeof e!="string"||e.length>100||/<|>|&|'|"|\n|\r|\t|javascript:|data:/.test(e)?!1:/^[A-Z0-9_]+-\d+$/.test(e)}static getMutationObserverConfig(){return{childList:!0,subtree:!0,attributes:!1,characterData:!1}}static isCompletedOrPostCompletionStatus(e){var t;try{const o=[".css-hrpltn-col",'[data-testid="board-column"]',".board-column",'[class*="column"]',".lane"];let s=null;for(const m of o)if(s=e.closest(m),s)break;if(!s)return n.issuePending.debug("Card not in a valid column (tried all selectors)"),!1;if(s.getAttribute("data-statusid")==="4")return!0;const i=["h3.SlotHead",".status-name",'[class*="status"]',"h1, h2, h3, h4, h5, h6",'[class*="title"]','[class*="header"]'];let a=null;for(const m of i)if(a=s.querySelector(m),a)break;const d=((t=a==null?void 0:a.textContent)==null?void 0:t.trim())||"";return["完了","Done","Completed","Complete","Closed"].some(m=>d.includes(m))}catch(o){return n.issuePending.error("Error in isCompletedOrPostCompletionStatus:",o),!1}}static findNewIssueCards(e,t){const o=[];for(const s of e)if(s.type==="childList"){for(const r of s.addedNodes)if(r.nodeType===Node.ELEMENT_NODE){const i=r;c.log(`[PendingDom] findNewIssueCards() check new item: ${i.className} ${i.tagName}`);const a=this.findIssueCards(i);for(const d of a)t.has(d)||(c.log(`[PendingDom] Found new card: ${d.className}`),o.push(d))}}return o}static createCustomTooltip(e){const t=document.createElement("div");return t.className=$.className,t.textContent=e,Object.assign(t.style,{position:"absolute",zIndex:"10000",background:"var(--backgroundColorSchemeBase, #333333)",color:"var(--textColorDefault, #dadada)",padding:"8px 12px",borderRadius:"4px",fontSize:"13px",lineHeight:"1.4",width:`${$.width}px`,overflowWrap:"break-word",whiteSpace:"normal",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.3)",border:"1px solid var(--borderColorDefault, rgba(78, 78, 78, 0.6))",opacity:"0",transform:"translateY(10px)",transition:"opacity 0.2s ease, transform 0.2s ease",pointerEvents:"none",visibility:"visible",display:"block"}),t}static positionTooltip(e,t){const o=t.getBoundingClientRect(),s=window.innerWidth,r=window.pageYOffset||document.documentElement.scrollTop,i=window.pageXOffset||document.documentElement.scrollLeft,a=$.width,d=50;let g=o.left+i+o.width/2-a/2,b=o.bottom+r+8;g<i+8&&(g=i+8);const m=i+s-8;g+a>m&&(g=m-a,g<i+8&&(g=i+8)),b+d>r+window.innerHeight-8&&(b=o.top+r-d-8),e.style.left=`${g}px`,e.style.top=`${b}px`}static setupCustomTooltip(e,t){let o=null,s=null,r=null;const i=()=>{r&&(clearTimeout(r),r=null),s=setTimeout(()=>{const d=document.querySelector(`.${$.className}`);d&&d.remove(),o=this.createCustomTooltip(t),document.body.appendChild(o),this.positionTooltip(o,e),requestAnimationFrame(()=>{o&&(o.style.opacity="1",o.style.transform="translateY(0)")})},$.delay)},a=()=>{s&&(clearTimeout(s),s=null),o&&(r=setTimeout(()=>{o&&(o.remove(),o=null)},100))};e.addEventListener("mouseenter",i),e.addEventListener("mouseleave",a),e._tooltipCleanup=()=>{s&&clearTimeout(s),r&&clearTimeout(r),o&&o.remove(),e.removeEventListener("mouseenter",i),e.removeEventListener("mouseleave",a)}}static cleanupCustomTooltip(e){const t=e._tooltipCleanup;t&&(t(),delete e._tooltipCleanup);const o=document.querySelector(`.${$.className}`);o&&o.remove()}}class ue{constructor(){h(this,"observer",null);h(this,"pendingStore",new Map);h(this,"issueCardMap",new Map);h(this,"projectKey",null);h(this,"settings",null);n.issuePending.debug("constructor()")}async init(){var e;try{const t=c.getPageInfo();if(t.type!=="board"){c.log("IssuePendingFeature: Not a board page, skipping initialization");return}if(this.projectKey=t.projectKey||null,!this.projectKey){c.log("IssuePendingFeature: No project key found");return}if(c.log(`IssuePendingFeature: Initializing for project ${this.projectKey}`),await this.loadSettings(),!((e=this.settings)!=null&&e.enabled)){c.log("IssuePendingFeature: Feature is disabled, skipping");return}this.setupSettingsWatcher(),await this.loadPendingData(),this.scheduleButtonAddition(),this.observeIssueCards(),n.issuePending.info("Initialization completed")}catch(t){n.issuePending.error("Failed to initialize:",t)}}async loadSettings(){try{const e=await C.getSettings();this.settings=e.issuePending,n.issuePending.debug("Settings loaded:",this.settings)}catch(e){n.issuePending.error("Failed to load settings:",e),this.settings={enabled:!0,autoResolve:!0}}}setupSettingsWatcher(){C.onSettingsChanged(e=>{var o,s;const t=e.issuePending;n.issuePending.debug("Settings changed:",t),!t.enabled&&((o=this.settings)!=null&&o.enabled)&&(n.issuePending.info("Feature disabled, removing buttons"),this.removeAllPendingButtons(),this.disconnect()),t.enabled&&!((s=this.settings)!=null&&s.enabled)&&(n.issuePending.info("Feature enabled, reinitializing"),this.reconnect()),this.settings=t})}destroy(){n.issuePending.debug("destroy()"),this.observer&&(this.observer.disconnect(),this.observer=null),this.pendingStore.clear(),this.issueCardMap.clear(),this.projectKey=null,n.issuePending.info("Destroyed")}removeAllPendingButtons(){document.querySelectorAll(".pending-toggle-button").forEach(t=>t.remove()),n.issuePending.debug("All pending buttons removed")}disconnect(){this.observer&&(this.observer.disconnect(),this.observer=null),n.issuePending.debug("Observer disconnected")}async reconnect(){try{await this.loadPendingData(),this.scheduleButtonAddition(),this.observeIssueCards(),n.issuePending.info("Reconnected successfully")}catch(e){n.issuePending.error("Failed to reconnect:",e)}}async togglePending(e){if(!(!this.projectKey||!P.validateIssueKey(e)))try{const t=await this.isPending(e);if(t)await k.removePendingIssue(this.projectKey,e),this.pendingStore.delete(e);else{const o={issueKey:e,projectKey:this.projectKey};await k.setPendingIssue(this.projectKey,o),this.pendingStore.set(e,o)}await this.updateCardVisualState(e),n.issuePending.info(`Toggled pending state for ${e}, new state: ${!t}`)}catch(t){n.issuePending.error(`Failed to toggle pending state for ${e}:`,t)}}async removePendingState(e){if(!(!this.projectKey||!P.validateIssueKey(e)))try{await k.removePendingIssue(this.projectKey,e),this.pendingStore.delete(e),await this.updateCardVisualState(e),n.issuePending.debug(`Removed pending state for ${e}`)}catch(t){n.issuePending.error(`Failed to remove pending state for ${e}:`,t)}}async isPending(e){if(!this.projectKey||!P.validateIssueKey(e))return!1;try{return await k.isPendingIssue(this.projectKey,e)}catch(t){return n.issuePending.error(`Failed to check pending status for ${e}:`,t),!1}}getPendingIssues(){return Array.from(this.pendingStore.values())}getProjectKey(){return this.projectKey}async loadPendingData(){if(this.projectKey)try{const e=await k.getPendingIssues(this.projectKey);this.pendingStore.clear();for(const t of e)this.pendingStore.set(t.issueKey,t);n.issuePending.debug(`Loaded ${e.length} pending issues`)}catch(e){n.issuePending.error("Failed to load pending data:",e)}}scheduleButtonAddition(){requestAnimationFrame(async()=>{await this.addPendingButtonsToCards(!0),setTimeout(async()=>{await this.addPendingButtonsToCards(!0)},1e3)})}async addPendingButtonsToCards(e=!1){const t=P.findIssueCards();n.issuePending.debug(`Found ${t.length} cards during initialization`);let o=0;for(const s of t){const r=P.extractIssueKey(s);if(r){const i=this.issueCardMap.has(r),a=s.querySelector(".pending-toggle-button");c.log(`[IssuePendingFeature] Processing card ${r}: inMap=${i}, hasButton=${!!a}, forceAdd=${e}`),(e||!i)&&!a?(await this.addPendingButtonToCard(s),o++,c.log(`[IssuePendingFeature] Successfully added button to ${r}`)):c.log(`[IssuePendingFeature] Skipped ${r}: inMap=${i}, hasButton=${!!a}`)}else c.log(`[IssuePendingFeature] Could not extract issue key from card: ${s.className}`)}n.issuePending.info(`Added pending buttons to ${o} new cards (${t.length} total found)`)}async addPendingButtonToCard(e){var r;const t=P.extractIssueKey(e);if(!t){c.log(`[IssuePendingFeature] Failed to extract issue key from card: ${e.className}`);return}c.log(`[IssuePendingFeature] Attempting to add button to ${t}`),this.issueCardMap.set(t,e);let o=await this.isPending(t);c.log(`[IssuePendingFeature] ${t} isPending: ${o}`),o&&((r=this.settings)!=null&&r.autoResolve)&&P.isCompletedOrPostCompletionStatus(e)&&(n.issuePending.info(`Auto-resolving pending state for ${t} (completed or post-completion status)`),await this.removePendingState(t),o=!1),P.addPendingButton(e,o,()=>{this.togglePending(t)})?(P.applyPendingVisual(e,o),n.issuePending.debug(`Successfully added pending button to ${t}`)):n.issuePending.warn(`Failed to add button to ${t} - button creation returned null`)}async updateCardVisualState(e){const t=this.issueCardMap.get(e);if(!t)return;const o=await this.isPending(e),s=t.querySelector(".pending-toggle-button");s&&P.updatePendingButton(s,o),P.applyPendingVisual(t,o)}async refreshCardVisualState(e){const t=P.extractIssueKey(e);if(!t)return;const o=await this.isPending(t);P.applyPendingVisual(e,o),n.issuePending.debug(`Refreshed visual state for ${t}, isPending: ${o}`)}async refreshAllVisibleCards(){const e=document.querySelectorAll(".css-1og413z-box.card, .card"),t=[];e.forEach(o=>{t.push(this.refreshCardVisualState(o))}),await Promise.all(t),n.issuePending.debug(`Refreshed visual state for ${e.length} visible cards`)}observeIssueCards(){this.observer=c.observeChanges(e=>{this.handleMutations(e)})}async handleMutations(e){const t=new Set(this.issueCardMap.values()),o=P.findNewIssueCards(e,t);for(const s of o)await this.addPendingButtonToCard(s);o.length>0&&n.issuePending.debug(`Added buttons to ${o.length} new cards`)}}class ge{constructor(){h(this,"observer",null);h(this,"isInitialized",!1);n.content.debug("[PrFormatAutoInsert] Constructor called")}init(){if(this.isInitialized){n.content.warn("[PrFormatAutoInsert] Already initialized");return}if(n.content.info("[PrFormatAutoInsert] Initializing..."),!this.isPullRequestAddPage()){n.content.debug("[PrFormatAutoInsert] Not a pull request add page");return}const e=this.getProjectKey();if(!e){n.content.debug("[PrFormatAutoInsert] Could not extract project key from URL");return}n.content.info(`[PrFormatAutoInsert] Detected project: ${e}`),this.startObserving(e),this.isInitialized=!0}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.isInitialized=!1,n.content.info("[PrFormatAutoInsert] Destroyed")}updateSettings(){n.content.debug("[PrFormatAutoInsert] Settings updated")}isPullRequestAddPage(){const e=window.location.pathname;return/\/git\/[^/]+\/[^/]+\/pullRequests\/add\//.test(e)}getProjectKey(){const t=window.location.pathname.match(/\/git\/([^/]+)\/[^/]+\/pullRequests\/add\//);return t?t[1]:null}startObserving(e){if(this.getDescriptionEditor()){n.content.debug("[PrFormatAutoInsert] Editor already exists, inserting template immediately"),this.insertTemplate(e);return}this.observer=new MutationObserver(()=>{var s;this.getDescriptionEditor()&&(n.content.debug("[PrFormatAutoInsert] Editor detected, inserting template"),(s=this.observer)==null||s.disconnect(),this.insertTemplate(e))}),this.observer.observe(document.body,{childList:!0,subtree:!0}),n.content.debug("[PrFormatAutoInsert] Started observing for editor appearance")}getDescriptionEditor(){const e=document.querySelector("#description.ProseMirror");if(e)return n.content.debug("[PrFormatAutoInsert] Found ProseMirror editor"),e;const t=document.querySelector("#hidden-description");return t?(n.content.debug("[PrFormatAutoInsert] Found hidden textarea"),t):null}async insertTemplate(e){try{if(!await Y.isEnabled()){n.content.debug("[PrFormatAutoInsert] Feature is disabled");return}const o=await Y.getProjectTemplate(e);if(!o){n.content.debug(`[PrFormatAutoInsert] No template found for project: ${e}`);return}const s=this.getDescriptionEditor();if(!s){n.content.warn("[PrFormatAutoInsert] Editor not found when trying to insert template");return}if(!this.isEditorEmpty(s)){n.content.debug("[PrFormatAutoInsert] Editor is not empty, skipping template insertion");return}s.classList.contains("ProseMirror")?this.insertToProseMirror(s,o):s.tagName==="TEXTAREA"&&(s.value=o),s.focus(),n.content.info(`[PrFormatAutoInsert] Template inserted for project: ${e}`)}catch(t){n.content.error("[PrFormatAutoInsert] Failed to insert template:",t)}}isEditorEmpty(e){var t;if(e.classList.contains("ProseMirror")){const o=e.querySelector("p");return o?(((t=o.textContent)==null?void 0:t.trim())||"")===""||o.classList.contains("empty-node"):!0}else if(e.tagName==="TEXTAREA")return e.value.trim()==="";return!0}insertToProseMirror(e,t){const o=t.split(`
`);e.innerHTML="",o.forEach(r=>{const i=document.createElement("p");r.trim()===""?i.innerHTML="<br>":i.textContent=r,e.appendChild(i)});const s=document.querySelector("#hidden-description");s&&(s.value=t,s.dispatchEvent(new Event("input",{bubbles:!0})))}}class fe{constructor(){h(this,"settings",null);h(this,"features",new Map);this.init(),this.setupMessageListener()}getFeature(e){return this.features.get(e)||null}async init(){try{if(!c.isBacklogPage()){c.log("Not a Backlog page, skipping initialization");return}c.log("Initializing Backlog Usability Enhance"),this.injectDesignSystemCSS(),await this.loadSettings(),this.watchSettingsChanges(),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.onDOMReady()):this.onDOMReady(),c.log("Initialization completed")}catch(e){n.error("Failed to initialize Backlog Usability Enhance:",e)}}async loadSettings(){this.settings=await C.getSettings(),c.log("Settings loaded:",this.settings)}watchSettingsChanges(){C.onSettingsChanged(e=>{c.log("Settings changed (from storage):",e),this.handleSettingsChange(e)})}setupMessageListener(){typeof chrome<"u"&&chrome.runtime&&(chrome.runtime.onMessage.addListener((e,t,o)=>(this.handleExtensionMessage(e,t,o),!0)),n.content.info("Extension message listener setup complete"))}async handleExtensionMessage(e,t,o){try{if(n.content.debug("Received extension message:",e),!e||typeof e.type!="string"){n.content.warn("Invalid message format:",e),o({success:!1,error:"Invalid message format"});return}switch(e.type){case"SETTINGS_CHANGED":{const s=e;if(!s.settings){n.content.warn("Missing settings in SETTINGS_CHANGED message"),o({success:!1,error:"Missing settings data"});return}n.content.info("Settings changed (from popup):",s.settings),this.handleSettingsChange(s.settings),o({success:!0});break}default:n.content.warn("Unknown message type:",e.type),o({success:!1,error:"Unknown message type"})}}catch(s){n.content.error("Error in handleExtensionMessage:",s);const r=s instanceof Error?s.message:"Unknown error";o({success:!1,error:r})}}handleSettingsChange(e){const t=this.settings;this.settings=e,this.updateFeatureSettings(t,e),this.applySettings()}updateFeatureSettings(e,t){if(!e)return;const o={boardAccordion:e.boardAccordion.enabled!==t.boardAccordion.enabled,shortcutKeys:e.shortcutKeys.enabled!==t.shortcutKeys.enabled,issuePending:e.issuePending.enabled!==t.issuePending.enabled,prFormat:e.prFormat.enabled!==t.prFormat.enabled};if(o.boardAccordion){const s=this.features.get("boardAccordion");s&&(s.destroy(),this.features.delete("boardAccordion"),c.log("Destroyed boardAccordion feature due to enabled status change"))}if(o.shortcutKeys){const s=this.features.get("shortcutKeys");s&&(s.destroy(),this.features.delete("shortcutKeys"),c.log("Destroyed shortcutKeys feature due to enabled status change"))}if(o.issuePending){const s=this.features.get("issuePending");s&&(s.destroy(),this.features.delete("issuePending"),c.log("Destroyed issuePending feature due to enabled status change"))}if(o.prFormat){const s=this.features.get("prFormat");s&&(s.destroy(),this.features.delete("prFormat"),c.log("Destroyed prFormat feature due to enabled status change"))}for(const[s,r]of this.features)if(r.updateSettings)try{r.updateSettings(t),c.log(`Updated settings for feature '${s}'`)}catch(i){n.error(`Failed to update settings for feature '${s}':`,i)}}onDOMReady(){if(!this.settings){c.log("Settings not loaded yet");return}c.log("DOM ready, applying settings"),this.applySettings(),this.watchPageChanges()}applySettings(){if(!this.settings)return;const e=c.getPageInfo();c.log("Current page info:",e),this.toggleFeature("boardAccordion",this.settings.boardAccordion.enabled,()=>{if(e.type==="board"){c.log("Initializing board accordion feature");const t=new le;t.init(),this.features.set("boardAccordion",{init:()=>t.init(),destroy:()=>t.destroy(),updateSettings:()=>{},_instance:t})}}),this.toggleFeature("shortcutKeys",this.settings.shortcutKeys.enabled,()=>{c.log("Initializing shortcut keys feature");const t=new z;t.init(),this.features.set("shortcutKeys",{init:()=>t.init(),destroy:()=>t.destroy()})}),this.toggleFeature("issuePending",this.settings.issuePending.enabled,()=>{if(e.type==="board"){c.log("Initializing issue pending feature");const t=new ue;t.init(),this.features.set("issuePending",{init:()=>t.init(),destroy:()=>t.destroy(),_instance:t})}}),this.toggleFeature("prFormat",this.settings.prFormat.enabled,()=>{if(e.type==="git"){c.log("Initializing PR format auto insert feature");const t=new ge;t.init(),this.features.set("prFormat",{init:()=>t.init(),destroy:()=>t.destroy(),updateSettings:()=>t.updateSettings(),_instance:t})}})}toggleFeature(e,t,o){const s=this.features.get(e);if(t){if(!s)try{o(),c.log(`Feature '${e}' enabled`)}catch(r){n.error(`Failed to enable feature '${e}':`,r)}}else if(s)try{s.destroy(),this.features.delete(e),c.log(`Feature '${e}' disabled`)}catch(r){n.error(`Failed to disable feature '${e}':`,r)}}watchPageChanges(){let e=window.location.href;c.observeChanges(()=>{const t=window.location.href;t!==e&&(e=t,c.log("Page changed:",t),setTimeout(()=>{this.applySettings()},100))})}injectDesignSystemCSS(){try{if(document.querySelector("#bue-design-system")){n.content.debug("Design system CSS already injected");return}const e=`
        /* Backlog Usability Enhance - Design System Variables */
        :root {
          /* プライマリーカラー */
          --primary-color: #007bff;
          --primary-hover: #0056b3;
          --primary-active: #004494;
          --primary-light: #f0f7ff;
          
          /* セカンダリーカラー */
          --secondary-color: #6c757d;
          --secondary-hover: #545b62;
          --secondary-light: #f8f9fa;
          
          /* アクセントカラー */
          --success-color: #28a745;
          --success-hover: #218838;
          --warning-color: #ffc107;
          --warning-hover: #e0a800;
          --error-color: #dc3545;
          --error-hover: #c82333;
          
          /* ニュートラルカラー */
          --gray-50: #f8f9fa;
          --gray-100: #f0f0f0;
          --gray-200: #e9ecef;
          --gray-300: #dee2e6;
          --gray-400: #ced4da;
          --gray-500: #adb5bd;
          --gray-600: #6c757d;
          --gray-700: #495057;
          --gray-800: #343a40;
          --gray-900: #212529;
          
          /* テキストカラー */
          --text-primary: #333;
          --text-secondary: #666;
          --text-muted: #999;
          --text-inverse: #fff;
          
          /* 背景色 */
          --bg-primary: #ffffff;
          --bg-secondary: #f8f9fa;
          --bg-tertiary: #f5f5f5;
          
          /* ボーダー */
          --border-color: #e9ecef;
          --border-radius-sm: 3px;
          --border-radius: 4px;
          --border-radius-md: 6px;
          --border-radius-lg: 8px;
          
          /* スペーシング */
          --spacing-xs: 2px;
          --spacing-sm: 4px;
          --spacing-md: 8px;
          --spacing-lg: 12px;
          --spacing-xl: 16px;
          --spacing-xxl: 24px;
          
          /* フォント */
          --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          --font-size-xs: 10px;
          --font-size-sm: 11px;
          --font-size-base: 13px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 600;
          
          /* 行間 */
          --line-height-tight: 1.2;
          --line-height-base: 1.4;
          --line-height-relaxed: 1.6;
          
          /* シャドウ */
          --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
          --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
          --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.15);
          
          /* トランジション */
          --transition-fast: 0.15s ease;
          --transition-base: 0.2s ease;
          --transition-slow: 0.3s ease;
        }

        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
          :root {
            --primary-color: #60a5fa;
            --primary-hover: #3b82f6;
            --primary-active: #2563eb;
            --primary-light: #1e3a8a;
            
            --success-color: #10b981;
            --success-hover: #059669;
            --warning-color: #f59e0b;
            --warning-hover: #d97706;
            --error-color: #ef4444;
            --error-hover: #dc2626;
            
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --text-inverse: #000;
            
            --bg-primary: #2a2a2a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #404040;
            
            --border-color: #404040;
            
            --gray-50: #525252;
            --gray-100: #404040;
            --gray-200: #374151;
            --gray-300: #4b5563;
            --gray-400: #6b7280;
            --gray-500: #9ca3af;
            --gray-600: #d1d5db;
            --gray-700: #e5e7eb;
            --gray-800: #f3f4f6;
            --gray-900: #f9fafb;
          }
        }

        /* ベースボタンスタイル */
        .bue-button {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--spacing-sm) var(--spacing-lg);
          font-family: var(--font-family);
          font-size: var(--font-size-base);
          font-weight: var(--font-weight-medium);
          line-height: var(--line-height-tight);
          text-decoration: none;
          border: 1px solid transparent;
          border-radius: var(--border-radius);
          cursor: pointer;
          transition: all var(--transition-base);
          user-select: none;
          white-space: nowrap;
          background: none;
          outline: none;
        }

        .bue-button:focus {
          outline: 2px solid var(--primary-color);
          outline-offset: 2px;
        }

        .bue-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          pointer-events: none;
        }

        /* ボタンバリエーション */
        .bue-button--primary {
          background-color: var(--primary-color);
          color: var(--text-inverse);
          border-color: var(--primary-color);
        }

        .bue-button--primary:hover:not(:disabled) {
          background-color: var(--primary-hover);
          border-color: var(--primary-hover);
        }

        .bue-button--secondary {
          background-color: var(--secondary-color);
          color: var(--text-inverse);
          border-color: var(--secondary-color);
        }

        .bue-button--secondary:hover:not(:disabled) {
          background-color: var(--secondary-hover);
          border-color: var(--secondary-hover);
        }

        .bue-button--ghost {
          background-color: transparent;
          color: var(--text-primary);
          border-color: var(--border-color);
        }

        .bue-button--ghost:hover:not(:disabled) {
          background-color: var(--gray-50);
          color: var(--text-primary);
        }

        .bue-button--minimal {
          background-color: transparent;
          color: var(--text-secondary);
          border: none;
          padding: var(--spacing-xs) var(--spacing-sm);
        }

        .bue-button--minimal:hover:not(:disabled) {
          background-color: var(--gray-100);
          color: var(--text-primary);
        }

        /* ボタンサイズ */
        .bue-button--xs {
          padding: var(--spacing-xs) var(--spacing-sm);
          font-size: var(--font-size-xs);
          border-radius: var(--border-radius-sm);
        }

        .bue-button--sm {
          padding: var(--spacing-sm) var(--spacing-md);
          font-size: var(--font-size-sm);
          border-radius: var(--border-radius-sm);
        }

        .bue-button--lg {
          padding: var(--spacing-lg) var(--spacing-xxl);
          font-size: var(--font-size-lg);
          border-radius: var(--border-radius-md);
        }

        /* アイコンボタン */
        .bue-button--icon {
          width: 32px;
          height: 32px;
          padding: 0;
          border-radius: var(--border-radius);
        }

        .bue-button--icon.bue-button--sm {
          width: 24px;
          height: 24px;
        }

        .bue-button--icon.bue-button--lg {
          width: 40px;
          height: 40px;
        }

        /* フォーカス管理 */
        .bue-focus-visible:focus {
          outline: 2px solid var(--primary-color);
          outline-offset: 2px;
        }

        /* モーションを避けたいユーザー向け */
        @media (prefers-reduced-motion: reduce) {
          .bue-button {
            transition: none !important;
          }
        }
      `,t=document.createElement("style");t.id="bue-design-system",t.textContent=e,document.head.insertBefore(t,document.head.firstChild),n.content.info("Design system CSS injected successfully")}catch(e){n.content.error("Failed to inject design system CSS:",e)}}destroy(){c.log("Destroying Backlog Usability Enhance");for(const[t,o]of this.features)try{o.destroy(),c.log(`Feature '${t}' destroyed`)}catch(s){n.error(`Failed to destroy feature '${t}':`,s)}this.features.clear();const e=document.querySelector("#bue-design-system");e&&e.remove()}}const Z=new fe;window.__backlog_usability_enhance__=Z,window.__backlog_usability_enhance_dev__=!0,window.addEventListener("beforeunload",()=>{Z.destroy()})})();
