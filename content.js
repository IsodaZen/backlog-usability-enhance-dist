var Pe=Object.defineProperty;var Te=(I,x,E)=>x in I?Pe(I,x,{enumerable:!0,configurable:!0,writable:!0,value:E}):I[x]=E;var m=(I,x,E)=>Te(I,typeof x!="symbol"?x+"":x,E);(function(){"use strict";var I=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function x(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}var E={exports:{}};(function(c){(function(e,t){c.exports?c.exports=t():e.log=t()})(I,function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),o=["trace","debug","info","warn","error"],r={},i=null;function a(p,v){var g=p[v];if(typeof g.bind=="function")return g.bind(p);try{return Function.prototype.bind.call(g,p)}catch{return function(){return Function.prototype.apply.apply(g,[p,arguments])}}}function l(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function u(p){return p==="debug"&&(p="log"),typeof console===t?!1:p==="trace"&&n?l:console[p]!==void 0?a(console,p):console.log!==void 0?a(console,"log"):e}function h(){for(var p=this.getLevel(),v=0;v<o.length;v++){var g=o[v];this[g]=v<p?e:this.methodFactory(g,p,this.name)}if(this.log=this.debug,typeof console===t&&p<this.levels.SILENT)return"No console available for logging"}function y(p){return function(){typeof console!==t&&(h.call(this),this[p].apply(this,arguments))}}function W(p,v,g){return u(p)||y.apply(this,arguments)}function q(p,v){var g=this,M,Y,F,T="loglevel";typeof p=="string"?T+=":"+p:typeof p=="symbol"&&(T=void 0);function Ce(f){var C=(o[f]||"silent").toUpperCase();if(!(typeof window===t||!T)){try{window.localStorage[T]=C;return}catch{}try{window.document.cookie=encodeURIComponent(T)+"="+C+";"}catch{}}}function Q(){var f;if(!(typeof window===t||!T)){try{f=window.localStorage[T]}catch{}if(typeof f===t)try{var C=window.document.cookie,j=encodeURIComponent(T),te=C.indexOf(j+"=");te!==-1&&(f=/^([^;]+)/.exec(C.slice(te+j.length+1))[1])}catch{}return g.levels[f]===void 0&&(f=void 0),f}}function we(){if(!(typeof window===t||!T)){try{window.localStorage.removeItem(T)}catch{}try{window.document.cookie=encodeURIComponent(T)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function O(f){var C=f;if(typeof C=="string"&&g.levels[C.toUpperCase()]!==void 0&&(C=g.levels[C.toUpperCase()]),typeof C=="number"&&C>=0&&C<=g.levels.SILENT)return C;throw new TypeError("log.setLevel() called with invalid level: "+f)}g.name=p,g.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},g.methodFactory=v||W,g.getLevel=function(){return F??Y??M},g.setLevel=function(f,C){return F=O(f),C!==!1&&Ce(F),h.call(g)},g.setDefaultLevel=function(f){Y=O(f),Q()||g.setLevel(f,!1)},g.resetLevel=function(){F=null,we(),h.call(g)},g.enableAll=function(f){g.setLevel(g.levels.TRACE,f)},g.disableAll=function(f){g.setLevel(g.levels.SILENT,f)},g.rebuild=function(){if(i!==g&&(M=O(i.getLevel())),h.call(g),i===g)for(var f in r)r[f].rebuild()},M=O(i?i.getLevel():"WARN");var ee=Q();ee!=null&&(F=O(ee)),h.call(g)}i=new q,i.getLogger=function(v){if(typeof v!="symbol"&&typeof v!="string"||v==="")throw new TypeError("You must supply a name when creating a logger.");var g=r[v];return g||(g=r[v]=new q(v,i.methodFactory)),g};var V=typeof window!==t?window.log:void 0;return i.noConflict=function(){return typeof window!==t&&window.log===i&&(window.log=V),i},i.getLoggers=function(){return r},i.default=i,i})})(E);var ne=E.exports;const P=x(ne),Z={level:"error",prefix:"[Backlog Enhancement]",timestamp:!0},k={},K=new Map;function oe(c){P.setLevel(c)}function U(c,e){const t=K.get(c);t&&t.setLevel(e),k[c]=e}function se(c){return k[c]||"info"}function re(){return{...k}}function ie(c){const e=K.get(c);if(e)return e;const t=P.getLogger(c),n=k[c]||"info";t.setLevel(n);const o=t.methodFactory;return t.methodFactory=function(r,i,a){const l=o(r,i,a);return function(...u){const h=`[${new Date().toISOString()}]`,y=`${Z.prefix}`,W=`[${r.toUpperCase()}]`,q=`[${c.charAt(0).toUpperCase()+c.slice(1)}]`,V=[`${h} ${y} ${W} ${q}`,...u].filter(Boolean);l(...V)}},t.setLevel(t.getLevel()),K.set(c,t),t}function z(){if(typeof window>"u"||typeof chrome>"u")return!0;try{return window.location.hostname==="localhost"||window.location.hostname.includes("dev")||chrome.runtime.getManifest().version.includes("dev")}catch{return!0}}function ae(c){const e=P.methodFactory;P.methodFactory=function(t,n,o){const r=e(t,n,o);return function(...i){const a=c.timestamp?`[${new Date().toISOString()}]`:"",l=c.prefix?`${c.prefix}`:"",u=`[${t.toUpperCase()}]`,h=[`${a} ${l} ${u}`,...i].filter(Boolean);r(...h)}},P.setLevel(P.getLevel())}function le(c){const e={...Z,...c};z()?e.level="debug":e.level="warn",ae(e),oe(e.level),P.info("Logger initialized",{level:e.level,isDev:z()})}function A(c){const e=ie(c);return{debug:(...t)=>e.debug(...t),info:(...t)=>e.info(...t),warn:(...t)=>e.warn(...t),error:(...t)=>e.error(...t)}}const s={debug:(...c)=>P.debug(...c),info:(...c)=>P.info(...c),warn:(...c)=>P.warn(...c),error:(...c)=>P.error(...c),boardAccordion:A("boardAccordion"),issuePending:A("issuePending"),shortcutKeys:A("shortcutKeys"),storage:A("storage"),backlog:A("backlog"),background:A("background"),options:A("options"),content:A("content"),popup:A("popup")},ce={setLevel:U,getLevel:se,showAll:()=>{console.table(re())},enable:c=>{U(c,"debug"),console.log(`✅ ${c} logging enabled (debug level)`)},disable:c=>{U(c,"silent"),console.log(`❌ ${c} logging disabled`)},enableAll:()=>{Object.keys(k).forEach(c=>{U(c,"debug")}),console.log("✅ All feature logging enabled")},disableAll:()=>{Object.keys(k).forEach(c=>{U(c,"error")}),console.log("❌ All feature logging disabled (error only)")}};typeof window<"u"&&z()&&(window.__backlogLoggerControl__=ce),le();class d{static isBacklogPage(){const e=window.location.hostname;return e.includes(".backlog.jp")||e.includes(".backlog.com")}static getPageInfo(){const e=window.location.href,t=window.location.pathname;let n;const o=t.match(/\/view\/([A-Z0-9_]+)/),r=t.match(/\/board\/([A-Z0-9_]+)/);o?n=o[1]:r&&(n=r[1]);let i="other";t.includes("/ProjectBoard")||t.includes("/board/")?i="board":t.includes("/view/")&&!t.includes("/git/")?i="issue":t.includes("/projects/")?i="project":t.includes("/wiki/")?i="wiki":t.includes("/git/")&&(i="git");let a;if(i==="issue"){const l=t.match(/\/view\/([A-Z0-9_]+-\d+)/);a=l?l[1]:void 0}return{type:i,projectKey:n,issueKey:a,url:e}}static waitForElement(e,t=5e3){return new Promise(n=>{const o=document.querySelector(e);if(o){n(o);return}const r=new MutationObserver(()=>{const i=document.querySelector(e);i&&(r.disconnect(),n(i))});r.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{r.disconnect(),n(null)},t)})}static findElementByCandidates(e){for(const t of e){const n=document.querySelector(t);if(n)return n}return null}static findElementsByCandidates(e){for(const t of e){const n=Array.from(document.querySelectorAll(t));if(n.length>0)return n}return[]}static observeChanges(e,t={childList:!0,subtree:!0}){const n=new MutationObserver(e);return n.observe(document.body,t),n}static log(e,...t){window.__backlog_usability_enhance_dev__&&s.backlog.debug(e,...t)}}const _={boardAccordion:{enabled:!0},shortcutKeys:{enabled:!0},issuePending:{enabled:!0,autoResolve:!0},prFormat:{enabled:!0,projectTemplates:{}},commentUrlCopy:{enabled:!0}};class w{static async getSettings(){try{const t=(await chrome.storage.sync.get(this.SETTINGS_KEY))[this.SETTINGS_KEY];return t?this.mergeWithDefaults(t):_}catch(e){return s.storage.error("Failed to get settings:",e),_}}static async saveSettings(e){try{await chrome.storage.sync.set({[this.SETTINGS_KEY]:e})}catch(t){throw s.storage.error("Failed to save settings:",t),t}}static onSettingsChanged(e){chrome.storage.onChanged.addListener((t,n)=>{if(n==="sync"&&t[this.SETTINGS_KEY]){const o=t[this.SETTINGS_KEY].newValue;o&&e(this.mergeWithDefaults(o))}})}static mergeWithDefaults(e){return{boardAccordion:{..._.boardAccordion,...e.boardAccordion},shortcutKeys:{..._.shortcutKeys,...e.shortcutKeys},issuePending:{..._.issuePending,...e.issuePending},prFormat:{..._.prFormat,...e.prFormat},commentUrlCopy:{..._.commentUrlCopy,...e.commentUrlCopy}}}}m(w,"SETTINGS_KEY","backlog_usability_enhance_settings");class B{static async get(e){try{return!chrome.storage||!chrome.storage.local?(s.storage.warn("Extension context invalidated, skipping storage access"),null):(await chrome.storage.local.get(e))[e]||null}catch(t){return t instanceof Error&&t.message.includes("Extension context invalidated")?(s.storage.warn(`Extension context invalidated for key: ${e}`),null):(s.storage.error(`Failed to get local storage data for key: ${e}`,t),null)}}static async set(e,t){try{if(!chrome.storage||!chrome.storage.local){s.storage.warn("Extension context invalidated, skipping storage save");return}await chrome.storage.local.set({[e]:t})}catch(n){if(n instanceof Error&&n.message.includes("Extension context invalidated")){s.storage.warn(`Extension context invalidated for key: ${e}`);return}throw s.storage.error(`Failed to set local storage data for key: ${e}`,n),n}}static async remove(e){try{await chrome.storage.local.remove(e)}catch(t){throw s.storage.error(`Failed to remove local storage data for key: ${e}`,t),t}}}class X{static async getProjectTemplate(e){try{return(await w.getSettings()).prFormat.projectTemplates[e]||null}catch(t){return s.storage.error("Failed to get project template:",{projectKey:e,error:t}),null}}static async setProjectTemplate(e,t){try{const n=await w.getSettings();n.prFormat.projectTemplates[e]=t,await w.saveSettings(n),s.storage.info("Project template saved:",{projectKey:e})}catch(n){throw s.storage.error("Failed to save project template:",{projectKey:e,error:n}),n}}static async removeProjectTemplate(e){try{const t=await w.getSettings();delete t.prFormat.projectTemplates[e],await w.saveSettings(t),s.storage.info("Project template removed:",{projectKey:e})}catch(t){throw s.storage.error("Failed to remove project template:",{projectKey:e,error:t}),t}}static async getAllProjectTemplates(){try{return(await w.getSettings()).prFormat.projectTemplates}catch(e){return s.storage.error("Failed to get all project templates:",e),{}}}static async isEnabled(){try{return(await w.getSettings()).prFormat.enabled}catch(e){return s.storage.error("Failed to get PR format enabled status:",e),!1}}static async setEnabled(e){try{const t=await w.getSettings();t.prFormat.enabled=e,await w.saveSettings(t),s.storage.info("PR format enabled status updated:",{enabled:e})}catch(t){throw s.storage.error("Failed to update PR format enabled status:",{enabled:e,error:t}),t}}}class de{constructor(){m(this,"observer",null);m(this,"keyboardHandler");m(this,"debounceTimeout",null);m(this,"abortController",new AbortController);m(this,"config",{COLLAPSED_WIDTH:"72px",BUTTON_DELAY:500,INIT_DELAY:1e3});this.keyboardHandler=this.handleKeyboardShortcuts.bind(this)}init(){if(s.boardAccordion.info("Initializing"),d.getPageInfo().type!=="board"){s.boardAccordion.debug("Not a board page, skipping");return}setTimeout(()=>{this.addCollapseButtons(),this.setupKeyboardShortcuts()},this.config.INIT_DELAY),this.observeChanges()}destroy(){s.boardAccordion.info("Destroying"),this.observer&&(this.observer.disconnect(),this.observer=null),this.debounceTimeout&&(clearTimeout(this.debounceTimeout),this.debounceTimeout=null),this.abortController.abort(),this.abortController=new AbortController,document.removeEventListener("keydown",this.keyboardHandler),this.removeCollapseButtons()}addCollapseButtons(){const t=document.querySelectorAll('.css-hrpltn-col, [data-testid="board-column"], .board-column, [class*="column"], .lane');if(t.length>0&&s.boardAccordion.debug(`Found ${t.length} columns using optimized selector`),t.length===0){s.boardAccordion.warn("No status columns found");return}s.boardAccordion.info(`Found ${t.length} status columns`);const n=[];t.forEach((o,r)=>{const i=o.querySelector('.css-ujzck4-row, [class*="header"], [class*="title"], h1, h2, h3, h4, h5, h6');if(!i||i.querySelector(".collapse-button"))return;const a=this.createCollapseButton();n.push({column:o,button:a,index:r});const l=i.querySelector('h3.SlotHead, h3, h2, h1, [class*="title"], [class*="header"]');if(l){l.appendChild(a);const u=o.querySelector(".css-15rua0m-box.SlotBox");u&&this.setupHeaderClickExpand(u,o,a,r),this.restoreColumnState(o,a)}else{i.appendChild(a);const u=o.querySelector(".css-15rua0m-box.SlotBox");u?this.setupHeaderClickExpand(u,o,a,r):this.setupHeaderClickExpand(i,o,a,r),this.restoreColumnState(o,a)}}),requestAnimationFrame(()=>{n.forEach(({column:o,button:r,index:i})=>{this.setupButtonInteractions(o,r,i)})})}createCollapseButton(){const e=document.createElement("button");return e.className="bue-button bue-button--minimal bue-button--xs collapse-button",e.textContent="▼",e.title="ステータス列を折りたたむ",e.setAttribute("aria-label","ステータス列を折りたたむ"),e.setAttribute("aria-expanded","true"),e.setAttribute("type","button"),e.style.cssText=`
      margin-left: var(--spacing-sm, 4px);
      align-self: center;
      font-size: 12px;
    `,e}setupButtonInteractions(e,t,n){const o=new AbortController;t.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),this.toggleColumn(e,t,n)},{signal:o.signal}),t.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),r.stopPropagation(),this.toggleColumn(e,t,n))},{signal:o.signal}),t.__abortController=o}setupHeaderClickExpand(e,t,n,o){e.dataset.expandClickSetup!=="true"&&(e.addEventListener("click",r=>{const i=r.target;if(i.classList.contains("collapse-button")||i.tagName==="A"||i.tagName==="BUTTON"||i.tagName==="SVG"||i.tagName==="USE"||i.closest("a")||i.closest("button:not(.collapse-button)")||i.closest("svg"))return;const a=this.getColumnElements(t);a.issueList&&a.issueList.style.display==="none"&&(r.preventDefault(),r.stopPropagation(),this.toggleColumn(t,n,o))}),e.addEventListener("mouseenter",()=>{const r=this.getColumnElements(t);if(r.issueList&&r.issueList.style.display==="none"){e.style.cursor="pointer";const i=e.querySelector(".StatusIcon");i&&(i.style.cursor="pointer")}}),e.addEventListener("mouseleave",()=>{const r=this.getColumnElements(t);r.issueList&&r.issueList.style.display,e.style.cursor=""}),e.dataset.expandClickSetup="true")}toggleColumn(e,t,n){const o=this.getColumnElements(e);if(!o.issueList)return;const r=o.issueList.style.display==="none",i=this.getStatusName(e)||`column_${n}`;s.boardAccordion.debug(`Toggling column '${i}', isCollapsed: ${r}`),r?this.expandColumn(e,t,o):this.collapseColumn(e,t,o),this.saveColumnState(e,!r)}getColumnElements(e){const t=n=>{for(const o of n){const r=e.querySelector(o);if(r)return r}return null};return{issueList:t(["ul.SlotBox",'[class*="issue-list"]','[class*="card-list"]',"ul, ol",'[class*="list"]']),statusName:t(["h3.SlotHead > div:nth-child(2)",'[class*="status-name"]','[class*="column-title"]',"h1, h2, h3, h4, h5, h6"]),expandArea:t(["h3.SlotHead > div:nth-child(3)",'[class*="expand"]','[class*="action"]']),addIssueButton:t([".css-oslcxi-row",'[class*="add-issue"]','[class*="add-button"]','button[class*="add"]']),descriptionArea:t([".css-1vsmiu0-box",'[class*="description"]','[class*="summary"]'])}}expandColumn(e,t,n){var r,i,a,l,u;(r=n.issueList)!=null&&r.style&&(n.issueList.style.display=""),(i=n.statusName)!=null&&i.style&&(n.statusName.style.display=""),(a=n.expandArea)!=null&&a.style&&(n.expandArea.style.display=""),(l=n.addIssueButton)!=null&&l.style&&(n.addIssueButton.style.display=""),(u=n.descriptionArea)!=null&&u.style&&(n.descriptionArea.style.display=""),t.textContent="▼",t.title="ステータス列を折りたたむ",t.setAttribute("aria-label","ステータス列を折りたたむ"),t.setAttribute("aria-expanded","true"),e.style.width="",e.style.minWidth="",e.style.maxWidth="",e.style.paddingRight="";const o=e.firstElementChild;o&&(o.style.height=""),this.removeIconTooltip(e),this.refreshPendingStatesInColumn()}collapseColumn(e,t,n){var r,i,a,l,u;(r=n.issueList)!=null&&r.style&&(n.issueList.style.display="none"),(i=n.statusName)!=null&&i.style&&(n.statusName.style.display="none"),(a=n.expandArea)!=null&&a.style&&(n.expandArea.style.display="none"),(l=n.addIssueButton)!=null&&l.style&&(n.addIssueButton.style.display="none"),(u=n.descriptionArea)!=null&&u.style&&(n.descriptionArea.style.display="none"),t.textContent="▶",t.title="ステータス列を展開する",t.setAttribute("aria-label","ステータス列を展開する"),t.setAttribute("aria-expanded","false"),e.style.width=this.config.COLLAPSED_WIDTH,e.style.minWidth=this.config.COLLAPSED_WIDTH,e.style.maxWidth=this.config.COLLAPSED_WIDTH,e.matches(".css-hrpltn-col:last-of-type")&&(e.style.paddingRight="0");const o=e.firstElementChild;o&&(o.style.height="100%"),this.addIconTooltip(e,n)}addIconTooltip(e,t){var o;const n=e.querySelector(".StatusIcon");if(n&&t.statusName){const r=((o=t.statusName.textContent)==null?void 0:o.trim())||"";n.title=r,n.style.cursor="pointer"}}removeIconTooltip(e){const t=e.querySelector(".StatusIcon");t&&(t.title="",t.style.cursor="")}getStatusName(e){var r,i;const t=this.getColumnElements(e);if(t.statusName){const a=(r=t.statusName.textContent)==null?void 0:r.trim();if(a)return a}const n=e.dataset.statusName;return n||`column_${Array.from(((i=e.parentElement)==null?void 0:i.children)||[]).indexOf(e)}`}async saveColumnState(e,t){const n=this.getStatusName(e);if(!n){s.boardAccordion.warn("Cannot save state - status name not found");return}const r=`backlog_column_${d.getPageInfo().projectKey||"unknown"}_${n}`;try{await B.set(r,t),s.boardAccordion.debug(`Saved column '${n}' state: ${t}`)}catch(i){s.boardAccordion.error("Failed to save column state:",i)}}async restoreColumnState(e,t){const n=this.getStatusName(e);if(!n){s.boardAccordion.warn("Cannot restore state - status name not found");return}const r=`backlog_column_${d.getPageInfo().projectKey||"unknown"}_${n}`;try{if(await B.get(r)){const a=this.getColumnElements(e);this.collapseColumn(e,t,a),s.boardAccordion.debug(`Restored column '${n}' as collapsed`)}}catch(i){s.boardAccordion.error("Failed to restore column state:",i)}}observeChanges(){this.observer=d.observeChanges(e=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=window.setTimeout(()=>{e.some(n=>n.type==="childList"&&n.addedNodes.length>0&&Array.from(n.addedNodes).some(o=>o.nodeType===Node.ELEMENT_NODE&&o.matches('.css-hrpltn-col, [data-testid="board-column"], .board-column')))&&d.getPageInfo().type==="board"&&this.addCollapseButtons()},this.config.BUTTON_DELAY)})}setupKeyboardShortcuts(){document.addEventListener("keydown",this.keyboardHandler,{signal:this.abortController.signal})}refreshPendingStatesInColumn(){var e,t;try{const n=window.__backlog_usability_enhance__;if(!n){s.boardAccordion.debug("Global instance not available for pending state refresh");return}const o=(e=n.getFeature)==null?void 0:e.call(n,"issuePending");if(!((t=o==null?void 0:o._instance)!=null&&t.refreshAllVisibleCards)){s.boardAccordion.debug("IssuePending feature not available or method not found");return}setTimeout(()=>{var r,i;(i=(r=o._instance)==null?void 0:r.refreshAllVisibleCards)==null||i.call(r).catch(a=>{s.boardAccordion.error("Failed to refresh pending states in column:",a)}),s.boardAccordion.debug("Refreshed pending states in expanded column")},50)}catch(n){s.boardAccordion.error("Error while refreshing pending states:",n)}}handleKeyboardShortcuts(e){const t=document.activeElement;t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)||(e.ctrlKey&&e.shiftKey&&e.key==="E"&&(e.preventDefault(),this.expandAllColumns(),s.boardAccordion.info("Expand all columns via shortcut")),e.ctrlKey&&e.shiftKey&&e.key==="C"&&(e.preventDefault(),this.collapseAllColumns(),s.boardAccordion.info("Collapse all columns via shortcut")))}expandAllColumns(){document.querySelectorAll(".css-hrpltn-col").forEach((t,n)=>{const o=t.querySelector(".collapse-button");o&&o.textContent==="▶"&&this.toggleColumn(t,o,n)}),this.refreshAllPendingStates()}refreshAllPendingStates(){var e,t;try{const n=window.__backlog_usability_enhance__;if(!n){s.boardAccordion.debug("Global instance not available for pending state refresh");return}const o=(e=n.getFeature)==null?void 0:e.call(n,"issuePending");if(!((t=o==null?void 0:o._instance)!=null&&t.refreshAllVisibleCards)){s.boardAccordion.debug("IssuePending feature not available or method not found");return}setTimeout(()=>{var r,i;(i=(r=o._instance)==null?void 0:r.refreshAllVisibleCards)==null||i.call(r).catch(a=>{s.boardAccordion.error("Failed to refresh all pending states:",a)}),s.boardAccordion.debug("Refreshed all pending states after column operations")},100)}catch(n){s.boardAccordion.error("Error while refreshing all pending states:",n)}}collapseAllColumns(){document.querySelectorAll(".css-hrpltn-col").forEach((t,n)=>{const o=t.querySelector(".collapse-button");o&&o.textContent==="▼"&&this.toggleColumn(t,o,n)})}removeCollapseButtons(){document.querySelectorAll(".collapse-button").forEach(t=>{var r;const n=t.__abortController;n&&n.abort();const o=(r=t.closest(".css-hrpltn-col"))==null?void 0:r.querySelector('[data-expand-click-setup="true"]');o&&(o.removeAttribute("data-expand-click-setup"),o.style.cursor=""),t.remove()})}}const D=class D{constructor(){m(this,"observer",null);m(this,"originalLabels",new Map);m(this,"isUpdating",!1);s.shortcutKeys.debug("constructor()")}init(){try{const e=this.findProjectNavList();if(!e){s.shortcutKeys.debug("Project navigation list not found, retrying..."),setTimeout(()=>{this.retryInitialization()},300);return}this.integrateShortcutKeys(e),this.observeNavigationChanges(e),setTimeout(()=>{this.integrateShortcutKeys(e)},100),s.shortcutKeys.info("Feature initialized")}catch(e){s.shortcutKeys.error("Failed to initialize:",e)}}retryInitialization(){const e=this.findProjectNavList();e?(s.shortcutKeys.debug("Project navigation found on retry, initializing..."),this.integrateShortcutKeys(e),this.observeNavigationChanges(e)):s.shortcutKeys.warn("Project navigation still not found after retry")}destroy(){s.shortcutKeys.debug("destroy()");try{this.observer&&(this.observer.disconnect(),this.observer=null),this.restoreOriginalLabels(),s.shortcutKeys.info("Feature destroyed")}catch(e){s.shortcutKeys.error("Failed to destroy:",e)}}findProjectNavList(){const e=["#projectNavList",".project-nav-list",'[role="navigation"][aria-label*="プロジェクト"]'];for(const t of e){const n=document.querySelector(t);if(n)return n}return null}integrateShortcutKeys(e){var t;if(!this.isUpdating){this.isUpdating=!0;try{this.restoreOriginalLabels();const n=e.querySelectorAll(".project-nav-list__item a, .project-nav-list__item span");for(const o of n){const r=o,i=r.id;s.shortcutKeys.debug(`Processing nav item: id="${i}", href="${r.getAttribute("href")}", text="${(t=r.textContent)==null?void 0:t.trim()}"`);let a=D.SHORTCUT_MAPPINGS.find(l=>l.elementId===i);if(i==="navi-file"){const l=r.getAttribute("href");l&&l.includes("/git/")&&(a=D.SHORTCUT_MAPPINGS.find(u=>u.elementId==="navi-git"),s.shortcutKeys.debug("Detected Git menu with navi-file ID, using Git mapping"))}a&&this.integrateShortcutKeyToLabel(r,a)}}finally{setTimeout(()=>{this.isUpdating=!1},200)}}}integrateShortcutKeyToLabel(e,t){try{const n=e.querySelector(".project-nav-list__text span");if(!n||!n.textContent)return;const o=this.getUniqueElementKey(e,t);this.originalLabels.has(o)||this.originalLabels.set(o,n.textContent);const r=this.originalLabels.get(o)||n.textContent;if(r.includes(`(${t.key.toUpperCase()})`))return;const i=`${r} (${t.key.toUpperCase()})`;n.textContent=i,e.title=i;const a=e.getAttribute("data-tooltip");if(a&&!a.includes(`(${t.key.toUpperCase()})`)){e.hasAttribute("data-original-tooltip")||e.setAttribute("data-original-tooltip",a);const l=`${a} (${t.key.toUpperCase()})`;e.setAttribute("data-tooltip",l),s.shortcutKeys.debug(`Updated data-tooltip: ${a} -> ${l}`)}s.shortcutKeys.debug(`Integrated shortcut key '${t.key}' into label: ${r} -> ${i}`)}catch(n){s.shortcutKeys.error(`Failed to integrate shortcut key to ${t.elementId}:`,n)}}getUniqueElementKey(e,t){const n=e.getAttribute("href");return e.id==="navi-file"&&n&&n.includes("/git/")?"navi-git":t.elementId}restoreOriginalLabels(){for(const[e,t]of this.originalLabels)try{let n=null;if(e==="navi-git"){const o=document.querySelectorAll("#navi-file");for(const r of o){const i=r.getAttribute("href");if(i&&i.includes("/git/")){n=r;break}}}else n=document.getElementById(e);if(n){const o=n.querySelector(".project-nav-list__text span");if(o){o.textContent=t,n.title=n.getAttribute("data-tooltip")||"";const r=n.getAttribute("data-original-tooltip");r&&(n.setAttribute("data-tooltip",r),n.removeAttribute("data-original-tooltip"),s.shortcutKeys.debug(`Restored data-tooltip to: ${r}`))}}}catch(n){s.shortcutKeys.error(`Failed to restore label for ${e}:`,n)}this.originalLabels.clear()}observeNavigationChanges(e){this.observer=new MutationObserver(t=>{if(this.isUpdating)return;let n=!1;for(const o of t)if(o.type==="childList"&&o.addedNodes.length>0){for(const r of o.addedNodes)if(r.nodeType===Node.ELEMENT_NODE){const i=r;if(i.classList.contains("project-nav-list__item")||i.querySelector(".project-nav-list__item")){n=!0;break}}if(n)break}n&&setTimeout(()=>{this.integrateShortcutKeys(e)},100)}),this.observer.observe(e,{childList:!0,subtree:!0})}};m(D,"SHORTCUT_MAPPINGS",[{key:"h",description:"ホーム",elementId:"navi-home"},{key:"a",description:"課題の追加",elementId:"navi-add"},{key:"f",description:"課題",elementId:"navi-find"},{key:"r",description:"ボード",elementId:"navi-board"},{key:"g",description:"ガントチャート",elementId:"navi-gantt"},{key:"w",description:"Wiki",elementId:"navi-wiki"},{key:"s",description:"ファイル",elementId:"navi-file"},{key:"v",description:"Subversion",elementId:"navi-subversion"},{key:"t",description:"Git",elementId:"navi-git"}]);let H=D;class N{static getStorageKey(e){return`${this.STORAGE_KEY_PREFIX}${e}`}static async getPendingIssues(e){if(!this.validateProjectKey(e))return s.storage.warn(`Invalid project key: ${e}`),[];try{const t=this.getStorageKey(e),n=await B.get(t);return!n||!Array.isArray(n)?[]:n}catch(t){return s.storage.error(`Failed to get pending issues for project ${e}:`,t),[]}}static async savePendingIssues(e,t){if(!this.validateProjectKey(e))throw new Error(`Invalid project key: ${e}`);const n=t.filter(o=>this.validatePendingIssue(o));n.length!==t.length&&s.storage.warn(`Filtered invalid issues: ${t.length-n.length} removed`);try{const o=this.getStorageKey(e);await B.set(o,n)}catch(o){throw s.storage.error(`Failed to save pending issues for project ${e}:`,o),o}}static async setPendingIssue(e,t){if(!this.validatePendingIssue(t))throw new Error(`Invalid pending issue data: ${JSON.stringify(t)}`);try{const o=(await this.getPendingIssues(e)).filter(r=>r.issueKey!==t.issueKey);o.push(t),await this.savePendingIssues(e,o)}catch(n){throw s.storage.error(`Failed to set pending issue ${t.issueKey}:`,n),n}}static async removePendingIssue(e,t){if(!this.validateIssueKey(t))throw new Error(`Invalid issue key: ${t}`);try{const o=(await this.getPendingIssues(e)).filter(r=>r.issueKey!==t);await this.savePendingIssues(e,o)}catch(n){throw s.storage.error(`Failed to remove pending issue ${t}:`,n),n}}static async isPendingIssue(e,t){return(await this.getPendingIssues(e)).some(o=>o.issueKey===t)}static async clearPendingIssues(e){if(!this.validateProjectKey(e))throw new Error(`Invalid project key: ${e}`);try{const t=this.getStorageKey(e);await B.remove(t)}catch(t){throw s.storage.error(`Failed to clear pending issues for project ${e}:`,t),t}}static validateProjectKey(e){return typeof e=="string"&&e.length>0&&/^[A-Z0-9_]+$/.test(e)}static validateIssueKey(e){return typeof e=="string"&&/^[A-Z0-9_]+-\d+$/.test(e)}static validatePendingIssue(e){return e&&typeof e=="object"&&this.validateIssueKey(e.issueKey)&&this.validateProjectKey(e.projectKey)}static async getAllPendingData(){return s.storage.warn("getAllPendingData is for debugging purposes only"),{}}}m(N,"STORAGE_KEY_PREFIX","backlog_pending_issues_");const ue=["li.css-1og413z-box.card",".css-1og413z-box.card","li.card",".card:not(.card-label):not(.card-summary):not(.card-status)",".IssueCard","[data-issue-key]"],ge=[".card-label",'a[href*="/view/"]',"[data-issue-key]",".IssueKey"],b={className:"pending-toggle-button",activeClassName:"pending-toggle-button--active",icon:{pending:`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="4" y="4" width="2.25" height="8" fill="currentColor" rx="0.5"/>
      <rect x="9" y="4" width="2.25" height="8" fill="currentColor" rx="0.5"/>
    </svg>`,normal:`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="padding-left: 2px;">
      <path d="M4 3L12 8L4 13V3Z" fill="currentColor"/>
    </svg>`},tooltip:{pending:"Pending状態を解除",normal:"課題をPending状態にする"}},R={pending:"issue-card--pending",normal:"issue-card--normal"},$={className:"pending-card-tooltip",delay:200,width:250};class S{static findIssueCards(e=document.body){const t=[];for(const n of ue){e.matches&&e.matches(n)&&(d.log(`[PendingDom] Container itself matches selector: ${n}`),t.includes(e)||(d.log(`[PendingDom] Container element classes: ${e.className}`),t.push(e)));const o=e.querySelectorAll(n);if(o.length>0){d.log(`[PendingDom] Found ${o.length} child elements with selector: ${n}`);for(const r of o)t.includes(r)||(d.log(`[PendingDom] Child element classes: ${r.className}`),t.push(r))}}return d.log(`[PendingDom] Total ${t.length} unique cards found`),t}static extractIssueKey(e){var i;const t=e.getAttribute("data-issue-key");if(t&&this.validateIssueKey(t))return t;const n=e.querySelector(".card-label");if(n&&n.href){const a=n.href.match(/\/view\/([A-Z0-9_]+-\d+)/);if(a&&a[1])return a[1]}if(n&&n.textContent){const a=n.textContent.trim();if(this.validateIssueKey(a))return a}for(const a of ge){const l=e.querySelector(a);if(l){const u=l.getAttribute("href");if(u){const y=u.match(/\/view\/([A-Z0-9_]+-\d+)/);if(y&&y[1])return y[1]}const h=(i=l.textContent)==null?void 0:i.trim();if(h&&this.validateIssueKey(h))return h}}const r=(e.textContent||"").match(/\b([A-Z0-9_]+-\d+)\b/);return r&&r[1]?r[1]:null}static createPendingButton(e=!1){const t=document.createElement("button");return t.className=`bue-button bue-button--icon bue-button--ghost ${b.className}`,e&&t.classList.add(b.activeClassName),t.innerHTML=e?b.icon.pending:b.icon.normal,t.title=e?b.tooltip.pending:b.tooltip.normal,t.setAttribute("aria-label",e?b.tooltip.pending:b.tooltip.normal),t.setAttribute("aria-pressed",e.toString()),t.setAttribute("type","button"),this.applyButtonStyles(t),e&&this.updatePendingButton(t,!0),t}static applyButtonStyles(e){const t={position:"absolute",top:"8px",right:"40px",width:"22px",height:"22px",borderRadius:"11px",fontSize:"0",pointerEvents:"auto",boxShadow:"var(--shadow-sm, 0 2px 4px rgba(0, 0, 0, 0.1))",borderColor:"var(--text-secondary)",color:"var(--text-secondary, #666)"};Object.assign(e.style,t),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),n.stopPropagation(),e.click())})}static applyPendingVisual(e,t){var n;if(t){e.classList.add(R.pending),e.classList.remove(R.normal),e.style.borderLeft="4px solid var(--borderColorWeak, #9e8012)",e.style.backgroundColor="var(--backgroundColorWeak, rgba(76, 71, 54, 0.6))",e.style.boxShadow="0 0 0 1px rgba(158, 128, 18, 0.3), var(--shadowModuleSmall, 0 2px 6px 0 rgba(0, 0, 0, 0.8))";const o=e.querySelector(".card-summary");if(o){o.style.display="none";const a=(n=o.textContent)==null?void 0:n.trim();a&&this.setupCustomTooltip(e,a)}const r=e.querySelector(".card-status");r&&(r.style.display="none");const i=document.createElement("style");i.textContent=`
        .issue-card--pending [data-tooltip]:before,
        .issue-card--pending [data-tooltip]:after,
        .issue-card--pending .simptip-position-top:before,
        .issue-card--pending .simptip-position-top:after {
          background-color: var(--backgroundColorSchemeBase, #333333) !important;
          color: var(--textColorDefault, #dadada) !important;
          opacity: 0.95 !important;
        }
        .issue-card--pending .calendar__ttip {
          background-color: var(--backgroundColorSchemeBase, #333333) !important;
          color: var(--textColorDefault, #dadada) !important;
          opacity: 0.95 !important;
        }
      `,document.querySelector("#pending-tooltip-fix")||(i.id="pending-tooltip-fix",document.head.appendChild(i))}else{e.classList.remove(R.pending),e.classList.add(R.normal),e.style.borderLeft="",e.style.backgroundColor="",e.style.boxShadow="";const o=e.querySelector(".card-summary");o&&(o.style.display="");const r=e.querySelector(".card-status");r&&(r.style.display=""),this.cleanupCustomTooltip(e)}}static addPendingButton(e,t,n){if(!e||typeof n!="function")return null;const o=e.querySelector(`.${b.className}`);if(o)return d.log(`[PendingDom] Button already exists in card: ${e.className}`),o;d.log(`[PendingDom] Checking direct parent for existing button: ${e.className}`);const r=e.parentElement;if(r){const a=r.querySelectorAll(`.${b.className}`);for(const l of a)if(l.closest("li.css-1og413z-box.card, .css-1og413z-box.card")===e)return d.log("[PendingDom] Button already exists in same card - ABORTING"),null}d.log(`[PendingDom] Direct parent check passed for card: ${e.className}`),getComputedStyle(e).position==="static"&&(e.style.position="relative");const i=this.createPendingButton(t);return i.addEventListener("click",a=>{d.log(`[PendingDom] Button clicked for card: ${e.className}`),a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),setTimeout(()=>{try{n(),d.log("[PendingDom] Button onClick executed successfully")}catch(l){s.issuePending.error("Error in onClick:",l)}},10)},!0),i.addEventListener("dragstart",a=>(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1)),i.addEventListener("drag",a=>(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1)),e.appendChild(i),d.log(`[PendingDom] Added button to card: ${e.className}`),i}static updatePendingButton(e,t){t?(e.classList.add(b.activeClassName),e.innerHTML=b.icon.pending,e.title=b.tooltip.pending,e.setAttribute("aria-label",b.tooltip.pending),e.setAttribute("aria-pressed","true"),e.style.backgroundColor="var(--bg-warning-element, #ffc10714)",e.style.borderColor="var(--warning-color, #ffc107)",e.style.color="var(--warning-color, #fff)"):(e.classList.remove(b.activeClassName),e.innerHTML=b.icon.normal,e.title=b.tooltip.normal,e.setAttribute("aria-label",b.tooltip.normal),e.setAttribute("aria-pressed","false"),e.style.backgroundColor="transparent",e.style.borderColor="var(--text-secondary, #e9ecef)",e.style.color="var(--text-secondary, #666)")}static removePendingButton(e){const t=e.querySelector(`.${b.className}`);t&&t.remove()}static validateIssueKey(e){return!e||typeof e!="string"||e.length>100||/<|>|&|'|"|\n|\r|\t|javascript:|data:/.test(e)?!1:/^[A-Z0-9_]+-\d+$/.test(e)}static getMutationObserverConfig(){return{childList:!0,subtree:!0,attributes:!1,characterData:!1}}static isCompletedOrPostCompletionStatus(e){var t;try{const n=[".css-hrpltn-col",'[data-testid="board-column"]',".board-column",'[class*="column"]',".lane"];let o=null;for(const y of n)if(o=e.closest(y),o)break;if(!o)return s.issuePending.debug("Card not in a valid column (tried all selectors)"),!1;if(o.getAttribute("data-statusid")==="4")return!0;const i=["h3.SlotHead",".status-name",'[class*="status"]',"h1, h2, h3, h4, h5, h6",'[class*="title"]','[class*="header"]'];let a=null;for(const y of i)if(a=o.querySelector(y),a)break;const l=((t=a==null?void 0:a.textContent)==null?void 0:t.trim())||"";return["完了","Done","Completed","Complete","Closed"].some(y=>l.includes(y))}catch(n){return s.issuePending.error("Error in isCompletedOrPostCompletionStatus:",n),!1}}static findNewIssueCards(e,t){const n=[];for(const o of e)if(o.type==="childList"){for(const r of o.addedNodes)if(r.nodeType===Node.ELEMENT_NODE){const i=r;d.log(`[PendingDom] findNewIssueCards() check new item: ${i.className} ${i.tagName}`);const a=this.findIssueCards(i);for(const l of a)t.has(l)||(d.log(`[PendingDom] Found new card: ${l.className}`),n.push(l))}}return n}static createCustomTooltip(e){const t=document.createElement("div");return t.className=$.className,t.textContent=e,Object.assign(t.style,{position:"absolute",zIndex:"10000",background:"var(--backgroundColorSchemeBase, #333333)",color:"var(--textColorDefault, #dadada)",padding:"8px 12px",borderRadius:"4px",fontSize:"13px",lineHeight:"1.4",width:`${$.width}px`,overflowWrap:"break-word",whiteSpace:"normal",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.3)",border:"1px solid var(--borderColorDefault, rgba(78, 78, 78, 0.6))",opacity:"0",transform:"translateY(10px)",transition:"opacity 0.2s ease, transform 0.2s ease",pointerEvents:"none",visibility:"visible",display:"block"}),t}static positionTooltip(e,t){const n=t.getBoundingClientRect(),o=window.innerWidth,r=window.pageYOffset||document.documentElement.scrollTop,i=window.pageXOffset||document.documentElement.scrollLeft,a=$.width,l=50;let u=n.left+i+n.width/2-a/2,h=n.bottom+r+8;u<i+8&&(u=i+8);const y=i+o-8;u+a>y&&(u=y-a,u<i+8&&(u=i+8)),h+l>r+window.innerHeight-8&&(h=n.top+r-l-8),e.style.left=`${u}px`,e.style.top=`${h}px`}static setupCustomTooltip(e,t){let n=null,o=null,r=null;const i=()=>{r&&(clearTimeout(r),r=null),o=setTimeout(()=>{const l=document.querySelector(`.${$.className}`);l&&l.remove(),n=this.createCustomTooltip(t),document.body.appendChild(n),this.positionTooltip(n,e),requestAnimationFrame(()=>{n&&(n.style.opacity="1",n.style.transform="translateY(0)")})},$.delay)},a=()=>{o&&(clearTimeout(o),o=null),n&&(r=setTimeout(()=>{n&&(n.remove(),n=null)},100))};e.addEventListener("mouseenter",i),e.addEventListener("mouseleave",a),e._tooltipCleanup=()=>{o&&clearTimeout(o),r&&clearTimeout(r),n&&n.remove(),e.removeEventListener("mouseenter",i),e.removeEventListener("mouseleave",a)}}static cleanupCustomTooltip(e){const t=e,n=t._tooltipCleanup;n&&(n(),delete t._tooltipCleanup);const o=document.querySelector(`.${$.className}`);o&&o.remove()}}class me{constructor(){m(this,"observer",null);m(this,"pendingStore",new Map);m(this,"issueCardMap",new Map);m(this,"projectKey",null);m(this,"settings",null);s.issuePending.debug("constructor()")}async init(){var e;try{const t=d.getPageInfo();if(t.type!=="board"){d.log("IssuePendingFeature: Not a board page, skipping initialization");return}if(this.projectKey=t.projectKey||null,!this.projectKey){d.log("IssuePendingFeature: No project key found");return}if(d.log(`IssuePendingFeature: Initializing for project ${this.projectKey}`),await this.loadSettings(),!((e=this.settings)!=null&&e.enabled)){d.log("IssuePendingFeature: Feature is disabled, skipping");return}this.setupSettingsWatcher(),await this.loadPendingData(),this.scheduleButtonAddition(),this.observeIssueCards(),s.issuePending.info("Initialization completed")}catch(t){s.issuePending.error("Failed to initialize:",t)}}async loadSettings(){try{const e=await w.getSettings();this.settings=e.issuePending,s.issuePending.debug("Settings loaded:",this.settings)}catch(e){s.issuePending.error("Failed to load settings:",e),this.settings={enabled:!0,autoResolve:!0}}}setupSettingsWatcher(){w.onSettingsChanged(e=>{var n,o;const t=e.issuePending;s.issuePending.debug("Settings changed:",t),!t.enabled&&((n=this.settings)!=null&&n.enabled)&&(s.issuePending.info("Feature disabled, removing buttons"),this.removeAllPendingButtons(),this.disconnect()),t.enabled&&!((o=this.settings)!=null&&o.enabled)&&(s.issuePending.info("Feature enabled, reinitializing"),this.reconnect()),this.settings=t})}destroy(){s.issuePending.debug("destroy()"),this.observer&&(this.observer.disconnect(),this.observer=null),this.pendingStore.clear(),this.issueCardMap.clear(),this.projectKey=null,s.issuePending.info("Destroyed")}removeAllPendingButtons(){document.querySelectorAll(".pending-toggle-button").forEach(t=>t.remove()),s.issuePending.debug("All pending buttons removed")}disconnect(){this.observer&&(this.observer.disconnect(),this.observer=null),s.issuePending.debug("Observer disconnected")}async reconnect(){try{await this.loadPendingData(),this.scheduleButtonAddition(),this.observeIssueCards(),s.issuePending.info("Reconnected successfully")}catch(e){s.issuePending.error("Failed to reconnect:",e)}}async togglePending(e){if(!(!this.projectKey||!S.validateIssueKey(e)))try{const t=await this.isPending(e);if(t)await N.removePendingIssue(this.projectKey,e),this.pendingStore.delete(e);else{const n={issueKey:e,projectKey:this.projectKey};await N.setPendingIssue(this.projectKey,n),this.pendingStore.set(e,n)}await this.updateCardVisualState(e),s.issuePending.info(`Toggled pending state for ${e}, new state: ${!t}`)}catch(t){s.issuePending.error(`Failed to toggle pending state for ${e}:`,t)}}async removePendingState(e){if(!(!this.projectKey||!S.validateIssueKey(e)))try{await N.removePendingIssue(this.projectKey,e),this.pendingStore.delete(e),await this.updateCardVisualState(e),s.issuePending.debug(`Removed pending state for ${e}`)}catch(t){s.issuePending.error(`Failed to remove pending state for ${e}:`,t)}}async isPending(e){if(!this.projectKey||!S.validateIssueKey(e))return!1;try{return await N.isPendingIssue(this.projectKey,e)}catch(t){return s.issuePending.error(`Failed to check pending status for ${e}:`,t),!1}}getPendingIssues(){return Array.from(this.pendingStore.values())}getProjectKey(){return this.projectKey}async loadPendingData(){if(this.projectKey)try{const e=await N.getPendingIssues(this.projectKey);this.pendingStore.clear();for(const t of e)this.pendingStore.set(t.issueKey,t);s.issuePending.debug(`Loaded ${e.length} pending issues`)}catch(e){s.issuePending.error("Failed to load pending data:",e)}}scheduleButtonAddition(){requestAnimationFrame(async()=>{await this.addPendingButtonsToCards(!0),setTimeout(async()=>{await this.addPendingButtonsToCards(!0)},1e3)})}async addPendingButtonsToCards(e=!1){const t=S.findIssueCards();s.issuePending.debug(`Found ${t.length} cards during initialization`);let n=0;for(const o of t){const r=S.extractIssueKey(o);if(r){const i=this.issueCardMap.has(r),a=o.querySelector(".pending-toggle-button");d.log(`[IssuePendingFeature] Processing card ${r}: inMap=${i}, hasButton=${!!a}, forceAdd=${e}`),(e||!i)&&!a?(await this.addPendingButtonToCard(o),n++,d.log(`[IssuePendingFeature] Successfully added button to ${r}`)):d.log(`[IssuePendingFeature] Skipped ${r}: inMap=${i}, hasButton=${!!a}`)}else d.log(`[IssuePendingFeature] Could not extract issue key from card: ${o.className}`)}s.issuePending.info(`Added pending buttons to ${n} new cards (${t.length} total found)`)}async addPendingButtonToCard(e){var r;const t=S.extractIssueKey(e);if(!t){d.log(`[IssuePendingFeature] Failed to extract issue key from card: ${e.className}`);return}d.log(`[IssuePendingFeature] Attempting to add button to ${t}`),this.issueCardMap.set(t,e);let n=await this.isPending(t);d.log(`[IssuePendingFeature] ${t} isPending: ${n}`),n&&((r=this.settings)!=null&&r.autoResolve)&&S.isCompletedOrPostCompletionStatus(e)&&(s.issuePending.info(`Auto-resolving pending state for ${t} (completed or post-completion status)`),await this.removePendingState(t),n=!1),S.addPendingButton(e,n,()=>{this.togglePending(t)})?(S.applyPendingVisual(e,n),s.issuePending.debug(`Successfully added pending button to ${t}`)):s.issuePending.warn(`Failed to add button to ${t} - button creation returned null`)}async updateCardVisualState(e){const t=this.issueCardMap.get(e);if(!t)return;const n=await this.isPending(e),o=t.querySelector(".pending-toggle-button");o&&S.updatePendingButton(o,n),S.applyPendingVisual(t,n)}async refreshCardVisualState(e){const t=S.extractIssueKey(e);if(!t)return;const n=await this.isPending(t);S.applyPendingVisual(e,n),s.issuePending.debug(`Refreshed visual state for ${t}, isPending: ${n}`)}async refreshAllVisibleCards(){const e=document.querySelectorAll(".css-1og413z-box.card, .card"),t=[];e.forEach(n=>{t.push(this.refreshCardVisualState(n))}),await Promise.all(t),s.issuePending.debug(`Refreshed visual state for ${e.length} visible cards`)}observeIssueCards(){this.observer=d.observeChanges(e=>{this.handleMutations(e)})}async handleMutations(e){const t=new Set(this.issueCardMap.values()),n=S.findNewIssueCards(e,t);for(const o of n)await this.addPendingButtonToCard(o);n.length>0&&s.issuePending.debug(`Added buttons to ${n.length} new cards`)}}class he{constructor(){m(this,"observer",null);m(this,"isInitialized",!1);s.content.debug("[PrFormatAutoInsert] Constructor called")}init(){if(this.isInitialized){s.content.warn("[PrFormatAutoInsert] Already initialized");return}if(s.content.info("[PrFormatAutoInsert] Initializing..."),!this.isPullRequestAddPage()){s.content.debug("[PrFormatAutoInsert] Not a pull request add page");return}const e=this.getProjectKey();if(!e){s.content.debug("[PrFormatAutoInsert] Could not extract project key from URL");return}s.content.info(`[PrFormatAutoInsert] Detected project: ${e}`),this.startObserving(e),this.isInitialized=!0}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.isInitialized=!1,s.content.info("[PrFormatAutoInsert] Destroyed")}updateSettings(){s.content.debug("[PrFormatAutoInsert] Settings updated")}isPullRequestAddPage(){const e=window.location.pathname;return/\/git\/[^/]+\/[^/]+\/pullRequests\/add\//.test(e)}getProjectKey(){const t=window.location.pathname.match(/\/git\/([^/]+)\/[^/]+\/pullRequests\/add\//);return t?t[1]:null}startObserving(e){if(this.getDescriptionEditor()){s.content.debug("[PrFormatAutoInsert] Editor already exists, inserting template immediately"),this.insertTemplate(e);return}this.observer=new MutationObserver(()=>{var o;this.getDescriptionEditor()&&(s.content.debug("[PrFormatAutoInsert] Editor detected, inserting template"),(o=this.observer)==null||o.disconnect(),this.insertTemplate(e))}),this.observer.observe(document.body,{childList:!0,subtree:!0}),s.content.debug("[PrFormatAutoInsert] Started observing for editor appearance")}getDescriptionEditor(){const e=document.querySelector("#description.ProseMirror");if(e)return s.content.debug("[PrFormatAutoInsert] Found ProseMirror editor"),e;const t=document.querySelector("#hidden-description");return t?(s.content.debug("[PrFormatAutoInsert] Found hidden textarea"),t):null}async insertTemplate(e){try{if(!await X.isEnabled()){s.content.debug("[PrFormatAutoInsert] Feature is disabled");return}const n=await X.getProjectTemplate(e);if(!n){s.content.debug(`[PrFormatAutoInsert] No template found for project: ${e}`);return}const o=this.getDescriptionEditor();if(!o){s.content.warn("[PrFormatAutoInsert] Editor not found when trying to insert template");return}if(!this.isEditorEmpty(o)){s.content.debug("[PrFormatAutoInsert] Editor is not empty, skipping template insertion");return}o.classList.contains("ProseMirror")?this.insertToProseMirror(o,n):o.tagName==="TEXTAREA"&&(o.value=n),o.focus(),s.content.info(`[PrFormatAutoInsert] Template inserted for project: ${e}`)}catch(t){s.content.error("[PrFormatAutoInsert] Failed to insert template:",t)}}isEditorEmpty(e){var t;if(e.classList.contains("ProseMirror")){const n=e.querySelector("p");return n?(((t=n.textContent)==null?void 0:t.trim())||"")===""||n.classList.contains("empty-node"):!0}else if(e.tagName==="TEXTAREA")return e.value.trim()==="";return!0}insertToProseMirror(e,t){const n=t.split(`
`);e.innerHTML="",n.forEach(r=>{const i=document.createElement("p");r.trim()===""?i.innerHTML="<br>":i.textContent=r,e.appendChild(i)});const o=document.querySelector("#hidden-description");o&&(o.value=t,o.dispatchEvent(new Event("input",{bubbles:!0})))}}class pe{detectPageType(){const e=window.location.pathname,t=new URLSearchParams(window.location.search);return e.includes("/view/")&&!e.includes("/git/")?t.has("dialogMode")?"issueModal":"issue":e.includes("/git/")&&e.includes("/pullRequests/")?"pullRequest":"other"}isIssuePage(){return this.detectPageType()==="issue"}isPullRequestPage(){return this.detectPageType()==="pullRequest"}isIssueModalPage(){return this.detectPageType()==="issueModal"}isTargetPage(){const e=this.detectPageType();return e==="issue"||e==="pullRequest"||e==="issueModal"}}class fe{constructor(){}async handleCopy(e,t,n){try{let o=!1;if(n==="issueModal"?(o=await this.fallbackCopy(t),o&&s.content.debug("Comment URL copied using fallback functionality for modal")):this.triggerExistingCopy(e,n)?(o=!0,s.content.debug("Comment URL copied using existing functionality")):(o=await this.fallbackCopy(t),o&&s.content.debug("Comment URL copied using fallback functionality")),!o)throw new Error("Failed to copy comment URL")}catch(o){s.content.error("Failed to copy comment URL:",o)}}triggerExistingCopy(e,t){try{const n=this.getSelectors(),o=n.EXISTING_COPY_BUTTON[t],r=e.querySelector(n.DROPDOWN_MENU);if(!r)return!1;const i=r.querySelector(o);return i?(i.click(),!0):!1}catch(n){return s.content.warn("Failed to trigger existing copy functionality:",n),!1}}async fallbackCopy(e){try{const t=this.generateCommentUrl(e);if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(t),!0;const n=document.createElement("textarea");n.value=t,n.style.cssText="position: fixed; left: -9999px; opacity: 0;",document.body.appendChild(n),n.select(),n.setSelectionRange(0,99999);const o=document.execCommand("copy");return document.body.removeChild(n),o}catch(t){return s.content.error("Fallback copy failed:",t),!1}}generateCommentUrl(e){const t=new URL(location.href);return t.searchParams.has("dialogMode")?(t.searchParams.delete("dialogMode"),`${t.origin}${t.pathname}${t.search}#${e}`):`${location.origin}${location.pathname}#${e}`}getSelectors(){return{COMMENT_CONTAINER:".comment-item",COMMENT_HEADER:".comment-item__header",ACTIONS_CONTAINER:".comment-item__actions",ANCHOR_ELEMENT:{issue:".page-section-anchor",pullRequest:"a.page-section-anchor"},DROPDOWN_MENU:".dropdown",EXISTING_COPY_BUTTON:{issue:"#copyURL",pullRequest:'a[data-bind*="copyURL.bind"]'},STAR_BUTTON:".star-button",QUOTE_BUTTON:".ticket__quote"}}}const L=class L{createButton(e,t){return this.createButtonElement(e)}injectButton(e,t,n){try{if(e.classList.contains(L.BUTTON_INJECTED_CLASS))return s.content.debug("Button already injected for this comment element"),!0;if(e.querySelector(".comment-url-copy-btn"))return s.content.debug("Button already exists for this comment element"),e.classList.add(L.BUTTON_INJECTED_CLASS),!0;s.content.debug("Attempting to inject button into:",e.outerHTML.substring(0,200));const r=[".comment-item__actions",".comment-actions",".ticket-comment-actions",".issue-comment-actions",'[class*="action"]',".comment-header",".comment-meta"];let i=null;for(const l of r)if(i=e.querySelector(l),i){s.content.debug(`Found actions container with selector: ${l}`);break}if(!i)return s.content.debug("No actions container found, appending to comment element"),e.appendChild(t),e.classList.add(L.BUTTON_INJECTED_CLASS),!0;const a=this.findInsertionPoint(i,n);return a?a.position==="before"?a.element.insertAdjacentElement("beforebegin",t):a.element.insertAdjacentElement("afterend",t):i.appendChild(t),e.classList.add(L.BUTTON_INJECTED_CLASS),!0}catch(o){return s.content.error("Failed to inject button:",o),!1}}findInsertionPoint(e,t){const n=this.getSelectors(),o=e.querySelector(n.QUOTE_BUTTON);if(o)return{element:o,position:"after"};const r=e.querySelector(n.STAR_BUTTON);if(r)return{element:r,position:"after"};const i=e.querySelector(".dropdown");return i?{element:i,position:"before"}:e.children.length>0?{element:e.children[e.children.length-1],position:"before"}:null}createButtonElement(e){const t=document.createElement("button");return t.type="button",t.className=`icon-button icon-button--default ${L.BUTTON_CLASS}`,t.title="URLをコピー",t.setAttribute("aria-label","コメントのURLをコピー"),t.setAttribute("data-comment-id",e),t.innerHTML=`
      <svg role="image" class="icon -medium card-copy-icon"><use xlink:href="/images/svg/sprite.symbol.svg#icon_copy"></use></svg>
      <span class="_assistive-text">URLをコピー</span>
    `,t.style.cssText=`
      transition: all 0.2s ease;
    `,t}getSelectors(){return{COMMENT_CONTAINER:".comment-item",COMMENT_HEADER:".comment-item__header",ACTIONS_CONTAINER:".comment-item__actions",ANCHOR_ELEMENT:{issue:".page-section-anchor",pullRequest:"a.page-section-anchor"},DROPDOWN_MENU:".dropdown",EXISTING_COPY_BUTTON:{issue:"#copyURL",pullRequest:'a[data-bind*="copyURL.bind"]'},STAR_BUTTON:".star-button",QUOTE_BUTTON:".ticket__quote"}}};m(L,"BUTTON_CLASS","comment-url-copy-btn"),m(L,"BUTTON_INJECTED_CLASS","comment-url-copy-injected");let G=L;class ye{constructor(e,t,n){m(this,"mutationObserver",null);m(this,"onCommentAdded");m(this,"pageType");m(this,"throttledHandler");this.isCommentElementFn=n,this.onCommentAdded=e,this.pageType=t,this.throttledHandler=this.throttle(this.handleMutations.bind(this),100)}start(){this.mutationObserver&&this.stop();const e={childList:!0,subtree:!0,attributes:!1,attributeOldValue:!1,characterData:!1,characterDataOldValue:!1};this.mutationObserver=new MutationObserver(this.throttledHandler);const t=this.getObserverTarget(this.pageType);t?(this.mutationObserver.observe(t,e),s.content.debug("CommentObserver started")):s.content.warn("Observer target not found")}stop(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null,s.content.debug("CommentObserver stopped"))}updatePageType(e){this.pageType=e,this.mutationObserver&&(this.stop(),this.start())}handleMutations(e){try{for(const t of e)t.type==="childList"&&t.addedNodes.forEach(n=>{if(n.nodeType===Node.ELEMENT_NODE){const o=n;if(o.classList.contains("comment-url-copy-btn")||o.closest(".comment-url-copy-btn"))return;this.isCommentElementFn(o)&&(s.content.debug("New comment element detected:",o.className),this.onCommentAdded(o,this.pageType)),o.querySelectorAll(".comment-item__inner, .comment-item").forEach(i=>{this.isCommentElementFn(i)&&(s.content.debug("New comment element found in subtree:",i.className),this.onCommentAdded(i,this.pageType))})}})}catch(t){s.content.error("Error handling mutations:",t)}}getObserverTarget(e){const t=[".comment-list",".TicketCommentList",".pr-comment-list",'[data-bind*="foreach: comments"]',"#content","body"];for(const n of t){const o=document.querySelector(n);if(o)return o}return document.body}throttle(e,t){let n=null;return o=>{n&&clearTimeout(n),n=window.setTimeout(()=>{e(o)},t)}}}class be{constructor(e){m(this,"pageDetector");m(this,"observer",null);m(this,"buttonInjector");m(this,"copyHandler");m(this,"isEnabled",!1);m(this,"currentPageType","other");m(this,"eventListeners",new Map);m(this,"settings",null);m(this,"submitButtonListener",null);m(this,"keyboardSubmitListener",null);this.pageDetector=new pe,this.copyHandler=new fe,this.buttonInjector=new G,e&&(this.isEnabled=e.enabled)}async init(){try{if(s.content.info("CommentUrlCopy: Starting initialization"),await this.loadSettings(),s.content.info(`CommentUrlCopy: Settings loaded, enabled: ${this.isEnabled}`),!this.isEnabled){s.content.debug("CommentUrlCopy feature is disabled");return}if(this.currentPageType=this.pageDetector.detectPageType(),s.content.info(`CommentUrlCopy: Detected page type: ${this.currentPageType}`),s.content.info(`CommentUrlCopy: Current URL: ${window.location.href}`),!this.pageDetector.isTargetPage()){s.content.debug("Not a target page for CommentUrlCopy feature");return}s.content.info("CommentUrlCopy: Initializing on target page"),this.cleanupInvalidButtons(),s.content.debug("CommentUrlCopy: Current DOM structure:",document.body.innerHTML.substring(0,500)),this.processExistingComments(),this.scheduleRetryProcessing(),(this.currentPageType==="issue"||this.currentPageType==="pullRequest"||this.currentPageType==="issueModal")&&(this.observer=new ye((e,t)=>this.handleNewComment(e,t),this.currentPageType,e=>this.isCommentElement(e)),this.observer.start(),s.content.info("CommentUrlCopy: Observer started"),this.watchCommentSubmitButton(),this.watchCommentKeyboardSubmit()),this.watchPageChanges(),s.content.info("CommentUrlCopy feature initialized successfully")}catch(e){s.content.error("Failed to initialize CommentUrlCopy feature:",e)}}destroy(){s.content.info("Destroying CommentUrlCopy feature"),this.observer&&(this.observer.stop(),this.observer=null),this.removeAllEventListeners(),this.removeSubmitButtonListener(),this.removeKeyboardSubmitListener(),this.removeAllButtons(),this.isEnabled=!1}enable(){this.isEnabled=!0,this.init()}disable(){this.destroy()}async updateSettings(){var e,t;await this.loadSettings(),((e=this.settings)==null?void 0:e.commentUrlCopy.enabled)!==this.isEnabled&&((t=this.settings)!=null&&t.commentUrlCopy.enabled?this.enable():this.disable())}async loadSettings(){var e;this.settings=await w.getSettings(),this.isEnabled=((e=this.settings)==null?void 0:e.commentUrlCopy.enabled)??!0}processExistingComments(){try{const e=[".comment-item",".comment-item__inner",".ticket-comment",".issue-comment"];let t=[];for(const n of e){const o=document.querySelectorAll(n);if(o.length>0){s.content.debug(`Found ${o.length} elements with selector: ${n}`),t=Array.from(o).filter(r=>this.isCommentElement(r));break}}s.content.info(`CommentUrlCopy: Page type is ${this.currentPageType}, found ${t.length} valid comment elements`),(this.currentPageType==="issue"||this.currentPageType==="pullRequest"||this.currentPageType==="issueModal")&&t.forEach((n,o)=>{s.content.debug(`Processing comment element ${o}:`,n.className),this.handleNewComment(n,this.currentPageType)}),s.content.debug(`Processed ${t.length} existing comments`)}catch(e){s.content.error("Error processing existing comments:",e)}}handleNewComment(e,t){try{const n=this.extractCommentId(e);if(!n){s.content.warn("Could not extract comment ID");return}if(this.currentPageType==="issue"||this.currentPageType==="pullRequest"||this.currentPageType==="issueModal"){const o=this.buttonInjector.createButton(n,this.currentPageType);if(this.buttonInjector.injectButton(e,o,this.currentPageType)){const r=i=>{i.preventDefault(),i.stopPropagation(),this.copyHandler.handleCopy(e,n,this.currentPageType)};o.addEventListener("click",r),this.eventListeners.set(o,r),s.content.debug(`Button injected for comment: ${n}`)}}}catch(n){s.content.error("Error handling new comment:",n)}}extractCommentId(e){try{if(this.currentPageType!=="issue"&&this.currentPageType!=="pullRequest"&&this.currentPageType!=="issueModal")return null;const t=[".page-section-anchor","a.page-section-anchor",'[id^="comment-"]','[class*="anchor"]','a[href*="#"]',"[data-comment-id]"];for(const i of t){const a=e.querySelector(i);if(a){s.content.debug(`Found anchor with selector: ${i}`);const l=a.id;if(l)return s.content.debug(`Found comment ID from element.id: ${l}`),l;const u=a.getAttribute("data-comment-id");if(u)return s.content.debug(`Found comment ID from data-comment-id: ${u}`),u;const h=a.getAttribute("href");if(h&&h.includes("#")){const y=h.split("#")[1];if(y)return s.content.debug(`Found comment ID from href fragment: ${y}`),y}}}if(e.id)return s.content.debug(`Using comment element ID as fallback: ${e.id}`),e.id;const n=Date.now(),o=Math.random().toString(36).substring(2,11),r=`comment-${n}-${o}`;return s.content.debug(`Generated fallback comment ID: ${r}`),r}catch(t){return s.content.error("Error extracting comment ID:",t),null}}watchPageChanges(){let e=window.location.href;const t=()=>{const n=window.location.href;if(n!==e){e=n;const o=this.pageDetector.detectPageType(),r=o!==this.currentPageType,i=this.isPullRequestTabChange(window.location.href,e);if(r&&(this.currentPageType=o,this.observer&&(this.currentPageType==="issue"||this.currentPageType==="pullRequest"||this.currentPageType==="issueModal")&&this.observer.updatePageType(this.currentPageType)),r||i){s.content.debug(`CommentUrlCopy: Page change detected - pageType: ${r?"changed":"same"}, prTab: ${i?"changed":"same"}`);const a=i&&this.isPullRequestCommentsTab()?200:500;setTimeout(()=>{this.processExistingComments(),i&&this.isPullRequestCommentsTab()&&this.scheduleRetryProcessing()},a)}}};d.observeChanges(t)}isPullRequestTabChange(e,t){if(!this.isPullRequestUrl(e)||!this.isPullRequestUrl(t))return!1;const n=i=>i.replace(/\/(diff|files)(\?.*)?$/,""),o=n(e),r=n(t);if(o===r){const i=e!==o,a=t!==r;return i!==a||i&&a&&e!==t}return!1}isPullRequestUrl(e){try{const t=new URL(e);return t.pathname.includes("/git/")&&t.pathname.includes("/pullRequests/")}catch{return!1}}isPullRequestCommentsTab(){const e=window.location.pathname;return this.isPullRequestUrl(window.location.href)&&!e.endsWith("/diff")&&!e.endsWith("/history")}isCommentElement(e){const n=["comment-item__inner","comment-item","ticket-comment","issue-comment"].some(h=>e.classList.contains(h)),o=e.classList.contains("comment-url-copy-injected"),i=["comment-list","TicketCommentList","pr-comment-list","comment-list__mask","loading--circle","loading","spinner","mask","overlay","dropdown","dropdown-menu","tooltip","popup","modal"].some(h=>e.classList.contains(h)),a=e.classList.contains("comment-item__actions")||e.classList.contains("comment-actions"),l=e.style.display==="none"||e.hidden||e.classList.contains("hidden")||e.classList.contains("is-hidden"),u=!!(e.querySelector(".comment-content")||e.querySelector(".markdown-body")||e.querySelector(".loom")||e.querySelector(".comment-item__container"));return n&&!o&&!i&&!a&&!l&&u}removeAllEventListeners(){this.eventListeners.forEach((e,t)=>{t.removeEventListener("click",e)}),this.eventListeners.clear()}removeAllButtons(){document.querySelectorAll(".comment-url-copy-btn").forEach(n=>{n.remove()}),document.querySelectorAll(".comment-url-copy-injected").forEach(n=>{n.classList.remove("comment-url-copy-injected")})}cleanupInvalidButtons(){try{s.content.debug("Cleaning up invalid buttons...");const e=document.querySelectorAll(".comment-url-copy-btn");let t=0;e.forEach(o=>{var i;const r=o.closest(".comment-item, .comment-item__inner, .ticket-comment, .issue-comment");(!r||!this.isCommentElement(r))&&(s.content.debug("Removing invalid button from:",(i=o.parentElement)==null?void 0:i.className),o.remove(),t++)}),document.querySelectorAll(".comment-url-copy-injected").forEach(o=>{this.isCommentElement(o)||o.classList.remove("comment-url-copy-injected")}),t>0&&s.content.info(`Cleaned up ${t} invalid buttons`)}catch(e){s.content.error("Error during cleanup:",e)}}scheduleRetryProcessing(){const e=window.location.hash.startsWith("#comment-"),t=e?[500,1e3,2e3,3e3,4e3]:[500,1e3,2e3];let n=0;const o=document.querySelectorAll(".comment-url-copy-btn").length;e&&s.content.info(`CommentUrlCopy: Detected comment fragment in URL: ${window.location.hash}, using extended retry schedule`);const r=()=>{if(n>=t.length){s.content.debug("CommentUrlCopy: Max retry attempts reached");return}const i=document.querySelectorAll(".comment-url-copy-btn").length;s.content.debug(`CommentUrlCopy: Retry ${n+1} starting, current buttons: ${i}`);const a=document.querySelectorAll(".comment-item, .comment-item__inner, .ticket-comment, .issue-comment").length;if(s.content.debug(`CommentUrlCopy: Found ${a} potential comment elements`),e){const u=document.querySelector(window.location.hash);s.content.debug(`CommentUrlCopy: Fragment target ${window.location.hash} ${u?"found":"not found"}`)}this.processExistingComments();const l=document.querySelectorAll(".comment-url-copy-btn").length;if(s.content.debug(`CommentUrlCopy: Retry ${n+1}, buttons before: ${i}, after: ${l}`),l>o||l>i){s.content.info(`CommentUrlCopy: Successfully processed comments on retry ${n+1}`);return}if(a>0&&l===i){s.content.debug("CommentUrlCopy: Comment elements exist but no buttons added, may already be processed");const u=e?2:1;if(n>=u){s.content.debug(`CommentUrlCopy: Stopping retries - comments exist but no new buttons needed (threshold: ${u})`);return}}n++,n<t.length&&setTimeout(r,t[n])};setTimeout(r,t[0])}schedulePostSubmitProcessing(e="button"){s.content.info(`CommentUrlCopy: Comment submit triggered by ${e}, scheduling post-submit processing`),[1e3,2e3,3e3].forEach((n,o)=>{setTimeout(()=>{s.content.debug(`CommentUrlCopy: Post-submit processing attempt ${o+1} (triggered by ${e})`),this.processExistingComments()},n)})}watchCommentSubmitButton(){const e=()=>{this.schedulePostSubmitProcessing("button")};this.submitButtonListener=e;const t=()=>{const o=document.querySelectorAll('button[type="submit"][aria-label*="コメントを登録"], button.button--primary[aria-label*="登録"], input[type="submit"][value*="登録"]');o.forEach(r=>{!r.hasAttribute("data-comment-submit-listener")&&this.submitButtonListener&&(r.addEventListener("click",this.submitButtonListener),r.setAttribute("data-comment-submit-listener","true"),s.content.debug("CommentUrlCopy: Added submit button listener"))}),o.length===0&&document.querySelectorAll('button[type="submit"], input[type="submit"]').forEach(i=>{var u;const a=((u=i.textContent)==null?void 0:u.trim())||"",l=i.getAttribute("aria-label")||"";(a.includes("登録")||l.includes("登録")||l.includes("コメント"))&&!i.hasAttribute("data-comment-submit-listener")&&this.submitButtonListener&&(i.addEventListener("click",this.submitButtonListener),i.setAttribute("data-comment-submit-listener","true"),s.content.debug(`CommentUrlCopy: Added general submit button listener: ${a||l}`))})};t(),new MutationObserver(()=>{t()}).observe(document.body,{childList:!0,subtree:!0}),s.content.info("CommentUrlCopy: Submit button monitoring started")}watchCommentKeyboardSubmit(){const e=t=>{if((t.ctrlKey||t.metaKey)&&t.key==="Enter"){const n=t.target;this.isCommentInputElement(n)&&(s.content.debug("CommentUrlCopy: Ctrl+Enter detected in comment input field"),this.schedulePostSubmitProcessing("keyboard"))}};this.keyboardSubmitListener=e,this.keyboardSubmitListener&&document.addEventListener("keydown",this.keyboardSubmitListener,!0),s.content.info("CommentUrlCopy: Keyboard shortcut monitoring started (Ctrl+Enter)")}isCommentInputElement(e){if(!e)return!1;if(e.tagName.toLowerCase()==="textarea"){const t=e.classList.toString(),n=e.getAttribute("name")||"",o=e.id||"";return t.includes("comment")||t.includes("ticket")||t.includes("issue")||n.includes("comment")||n.includes("content")||o.includes("comment")||o.includes("content")}if(e.getAttribute("contenteditable")==="true"){const t=e.classList.toString(),n=e.closest('form, .comment-form, .ticket-form, [class*="comment"]');return t.includes("comment")||t.includes("editor")||n!==null}return!1}removeSubmitButtonListener(){this.submitButtonListener&&(document.querySelectorAll("[data-comment-submit-listener]").forEach(t=>{this.submitButtonListener&&t.removeEventListener("click",this.submitButtonListener),t.removeAttribute("data-comment-submit-listener")}),this.submitButtonListener=null,s.content.debug("CommentUrlCopy: Submit button listeners removed"))}removeKeyboardSubmitListener(){this.keyboardSubmitListener&&(document.removeEventListener("keydown",this.keyboardSubmitListener,!0),this.keyboardSubmitListener=null,s.content.debug("CommentUrlCopy: Keyboard shortcut listeners removed"))}}s.content.info("Content script loaded",{url:window.location.href,time:new Date().toISOString()});class ve{constructor(){m(this,"settings",null);m(this,"features",new Map);s.content.debug("BacklogUsabilityEnhance constructor called"),this.init(),this.setupMessageListener()}getFeature(e){return this.features.get(e)||null}async init(){try{s.content.info("Starting initialization process"),s.content.info("Current URL:",window.location.href),s.content.info("Current hostname:",window.location.hostname);const e=d.isBacklogPage();if(s.content.info("Is Backlog page:",e),!e){s.content.info("Not a Backlog page, skipping initialization");return}s.content.info("Initializing Backlog Usability Enhance"),this.injectDesignSystemCSS(),await this.loadSettings(),this.watchSettingsChanges(),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.onDOMReady()):this.onDOMReady(),d.log("Initialization completed")}catch(e){s.content.error("Failed to initialize Backlog Usability Enhance:",e)}}async loadSettings(){this.settings=await w.getSettings(),d.log("Settings loaded:",this.settings)}watchSettingsChanges(){w.onSettingsChanged(e=>{d.log("Settings changed (from storage):",e),this.handleSettingsChange(e)})}setupMessageListener(){typeof chrome<"u"&&chrome.runtime&&(chrome.runtime.onMessage.addListener((e,t,n)=>(this.handleExtensionMessage(e,t,n),!0)),s.content.info("Extension message listener setup complete"))}async handleExtensionMessage(e,t,n){try{if(s.content.debug("Received extension message:",e),!e||typeof e.type!="string"){s.content.warn("Invalid message format:",e),n({success:!1,error:"Invalid message format"});return}switch(e.type){case"SETTINGS_CHANGED":{const o=e;if(!o.settings){s.content.warn("Missing settings in SETTINGS_CHANGED message"),n({success:!1,error:"Missing settings data"});return}s.content.info("Settings changed (from popup):",o.settings),this.handleSettingsChange(o.settings),n({success:!0});break}default:s.content.warn("Unknown message type:",e.type),n({success:!1,error:"Unknown message type"})}}catch(o){s.content.error("Error in handleExtensionMessage:",o);const r=o instanceof Error?o.message:"Unknown error";n({success:!1,error:r})}}handleSettingsChange(e){const t=this.settings;this.settings=e,this.updateFeatureSettings(t,e),this.applySettings()}updateFeatureSettings(e,t){if(!e)return;const n={boardAccordion:e.boardAccordion.enabled!==t.boardAccordion.enabled,shortcutKeys:e.shortcutKeys.enabled!==t.shortcutKeys.enabled,issuePending:e.issuePending.enabled!==t.issuePending.enabled,prFormat:e.prFormat.enabled!==t.prFormat.enabled,commentUrlCopy:e.commentUrlCopy.enabled!==t.commentUrlCopy.enabled};if(n.boardAccordion){const o=this.features.get("boardAccordion");o&&(o.destroy(),this.features.delete("boardAccordion"),d.log("Destroyed boardAccordion feature due to enabled status change"))}if(n.shortcutKeys){const o=this.features.get("shortcutKeys");o&&(o.destroy(),this.features.delete("shortcutKeys"),d.log("Destroyed shortcutKeys feature due to enabled status change"))}if(n.issuePending){const o=this.features.get("issuePending");o&&(o.destroy(),this.features.delete("issuePending"),d.log("Destroyed issuePending feature due to enabled status change"))}if(n.prFormat){const o=this.features.get("prFormat");o&&(o.destroy(),this.features.delete("prFormat"),d.log("Destroyed prFormat feature due to enabled status change"))}if(n.commentUrlCopy){const o=this.features.get("commentUrlCopy");o&&(o.destroy(),this.features.delete("commentUrlCopy"),d.log("Destroyed commentUrlCopy feature due to enabled status change"))}for(const[o,r]of this.features)if(r.updateSettings)try{r.updateSettings(t),d.log(`Updated settings for feature '${o}'`)}catch(i){s.error(`Failed to update settings for feature '${o}':`,i)}}onDOMReady(){if(!this.settings){d.log("Settings not loaded yet");return}d.log("DOM ready, applying settings"),this.applySettings(),this.watchPageChanges()}applySettings(){if(!this.settings)return;const e=d.getPageInfo();d.log("Current page info:",e),this.toggleFeature("boardAccordion",this.settings.boardAccordion.enabled,()=>{if(e.type==="board"){d.log("Initializing board accordion feature");const t=new de;t.init(),this.features.set("boardAccordion",{init:()=>t.init(),destroy:()=>t.destroy(),updateSettings:()=>{},_instance:t})}}),this.toggleFeature("shortcutKeys",this.settings.shortcutKeys.enabled,()=>{d.log("Initializing shortcut keys feature");const t=new H;t.init(),this.features.set("shortcutKeys",{init:()=>t.init(),destroy:()=>t.destroy()})}),this.toggleFeature("issuePending",this.settings.issuePending.enabled,()=>{if(e.type==="board"){d.log("Initializing issue pending feature");const t=new me;t.init(),this.features.set("issuePending",{init:()=>t.init(),destroy:()=>t.destroy(),_instance:t})}}),this.toggleFeature("prFormat",this.settings.prFormat.enabled,()=>{if(e.type==="git"){d.log("Initializing PR format auto insert feature");const t=new he;t.init(),this.features.set("prFormat",{init:()=>t.init(),destroy:()=>t.destroy(),updateSettings:()=>t.updateSettings(),_instance:t})}}),this.toggleFeature("commentUrlCopy",this.settings.commentUrlCopy.enabled,()=>{var t;if(e.type==="issue"||e.type==="git"){d.log("Initializing comment URL copy feature for page type:",e.type);const n=new be({enabled:((t=this.settings)==null?void 0:t.commentUrlCopy.enabled)??!0});n.init(),this.features.set("commentUrlCopy",{init:()=>n.init(),destroy:()=>n.destroy(),updateSettings:()=>n.updateSettings(),_instance:n})}else d.log("CommentUrlCopy feature not initialized - wrong page type:",e.type)})}toggleFeature(e,t,n){const o=this.features.get(e);if(t){if(!o)try{n(),d.log(`Feature '${e}' enabled`)}catch(r){s.error(`Failed to enable feature '${e}':`,r)}}else if(o)try{o.destroy(),this.features.delete(e),d.log(`Feature '${e}' disabled`)}catch(r){s.error(`Failed to disable feature '${e}':`,r)}}watchPageChanges(){let e=window.location.href;d.observeChanges(()=>{const t=window.location.href;t!==e&&(e=t,d.log("Page changed:",t),setTimeout(()=>{this.applySettings()},100))})}injectDesignSystemCSS(){try{if(document.querySelector("#bue-design-system")){s.content.debug("Design system CSS already injected");return}const e=`
        /* Backlog Usability Enhance - Design System Variables */
        :root {
          /* プライマリーカラー */
          --primary-color: #007bff;
          --primary-hover: #0056b3;
          --primary-active: #004494;
          --primary-light: #f0f7ff;
          
          /* セカンダリーカラー */
          --secondary-color: #6c757d;
          --secondary-hover: #545b62;
          --secondary-light: #f8f9fa;
          
          /* アクセントカラー */
          --success-color: #28a745;
          --success-hover: #218838;
          --warning-color: #ffc107;
          --warning-hover: #e0a800;
          --error-color: #dc3545;
          --error-hover: #c82333;
          
          /* ニュートラルカラー */
          --gray-50: #f8f9fa;
          --gray-100: #f0f0f0;
          --gray-200: #e9ecef;
          --gray-300: #dee2e6;
          --gray-400: #ced4da;
          --gray-500: #adb5bd;
          --gray-600: #6c757d;
          --gray-700: #495057;
          --gray-800: #343a40;
          --gray-900: #212529;
          
          /* テキストカラー */
          --text-primary: #333;
          --text-secondary: #666;
          --text-muted: #999;
          --text-inverse: #fff;
          
          /* 背景色 */
          --bg-primary: #ffffff;
          --bg-secondary: #f8f9fa;
          --bg-tertiary: #f5f5f5;
          
          /* ボーダー */
          --border-color: #e9ecef;
          --border-radius-sm: 3px;
          --border-radius: 4px;
          --border-radius-md: 6px;
          --border-radius-lg: 8px;
          
          /* スペーシング */
          --spacing-xs: 2px;
          --spacing-sm: 4px;
          --spacing-md: 8px;
          --spacing-lg: 12px;
          --spacing-xl: 16px;
          --spacing-xxl: 24px;
          
          /* フォント */
          --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          --font-size-xs: 10px;
          --font-size-sm: 11px;
          --font-size-base: 13px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 600;
          
          /* 行間 */
          --line-height-tight: 1.2;
          --line-height-base: 1.4;
          --line-height-relaxed: 1.6;
          
          /* シャドウ */
          --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
          --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
          --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.15);
          
          /* トランジション */
          --transition-fast: 0.15s ease;
          --transition-base: 0.2s ease;
          --transition-slow: 0.3s ease;
        }

        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
          :root {
            --primary-color: #60a5fa;
            --primary-hover: #3b82f6;
            --primary-active: #2563eb;
            --primary-light: #1e3a8a;
            
            --success-color: #10b981;
            --success-hover: #059669;
            --warning-color: #f59e0b;
            --warning-hover: #d97706;
            --error-color: #ef4444;
            --error-hover: #dc2626;
            
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --text-inverse: #000;
            
            --bg-primary: #2a2a2a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #404040;
            
            --border-color: #404040;
            
            --gray-50: #525252;
            --gray-100: #404040;
            --gray-200: #374151;
            --gray-300: #4b5563;
            --gray-400: #6b7280;
            --gray-500: #9ca3af;
            --gray-600: #d1d5db;
            --gray-700: #e5e7eb;
            --gray-800: #f3f4f6;
            --gray-900: #f9fafb;
          }
        }

        /* ベースボタンスタイル */
        .bue-button {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--spacing-sm) var(--spacing-lg);
          font-family: var(--font-family);
          font-size: var(--font-size-base);
          font-weight: var(--font-weight-medium);
          line-height: var(--line-height-tight);
          text-decoration: none;
          border: 1px solid transparent;
          border-radius: var(--border-radius);
          cursor: pointer;
          transition: all var(--transition-base);
          user-select: none;
          white-space: nowrap;
          background: none;
          outline: none;
        }

        .bue-button:focus {
          outline: 2px solid var(--primary-color);
          outline-offset: 2px;
        }

        .bue-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          pointer-events: none;
        }

        /* ボタンバリエーション */
        .bue-button--primary {
          background-color: var(--primary-color);
          color: var(--text-inverse);
          border-color: var(--primary-color);
        }

        .bue-button--primary:hover:not(:disabled) {
          background-color: var(--primary-hover);
          border-color: var(--primary-hover);
        }

        .bue-button--secondary {
          background-color: var(--secondary-color);
          color: var(--text-inverse);
          border-color: var(--secondary-color);
        }

        .bue-button--secondary:hover:not(:disabled) {
          background-color: var(--secondary-hover);
          border-color: var(--secondary-hover);
        }

        .bue-button--ghost {
          background-color: transparent;
          color: var(--text-primary);
          border-color: var(--border-color);
        }

        .bue-button--ghost:hover:not(:disabled) {
          background-color: var(--gray-50);
          color: var(--text-primary);
        }

        .bue-button--minimal {
          background-color: transparent;
          color: var(--text-secondary);
          border: none;
          padding: var(--spacing-xs) var(--spacing-sm);
        }

        .bue-button--minimal:hover:not(:disabled) {
          background-color: var(--gray-100);
          color: var(--text-primary);
        }

        /* ボタンサイズ */
        .bue-button--xs {
          padding: var(--spacing-xs) var(--spacing-sm);
          font-size: var(--font-size-xs);
          border-radius: var(--border-radius-sm);
        }

        .bue-button--sm {
          padding: var(--spacing-sm) var(--spacing-md);
          font-size: var(--font-size-sm);
          border-radius: var(--border-radius-sm);
        }

        .bue-button--lg {
          padding: var(--spacing-lg) var(--spacing-xxl);
          font-size: var(--font-size-lg);
          border-radius: var(--border-radius-md);
        }

        /* アイコンボタン */
        .bue-button--icon {
          width: 32px;
          height: 32px;
          padding: 0;
          border-radius: var(--border-radius);
        }

        .bue-button--icon.bue-button--sm {
          width: 24px;
          height: 24px;
        }

        .bue-button--icon.bue-button--lg {
          width: 40px;
          height: 40px;
        }

        /* フォーカス管理 */
        .bue-focus-visible:focus {
          outline: 2px solid var(--primary-color);
          outline-offset: 2px;
        }

        /* モーションを避けたいユーザー向け */
        @media (prefers-reduced-motion: reduce) {
          .bue-button {
            transition: none !important;
          }
        }
      `,t=document.createElement("style");t.id="bue-design-system",t.textContent=e,document.head.insertBefore(t,document.head.firstChild),s.content.info("Design system CSS injected successfully")}catch(e){s.content.error("Failed to inject design system CSS:",e)}}destroy(){d.log("Destroying Backlog Usability Enhance");for(const[t,n]of this.features)try{n.destroy(),d.log(`Feature '${t}' destroyed`)}catch(o){s.error(`Failed to destroy feature '${t}':`,o)}this.features.clear();const e=document.querySelector("#bue-design-system");e&&e.remove()}}s.content.info("Creating BacklogUsabilityEnhance instance...");const J=new ve;s.content.info("BacklogUsabilityEnhance instance created successfully"),window.__backlog_usability_enhance__=J,window.__backlog_usability_enhance_dev__=!0,window.addEventListener("beforeunload",()=>{J.destroy()})})();
