var p=Object.defineProperty;var l=(o,e,t)=>e in o?p(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var a=(o,e,t)=>l(o,typeof e!="symbol"?e+"":e,t);import{S as d}from"../assets/storage.js";import{l as n}from"../assets/logger.js";class u{constructor(){a(this,"settings",null)}async init(){try{n.popup.info("Initializing toolbar popup"),await this.loadSettings(),this.setupEventListeners(),this.updateUI(),n.popup.info("Toolbar popup initialized successfully")}catch(e){n.popup.error("Failed to initialize popup:",e)}}async loadSettings(){try{this.settings=await d.getSettings(),n.popup.debug("Settings loaded:",this.settings)}catch(e){throw n.popup.error("Failed to load settings:",e),new Error("設定の読み込みに失敗しました")}}async saveSettings(){if(!this.settings)throw new Error("No settings to save");try{await d.saveSettings(this.settings),n.popup.info("Settings saved successfully"),await this.notifySettingsChange()}catch(e){throw n.popup.error("Failed to save settings:",e),e}}async notifySettingsChange(){try{const t=(await chrome.tabs.query({url:["https://*.backlog.jp/*","https://*.backlog.com/*"]})).map(async s=>{if(s.id)try{await chrome.tabs.sendMessage(s.id,{type:"SETTINGS_CHANGED",settings:this.settings}),n.popup.debug(`Settings change notified to tab ${s.id}`)}catch(i){n.popup.debug(`Failed to notify tab ${s.id}:`,i)}});await Promise.allSettled(t),n.popup.info("Settings change notifications sent to all Backlog tabs")}catch(e){n.popup.warn("Failed to notify some tabs of settings change:",e)}}setupEventListeners(){this.setupToggleListener("boardAccordionEnabled","boardAccordion","enabled"),this.setupToggleListener("shortcutKeysEnabled","shortcutKeys","enabled"),this.setupToggleListener("issuePendingEnabled","issuePending","enabled"),this.setupToggleListener("issuePendingAutoResolve","issuePending","autoResolve");const e=document.getElementById("openOptionsButton");e&&e.addEventListener("click",this.handleOpenOptions.bind(this));const t=document.getElementById("issuePendingEnabled");t&&t.addEventListener("change",()=>{this.updateSubSettingsVisibility("issuePendingSubSettings",t.checked)})}setupToggleListener(e,t,s){const i=document.getElementById(e);i&&i.addEventListener("change",async()=>{await this.handleToggleChange(t,s,i.checked)})}async handleToggleChange(e,t,s){if(!this.settings){n.popup.error("No settings available for toggle change");return}try{this.settings[e][t]=s;const i=document.querySelector(`#${this.getElementIdForSetting(e,t)} + .slider`);i&&i.setAttribute("aria-checked",s.toString()),await this.saveSettings(),n.popup.debug(`Setting ${e}.${t} changed to ${s}`)}catch(i){n.popup.error(`Failed to update setting ${e}.${t}:`,i),this.updateUI()}}getElementIdForSetting(e,t){return{"boardAccordion.enabled":"boardAccordionEnabled","shortcutKeys.enabled":"shortcutKeysEnabled","issuePending.enabled":"issuePendingEnabled","issuePending.autoResolve":"issuePendingAutoResolve"}[`${e}.${t}`]||""}async handleOpenOptions(){try{await chrome.runtime.openOptionsPage(),window.close()}catch(e){n.popup.error("Failed to open options page:",e)}}updateUI(){if(!this.settings){n.popup.warn("No settings available for UI update");return}this.updateToggle("boardAccordionEnabled",this.settings.boardAccordion.enabled),this.updateToggle("shortcutKeysEnabled",this.settings.shortcutKeys.enabled),this.updateToggle("issuePendingEnabled",this.settings.issuePending.enabled),this.updateToggle("issuePendingAutoResolve",this.settings.issuePending.autoResolve),this.updateSubSettingsVisibility("issuePendingSubSettings",this.settings.issuePending.enabled)}updateToggle(e,t){const s=document.getElementById(e);if(s){s.checked=t;const i=s.nextElementSibling;i&&i.setAttribute("aria-checked",t.toString())}}updateSubSettingsVisibility(e,t){const s=document.getElementById(e);s&&(t?s.classList.add("enabled"):s.classList.remove("enabled"),s.querySelectorAll('input[type="checkbox"]').forEach(g=>{g.disabled=!t}))}destroy(){n.popup.info("Popup manager destroyed")}}document.addEventListener("DOMContentLoaded",async()=>{const o=new u;await o.init(),window.addEventListener("beforeunload",()=>{o.destroy()})});var r;typeof chrome<"u"&&chrome.runtime&&((r=chrome.runtime.onSuspend)==null||r.addListener(()=>{n.popup.debug("Popup suspended")}));
