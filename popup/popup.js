var ne=Object.defineProperty;var oe=(p,y,w)=>y in p?ne(p,y,{enumerable:!0,configurable:!0,writable:!0,value:w}):p[y]=w;var M=(p,y,w)=>oe(p,typeof y!="symbol"?y+"":y,w);(function(){"use strict";var D;const p={boardAccordion:{enabled:!0},shortcutKeys:{enabled:!0},issuePending:{enabled:!0,autoResolve:!0}};var y=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function w(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var x={exports:{}};(function(n){(function(t,e){n.exports?n.exports=e():t.log=e()})(y,function(){var t=function(){},e="undefined",i=typeof window!==e&&typeof window.navigator!==e&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],u={},c=null;function m(s,g){var o=s[g];if(typeof o.bind=="function")return o.bind(s);try{return Function.prototype.bind.call(o,s)}catch{return function(){return Function.prototype.apply.apply(o,[s,arguments])}}}function T(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function A(s){return s==="debug"&&(s="log"),typeof console===e?!1:s==="trace"&&i?T:console[s]!==void 0?m(console,s):console.log!==void 0?m(console,"log"):t}function b(){for(var s=this.getLevel(),g=0;g<r.length;g++){var o=r[g];this[o]=g<s?t:this.methodFactory(o,s,this.name)}if(this.log=this.debug,typeof console===e&&s<this.levels.SILENT)return"No console available for logging"}function O(s){return function(){typeof console!==e&&(b.call(this),this[s].apply(this,arguments))}}function R(s,g,o){return A(s)||O.apply(this,arguments)}function I(s,g){var o=this,P,K,E,h="loglevel";typeof s=="string"?h+=":"+s:typeof s=="symbol"&&(h=void 0);function Z(l){var d=(r[l]||"silent").toUpperCase();if(!(typeof window===e||!h)){try{window.localStorage[h]=d;return}catch{}try{window.document.cookie=encodeURIComponent(h)+"="+d+";"}catch{}}}function B(){var l;if(!(typeof window===e||!h)){try{l=window.localStorage[h]}catch{}if(typeof l===e)try{var d=window.document.cookie,C=encodeURIComponent(h),Y=d.indexOf(C+"=");Y!==-1&&(l=/^([^;]+)/.exec(d.slice(Y+C.length+1))[1])}catch{}return o.levels[l]===void 0&&(l=void 0),l}}function ee(){if(!(typeof window===e||!h)){try{window.localStorage.removeItem(h)}catch{}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function F(l){var d=l;if(typeof d=="string"&&o.levels[d.toUpperCase()]!==void 0&&(d=o.levels[d.toUpperCase()]),typeof d=="number"&&d>=0&&d<=o.levels.SILENT)return d;throw new TypeError("log.setLevel() called with invalid level: "+l)}o.name=s,o.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},o.methodFactory=g||R,o.getLevel=function(){return E??K??P},o.setLevel=function(l,d){return E=F(l),d!==!1&&Z(E),b.call(o)},o.setDefaultLevel=function(l){K=F(l),B()||o.setLevel(l,!1)},o.resetLevel=function(){E=null,ee(),b.call(o)},o.enableAll=function(l){o.setLevel(o.levels.TRACE,l)},o.disableAll=function(l){o.setLevel(o.levels.SILENT,l)},o.rebuild=function(){if(c!==o&&(P=F(c.getLevel())),b.call(o),c===o)for(var l in u)u[l].rebuild()},P=F(c?c.getLevel():"WARN");var G=B();G!=null&&(E=F(G)),b.call(o)}c=new I,c.getLogger=function(g){if(typeof g!="symbol"&&typeof g!="string"||g==="")throw new TypeError("You must supply a name when creating a logger.");var o=u[g];return o||(o=u[g]=new I(g,c.methodFactory)),o};var U=typeof window!==e?window.log:void 0;return c.noConflict=function(){return typeof window!==e&&window.log===c&&(window.log=U),c},c.getLoggers=function(){return u},c.default=c,c})})(x);var W=x.exports;const f=w(W),N={level:"info",prefix:"[Backlog Enhancement]",timestamp:!0},L={boardAccordion:"error",issuePending:"error",shortcutKeys:"error",storage:"error",backlog:"error",background:"error",options:"error",content:"error"},$=new Map;function z(n){f.setLevel(n)}function S(n,t){const e=$.get(n);e&&e.setLevel(t),L[n]=t}function V(n){return L[n]||"info"}function j(){return{...L}}function q(n){const t=$.get(n);if(t)return t;const e=f.getLogger(n),i=L[n]||"info";e.setLevel(i);const r=e.methodFactory;return e.methodFactory=function(u,c,m){const T=r(u,c,m);return function(...A){const b=`[${new Date().toISOString()}]`,O=`${N.prefix}`,R=`[${u.toUpperCase()}]`,I=`[${n.charAt(0).toUpperCase()+n.slice(1)}]`,U=[`${b} ${O} ${R} ${I}`,...A].filter(Boolean);T(...U)}},e.setLevel(e.getLevel()),$.set(n,e),e}function _(){if(typeof window>"u"||typeof chrome>"u")return!0;try{return window.location.hostname==="localhost"||window.location.hostname.includes("dev")||chrome.runtime.getManifest().version.includes("dev")}catch{return!0}}function H(n){const t=f.methodFactory;f.methodFactory=function(e,i,r){const u=t(e,i,r);return function(...c){const m=n.timestamp?`[${new Date().toISOString()}]`:"",T=n.prefix?`${n.prefix}`:"",A=`[${e.toUpperCase()}]`,b=[`${m} ${T} ${A}`,...c].filter(Boolean);u(...b)}},f.setLevel(f.getLevel())}function J(n){const t={...N,...n};_()?t.level="debug":t.level="warn",H(t),z(t.level),f.info("Logger initialized",{level:t.level,isDev:_()})}function v(n){const t=q(n);return{debug:(...e)=>t.debug(...e),info:(...e)=>t.info(...e),warn:(...e)=>t.warn(...e),error:(...e)=>t.error(...e)}}const a={debug:(...n)=>f.debug(...n),info:(...n)=>f.info(...n),warn:(...n)=>f.warn(...n),error:(...n)=>f.error(...n),boardAccordion:v("boardAccordion"),issuePending:v("issuePending"),shortcutKeys:v("shortcutKeys"),storage:v("storage"),backlog:v("backlog"),background:v("background"),options:v("options"),content:v("content"),popup:v("popup")},Q={setLevel:S,getLevel:V,showAll:()=>{console.table(j())},enable:n=>{S(n,"debug"),console.log(`✅ ${n} logging enabled (debug level)`)},disable:n=>{S(n,"silent"),console.log(`❌ ${n} logging disabled`)},enableAll:()=>{Object.keys(L).forEach(n=>{S(n,"debug")}),console.log("✅ All feature logging enabled")},disableAll:()=>{Object.keys(L).forEach(n=>{S(n,"error")}),console.log("❌ All feature logging disabled (error only)")}};typeof window<"u"&&_()&&(window.__backlogLoggerControl__=Q),J();class k{static async getSettings(){try{const e=(await chrome.storage.sync.get(this.SETTINGS_KEY))[this.SETTINGS_KEY];return e?this.mergeWithDefaults(e):p}catch(t){return a.storage.error("Failed to get settings:",t),p}}static async saveSettings(t){try{await chrome.storage.sync.set({[this.SETTINGS_KEY]:t})}catch(e){throw a.storage.error("Failed to save settings:",e),e}}static onSettingsChanged(t){chrome.storage.onChanged.addListener((e,i)=>{if(i==="sync"&&e[this.SETTINGS_KEY]){const r=e[this.SETTINGS_KEY].newValue;r&&t(this.mergeWithDefaults(r))}})}static mergeWithDefaults(t){return{boardAccordion:{...p.boardAccordion,...t.boardAccordion},shortcutKeys:{...p.shortcutKeys,...t.shortcutKeys},issuePending:{...p.issuePending,...t.issuePending}}}}M(k,"SETTINGS_KEY","backlog_usability_enhance_settings");class X{constructor(){M(this,"settings",null)}async init(){try{a.popup.info("Initializing toolbar popup"),await this.loadSettings(),this.setupEventListeners(),this.updateUI(),a.popup.info("Toolbar popup initialized successfully")}catch(t){a.popup.error("Failed to initialize popup:",t)}}async loadSettings(){try{this.settings=await k.getSettings(),a.popup.debug("Settings loaded:",this.settings)}catch(t){throw a.popup.error("Failed to load settings:",t),new Error("設定の読み込みに失敗しました")}}async saveSettings(){if(!this.settings)throw new Error("No settings to save");try{await k.saveSettings(this.settings),a.popup.info("Settings saved successfully"),await this.notifySettingsChange()}catch(t){throw a.popup.error("Failed to save settings:",t),t}}async notifySettingsChange(){try{const e=(await chrome.tabs.query({url:["https://*.backlog.jp/*","https://*.backlog.com/*"]})).map(async i=>{if(i.id)try{await chrome.tabs.sendMessage(i.id,{type:"SETTINGS_CHANGED",settings:this.settings}),a.popup.debug(`Settings change notified to tab ${i.id}`)}catch(r){a.popup.debug(`Failed to notify tab ${i.id}:`,r)}});await Promise.allSettled(e),a.popup.info("Settings change notifications sent to all Backlog tabs")}catch(t){a.popup.warn("Failed to notify some tabs of settings change:",t)}}setupEventListeners(){this.setupToggleListener("boardAccordionEnabled","boardAccordion","enabled"),this.setupToggleListener("shortcutKeysEnabled","shortcutKeys","enabled"),this.setupToggleListener("issuePendingEnabled","issuePending","enabled"),this.setupToggleListener("issuePendingAutoResolve","issuePending","autoResolve");const t=document.getElementById("openOptionsButton");t&&t.addEventListener("click",this.handleOpenOptions.bind(this));const e=document.getElementById("issuePendingEnabled");e&&e.addEventListener("change",()=>{this.updateSubSettingsVisibility("issuePendingSubSettings",e.checked)})}setupToggleListener(t,e,i){const r=document.getElementById(t);r&&r.addEventListener("change",async()=>{await this.handleToggleChange(e,i,r.checked)})}async handleToggleChange(t,e,i){if(!this.settings){a.popup.error("No settings available for toggle change");return}try{this.settings[t][e]=i;const r=document.querySelector(`#${this.getElementIdForSetting(t,e)} + .slider`);r&&r.setAttribute("aria-checked",i.toString()),await this.saveSettings(),a.popup.debug(`Setting ${t}.${e} changed to ${i}`)}catch(r){a.popup.error(`Failed to update setting ${t}.${e}:`,r),this.updateUI()}}getElementIdForSetting(t,e){return{"boardAccordion.enabled":"boardAccordionEnabled","shortcutKeys.enabled":"shortcutKeysEnabled","issuePending.enabled":"issuePendingEnabled","issuePending.autoResolve":"issuePendingAutoResolve"}[`${t}.${e}`]||""}async handleOpenOptions(){try{await chrome.runtime.openOptionsPage(),window.close()}catch(t){a.popup.error("Failed to open options page:",t)}}updateUI(){if(!this.settings){a.popup.warn("No settings available for UI update");return}this.updateToggle("boardAccordionEnabled",this.settings.boardAccordion.enabled),this.updateToggle("shortcutKeysEnabled",this.settings.shortcutKeys.enabled),this.updateToggle("issuePendingEnabled",this.settings.issuePending.enabled),this.updateToggle("issuePendingAutoResolve",this.settings.issuePending.autoResolve),this.updateSubSettingsVisibility("issuePendingSubSettings",this.settings.issuePending.enabled)}updateToggle(t,e){const i=document.getElementById(t);if(i){i.checked=e;const r=i.nextElementSibling;r&&r.setAttribute("aria-checked",e.toString())}}updateSubSettingsVisibility(t,e){const i=document.getElementById(t);i&&(e?i.classList.add("enabled"):i.classList.remove("enabled"),i.querySelectorAll('input[type="checkbox"]').forEach(u=>{u.disabled=!e}))}destroy(){a.popup.info("Popup manager destroyed")}}document.addEventListener("DOMContentLoaded",async()=>{const n=new X;await n.init(),window.addEventListener("beforeunload",()=>{n.destroy()})}),typeof chrome<"u"&&chrome.runtime&&((D=chrome.runtime.onSuspend)==null||D.addListener(()=>{a.popup.debug("Popup suspended")}))})();
