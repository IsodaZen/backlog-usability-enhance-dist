var re=Object.defineProperty;var ne=(y,u,v)=>u in y?re(y,u,{enumerable:!0,configurable:!0,writable:!0,value:v}):y[u]=v;var R=(y,u,v)=>ne(y,typeof u!="symbol"?u+"":u,v);(function(){"use strict";var B;var y=document.createElement("style");y.textContent=`:root{--primary-color: #007bff;--primary-hover: #0056b3;--primary-active: #004494;--primary-light: #f0f7ff;--secondary-color: #6c757d;--secondary-hover: #545b62;--secondary-light: #f8f9fa;--success-color: #28a745;--success-hover: #218838;--warning-color: #ffc107;--warning-hover: #e0a800;--error-color: #dc3545;--error-hover: #c82333;--gray-50: #f8f9fa;--gray-100: #f0f0f0;--gray-200: #e9ecef;--gray-300: #dee2e6;--gray-400: #ced4da;--gray-500: #adb5bd;--gray-600: #6c757d;--gray-700: #495057;--gray-800: #343a40;--gray-900: #212529;--text-primary: #333;--text-secondary: #666;--text-muted: #999;--text-inverse: #fff;--bg-primary: #ffffff;--bg-secondary: #f8f9fa;--bg-tertiary: #f5f5f5;--bg-warning-element: #dc992514;--border-color: #e9ecef;--border-radius-sm: 3px;--border-radius: 4px;--border-radius-md: 6px;--border-radius-lg: 8px;--spacing-xs: 2px;--spacing-sm: 4px;--spacing-md: 8px;--spacing-lg: 12px;--spacing-xl: 16px;--spacing-xxl: 24px;--font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;--font-size-xs: 10px;--font-size-sm: 11px;--font-size-base: 13px;--font-size-md: 14px;--font-size-lg: 16px;--font-weight-normal: 400;--font-weight-medium: 500;--font-weight-semibold: 600;--line-height-tight: 1.2;--line-height-base: 1.4;--line-height-relaxed: 1.6;--shadow-sm: 0 1px 2px rgba(0, 0, 0, .05);--shadow: 0 2px 4px rgba(0, 0, 0, .1);--shadow-md: 0 4px 6px rgba(0, 0, 0, .1);--shadow-lg: 0 8px 16px rgba(0, 0, 0, .15);--transition-fast: .15s ease;--transition-base: .2s ease;--transition-slow: .3s ease;--z-dropdown: 1000;--z-sticky: 1020;--z-fixed: 1030;--z-modal: 1050;--z-popover: 1060;--z-tooltip: 1070}@media (prefers-color-scheme: dark){:root{--primary-color: #60a5fa;--primary-hover: #3b82f6;--primary-active: #2563eb;--primary-light: #1e3a8a;--success-color: #10b981;--success-hover: #059669;--warning-color: #f59e0b;--warning-hover: #d97706;--error-color: #ef4444;--error-hover: #dc2626;--text-primary: #e4e4e7;--text-secondary: #a1a1aa;--text-muted: #71717a;--text-inverse: #000;--bg-primary: #2a2a2a;--bg-secondary: #1a1a1a;--bg-tertiary: #404040;--bg-warning-element: #9e801214;--border-color: #404040;--gray-50: #525252;--gray-100: #404040;--gray-200: #374151;--gray-300: #4b5563;--gray-400: #6b7280;--gray-500: #9ca3af;--gray-600: #d1d5db;--gray-700: #e5e7eb;--gray-800: #f3f4f6;--gray-900: #f9fafb}}@media (prefers-contrast: high){:root{--primary-color: #000080;--primary-hover: #000060;--text-primary: #000;--text-secondary: #333;--border-color: #000}@media (prefers-color-scheme: dark){:root{--primary-color: #ffffff;--primary-hover: #cccccc;--text-primary: #fff;--text-secondary: #ccc;--border-color: #fff}}}.bue-button{display:inline-flex;align-items:center;justify-content:center;padding:var(--spacing-sm) var(--spacing-lg);font-family:var(--font-family);font-size:var(--font-size-base);font-weight:var(--font-weight-medium);line-height:var(--line-height-tight);text-decoration:none;border:1px solid transparent;border-radius:var(--border-radius);cursor:pointer;transition:all var(--transition-base);-webkit-user-select:none;user-select:none;white-space:nowrap;background:none;outline:none}.bue-button:focus{outline:2px solid var(--primary-color);outline-offset:2px}.bue-button:disabled{opacity:.5;cursor:not-allowed;pointer-events:none}.bue-button--primary{background-color:var(--primary-color);color:var(--text-inverse);border-color:var(--primary-color)}.bue-button--primary:hover:not(:disabled){background-color:var(--primary-hover);border-color:var(--primary-hover)}.bue-button--primary:active:not(:disabled){background-color:var(--primary-active);border-color:var(--primary-active)}.bue-button--secondary{background-color:var(--secondary-color);color:var(--text-inverse);border-color:var(--secondary-color)}.bue-button--secondary:hover:not(:disabled){background-color:var(--secondary-hover);border-color:var(--secondary-hover)}.bue-button--ghost{background-color:transparent;color:var(--text-primary);border-color:var(--border-color)}.bue-button--ghost:hover:not(:disabled){background-color:var(--gray-50);color:var(--text-primary)}.bue-button--minimal{background-color:transparent;color:var(--text-secondary);border:none;padding:var(--spacing-xs) var(--spacing-sm)}.bue-button--minimal:hover:not(:disabled){background-color:var(--gray-100);color:var(--text-primary)}.bue-button--xs{padding:var(--spacing-xs) var(--spacing-sm);font-size:var(--font-size-xs);border-radius:var(--border-radius-sm)}.bue-button--sm{padding:var(--spacing-sm) var(--spacing-md);font-size:var(--font-size-sm);border-radius:var(--border-radius-sm)}.bue-button--lg{padding:var(--spacing-lg) var(--spacing-xxl);font-size:var(--font-size-lg);border-radius:var(--border-radius-md)}.bue-button--icon{width:32px;height:32px;padding:0;border-radius:var(--border-radius)}.bue-button--icon.bue-button--sm{width:24px;height:24px}.bue-button--icon.bue-button--lg{width:40px;height:40px}.bue-toggle{position:relative;display:inline-block;width:50px;height:26px}.bue-toggle input{opacity:0;width:0;height:0}.bue-toggle__slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--gray-300);transition:var(--transition-base);border-radius:26px}.bue-toggle__slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;background-color:var(--bg-primary);transition:var(--transition-base);border-radius:50%;box-shadow:var(--shadow-sm)}.bue-toggle input:checked+.bue-toggle__slider{background-color:var(--success-color)}.bue-toggle input:checked+.bue-toggle__slider:before{transform:translate(24px)}.bue-toggle input:focus+.bue-toggle__slider{box-shadow:0 0 0 2px #28a7454d}.bue-toggle input:disabled+.bue-toggle__slider{opacity:.5;cursor:not-allowed}.bue-toggle--sm{width:40px;height:20px}.bue-toggle--sm .bue-toggle__slider:before{height:16px;width:16px;left:2px;bottom:2px}.bue-toggle--sm input:checked+.bue-toggle__slider:before{transform:translate(20px)}.bue-tooltip{position:relative;display:inline-block}.bue-tooltip__content{visibility:hidden;position:absolute;z-index:var(--z-tooltip);bottom:125%;left:50%;transform:translate(-50%);background-color:var(--gray-800);color:var(--text-inverse);text-align:center;padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--border-radius);font-size:var(--font-size-sm);white-space:nowrap;opacity:0;transition:opacity var(--transition-fast);box-shadow:var(--shadow-md)}.bue-tooltip__content:after{content:"";position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:var(--gray-800) transparent transparent transparent}.bue-tooltip:hover .bue-tooltip__content{visibility:visible;opacity:1}.bue-focus-visible:focus{outline:2px solid var(--primary-color);outline-offset:2px}@keyframes bue-fadeIn{0%{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}@keyframes bue-slideIn{0%{opacity:0;transform:translate(-8px)}to{opacity:1;transform:translate(0)}}.bue-animate-fade-in{animation:bue-fadeIn var(--transition-base) ease-out}.bue-animate-slide-in{animation:bue-slideIn var(--transition-base) ease-out}.bue-sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}.bue-text-truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.bue-visually-hidden{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;white-space:nowrap!important;border:0!important}@media (max-width: 768px){.bue-button{padding:var(--spacing-md) var(--spacing-lg);font-size:var(--font-size-md)}.bue-button--sm{padding:var(--spacing-sm) var(--spacing-lg);font-size:var(--font-size-base)}}@media (prefers-reduced-motion: reduce){.bue-button,.bue-toggle__slider,.bue-toggle__slider:before,.bue-tooltip__content{transition:none!important}.bue-animate-fade-in,.bue-animate-slide-in{animation:none!important}}*{box-sizing:border-box;margin:0;padding:0}body{font-family:var(--font-family);font-size:var(--font-size-base);line-height:var(--line-height-base);color:var(--text-primary);background-color:var(--bg-tertiary);width:320px;height:400px;overflow:hidden}.popup-container{display:flex;flex-direction:column;height:100%;background:var(--bg-tertiary);padding:var(--spacing-md)}.header{text-align:center;margin-bottom:12px;background:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 2px 4px #0000001a}.header h1{font-size:14px;font-weight:600;margin:0 0 4px;color:#333}.header p{font-size:10px;margin:0;color:#666}.settings-list{flex:1;overflow-y:auto}.setting-group{background:#fff;margin-bottom:8px;border-radius:8px;box-shadow:0 2px 4px #0000001a}.setting-group:last-child{margin-bottom:0}.setting-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #f0f0f0}.setting-item:last-child{border-bottom:none}.setting-item:hover{background-color:#f8f9fa}.setting-item:focus-within{background-color:#f0f7ff;outline:2px solid #007bff;outline-offset:-2px}.setting-info{flex:1;margin-right:16px;min-width:0}.setting-title{display:flex;align-items:center;font-weight:500;font-size:14px;color:#333}.setting-icon{margin-right:6px;font-size:14px}.setting-description{font-size:11px;color:#666;line-height:1.4}.setting-control{flex-shrink:0}.toggle{position:relative;display:inline-block;width:50px;height:26px}.toggle input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:26px}.slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;background-color:#fff;transition:.4s;border-radius:50%}input:checked+.slider{background-color:#4caf50}input:checked+.slider:before{transform:translate(24px)}input:focus+.slider{box-shadow:0 0 0 2px #4caf504d}input:disabled+.slider{opacity:.5;cursor:not-allowed}.sub-setting{margin-left:16px;padding-left:16px;border-left:2px solid #eee;opacity:.6;transition:opacity .3s ease}.sub-setting.enabled{opacity:1}.sub-setting .setting-item{margin-left:-16px;padding:8px 16px}.sub-setting .setting-item:hover{background-color:#f8f9fa}.sub-setting .setting-item:focus-within{background-color:#f0f7ff;outline:2px solid #007bff;outline-offset:-2px}.sub-setting .setting-title{font-size:12px;font-weight:400}.sub-setting .setting-description{font-size:10px}.sub-setting .toggle{width:40px;height:20px}.sub-setting .slider:before{height:16px;width:16px;left:2px;bottom:2px}.sub-setting input:checked+.slider:before{transform:translate(20px)}.footer{padding:12px 16px;background-color:#f8f9fa;border-top:1px solid #e9ecef;display:flex;flex-direction:column;gap:8px}.btn{background:#007bff;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;transition:background-color .2s ease;text-align:center;min-height:28px}.btn:hover{background:#0056b3}.btn:focus{outline:2px solid #007bff;outline-offset:2px}.btn:active{background:#004494}.btn.btn-secondary{background:#6c757d}.btn.btn-secondary:hover{background:#545b62}.btn:disabled{opacity:.5;cursor:not-allowed}.btn.btn-config{background:#17a2b8;color:#fff;font-size:13px;padding:4px 8px;margin-right:4px;min-height:24px}.btn.btn-config:hover{background:#138496}.btn.btn-config:focus{outline-color:#17a2b8}.setting-description{margin-top:2px}.setting-description .status-text{font-size:10px;color:#666}.setting-description .status-text.enabled{color:#28a745}.setting-description .status-text.disabled{color:#dc3545}.status-indicator{text-align:center}.status-text{font-size:11px;color:#666;font-style:italic}.status-text.success{color:#28a745}.status-text.error{color:#dc3545}.status-text.loading{color:#007bff}.settings-list::-webkit-scrollbar{width:6px}.settings-list::-webkit-scrollbar-track{background:#f8f9fa}.settings-list::-webkit-scrollbar-thumb{background:#dee2e6;border-radius:3px}.settings-list::-webkit-scrollbar-thumb:hover{background:#adb5bd}@keyframes fadeIn{0%{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}.popup-container{animation:fadeIn .2s ease-out}.toggle:focus-within{outline:2px solid #007bff;outline-offset:2px;border-radius:20px}@media (prefers-contrast: high){.header{background:#000;color:#fff}.setting-item:hover{background-color:#e0e0e0}.setting-item:focus-within{background-color:#d0d0d0}.slider{border:1px solid #000}input:checked+.slider{background-color:#000}}@media (prefers-color-scheme: dark){body{background-color:#1a1a1a;color:#e4e4e7}.popup-container{background:#1a1a1a}.header{background:#2a2a2a;border:1px solid #404040}.header h1{color:#e4e4e7}.header p{color:#a1a1aa}.setting-group{background:#2a2a2a;border:1px solid #404040}.setting-item{border-bottom-color:#404040}.setting-item:hover{background-color:#333}.setting-item:focus-within{background-color:#374151;outline-color:#60a5fa}.setting-title{color:#e4e4e7}.setting-description{color:#a1a1aa}.sub-setting{border-left-color:#525252}.slider{background-color:#525252}input:checked+.slider{background-color:#10b981}input:focus+.slider{box-shadow:0 0 0 2px #10b9814d}.footer{background-color:#2a2a2a;border-top:1px solid #404040}.btn{background:#374151;color:#e4e4e7}.btn:hover{background:#4b5563}.btn:focus{outline-color:#60a5fa}.btn.btn-secondary{background:#6b7280}.btn.btn-secondary:hover{background:#9ca3af}.btn.btn-config{background:#0891b2}.btn.btn-config:hover{background:#0e7490}}@media (max-width: 300px){body{width:280px}.header{padding:10px 12px}.header h1{font-size:13px}.setting-item{padding:8px 12px}.setting-title{font-size:12px}.setting-description{font-size:10px}}
/*$vite$:1*/`,document.head.appendChild(y);const u={boardAccordion:{enabled:!0},shortcutKeys:{enabled:!0},issuePending:{enabled:!0,autoResolve:!0},prFormat:{enabled:!0,projectTemplates:{}},commentUrlCopy:{enabled:!0}};var v=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function G(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var M={exports:{}};(function(o){(function(e,t){o.exports?o.exports=t():e.log=t()})(v,function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),a=["trace","debug","info","warn","error"],c={},d=null;function w(i,g){var r=i[g];if(typeof r.bind=="function")return r.bind(i);try{return Function.prototype.bind.call(r,i)}catch{return function(){return Function.prototype.apply.apply(r,[i,arguments])}}}function E(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function S(i){return i==="debug"&&(i="log"),typeof console===t?!1:i==="trace"&&n?E:console[i]!==void 0?w(console,i):console.log!==void 0?w(console,"log"):e}function m(){for(var i=this.getLevel(),g=0;g<a.length;g++){var r=a[g];this[r]=g<i?e:this.methodFactory(r,i,this.name)}if(this.log=this.debug,typeof console===t&&i<this.levels.SILENT)return"No console available for logging"}function A(i){return function(){typeof console!==t&&(m.call(this),this[i].apply(this,arguments))}}function U(i,g,r){return S(i)||A.apply(this,arguments)}function F(i,g){var r=this,T,O,k,f="loglevel";typeof i=="string"?f+=":"+i:typeof i=="symbol"&&(f=void 0);function ee(s){var p=(a[s]||"silent").toUpperCase();if(!(typeof window===t||!f)){try{window.localStorage[f]=p;return}catch{}try{window.document.cookie=encodeURIComponent(f)+"="+p+";"}catch{}}}function K(){var s;if(!(typeof window===t||!f)){try{s=window.localStorage[f]}catch{}if(typeof s===t)try{var p=window.document.cookie,z=encodeURIComponent(f),Y=p.indexOf(z+"=");Y!==-1&&(s=/^([^;]+)/.exec(p.slice(Y+z.length+1))[1])}catch{}return r.levels[s]===void 0&&(s=void 0),s}}function te(){if(!(typeof window===t||!f)){try{window.localStorage.removeItem(f)}catch{}try{window.document.cookie=encodeURIComponent(f)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function _(s){var p=s;if(typeof p=="string"&&r.levels[p.toUpperCase()]!==void 0&&(p=r.levels[p.toUpperCase()]),typeof p=="number"&&p>=0&&p<=r.levels.SILENT)return p;throw new TypeError("log.setLevel() called with invalid level: "+s)}r.name=i,r.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},r.methodFactory=g||U,r.getLevel=function(){return k??O??T},r.setLevel=function(s,p){return k=_(s),p!==!1&&ee(k),m.call(r)},r.setDefaultLevel=function(s){O=_(s),K()||r.setLevel(s,!1)},r.resetLevel=function(){k=null,te(),m.call(r)},r.enableAll=function(s){r.setLevel(r.levels.TRACE,s)},r.disableAll=function(s){r.setLevel(r.levels.SILENT,s)},r.rebuild=function(){if(d!==r&&(T=_(d.getLevel())),m.call(r),d===r)for(var s in c)c[s].rebuild()},T=_(d?d.getLevel():"WARN");var D=K();D!=null&&(k=_(D)),m.call(r)}d=new F,d.getLogger=function(g){if(typeof g!="symbol"&&typeof g!="string"||g==="")throw new TypeError("You must supply a name when creating a logger.");var r=c[g];return r||(r=c[g]=new F(g,d.methodFactory)),r};var $=typeof window!==t?window.log:void 0;return d.noConflict=function(){return typeof window!==t&&window.log===d&&(window.log=$),d},d.getLoggers=function(){return c},d.default=d,d})})(M);var j=M.exports;const b=G(j),N={level:"error",prefix:"[Backlog Enhancement]",timestamp:!0},x={},C=new Map;function W(o){b.setLevel(o)}function L(o,e){const t=C.get(o);t&&t.setLevel(e),x[o]=e}function V(o){return x[o]||"info"}function q(){return{...x}}function H(o){const e=C.get(o);if(e)return e;const t=b.getLogger(o),n=x[o]||"info";t.setLevel(n);const a=t.methodFactory;return t.methodFactory=function(c,d,w){const E=a(c,d,w);return function(...S){const m=`[${new Date().toISOString()}]`,A=`${N.prefix}`,U=`[${c.toUpperCase()}]`,F=`[${o.charAt(0).toUpperCase()+o.slice(1)}]`,$=[`${m} ${A} ${U} ${F}`,...S].filter(Boolean);E(...$)}},t.setLevel(t.getLevel()),C.set(o,t),t}function I(){if(typeof window>"u"||typeof chrome>"u")return!0;try{return window.location.hostname==="localhost"||window.location.hostname.includes("dev")||chrome.runtime.getManifest().version.includes("dev")}catch{return!0}}function J(o){const e=b.methodFactory;b.methodFactory=function(t,n,a){const c=e(t,n,a);return function(...d){const w=o.timestamp?`[${new Date().toISOString()}]`:"",E=o.prefix?`${o.prefix}`:"",S=`[${t.toUpperCase()}]`,m=[`${w} ${E} ${S}`,...d].filter(Boolean);c(...m)}},b.setLevel(b.getLevel())}function Q(o){const e={...N,...o};I()?e.level="debug":e.level="warn",J(e),W(e.level),b.info("Logger initialized",{level:e.level,isDev:I()})}function h(o){const e=H(o);return{debug:(...t)=>e.debug(...t),info:(...t)=>e.info(...t),warn:(...t)=>e.warn(...t),error:(...t)=>e.error(...t)}}const l={debug:(...o)=>b.debug(...o),info:(...o)=>b.info(...o),warn:(...o)=>b.warn(...o),error:(...o)=>b.error(...o),boardAccordion:h("boardAccordion"),issuePending:h("issuePending"),shortcutKeys:h("shortcutKeys"),storage:h("storage"),backlog:h("backlog"),background:h("background"),options:h("options"),content:h("content"),popup:h("popup")},X={setLevel:L,getLevel:V,showAll:()=>{console.table(q())},enable:o=>{L(o,"debug"),console.log(`✅ ${o} logging enabled (debug level)`)},disable:o=>{L(o,"silent"),console.log(`❌ ${o} logging disabled`)},enableAll:()=>{Object.keys(x).forEach(o=>{L(o,"debug")}),console.log("✅ All feature logging enabled")},disableAll:()=>{Object.keys(x).forEach(o=>{L(o,"error")}),console.log("❌ All feature logging disabled (error only)")}};typeof window<"u"&&I()&&(window.__backlogLoggerControl__=X),Q();class P{static async getSettings(){try{const t=(await chrome.storage.sync.get(this.SETTINGS_KEY))[this.SETTINGS_KEY];return t?this.mergeWithDefaults(t):u}catch(e){return l.storage.error("Failed to get settings:",e),u}}static async saveSettings(e){try{await chrome.storage.sync.set({[this.SETTINGS_KEY]:e})}catch(t){throw l.storage.error("Failed to save settings:",t),t}}static onSettingsChanged(e){chrome.storage.onChanged.addListener((t,n)=>{if(n==="sync"&&t[this.SETTINGS_KEY]){const a=t[this.SETTINGS_KEY].newValue;a&&e(this.mergeWithDefaults(a))}})}static mergeWithDefaults(e){return{boardAccordion:{...u.boardAccordion,...e.boardAccordion},shortcutKeys:{...u.shortcutKeys,...e.shortcutKeys},issuePending:{...u.issuePending,...e.issuePending},prFormat:{...u.prFormat,...e.prFormat},commentUrlCopy:{...u.commentUrlCopy,...e.commentUrlCopy}}}}R(P,"SETTINGS_KEY","backlog_usability_enhance_settings");class Z{constructor(){R(this,"settings",null)}async init(){try{l.popup.info("Initializing toolbar popup"),await this.loadSettings(),this.setupEventListeners(),this.updateUI(),l.popup.info("Toolbar popup initialized successfully")}catch(e){l.popup.error("Failed to initialize popup:",e)}}async loadSettings(){try{this.settings=await P.getSettings(),l.popup.debug("Settings loaded:",this.settings)}catch(e){throw l.popup.error("Failed to load settings:",e),new Error("設定の読み込みに失敗しました")}}async saveSettings(){if(!this.settings)throw new Error("No settings to save");try{await P.saveSettings(this.settings),l.popup.info("Settings saved successfully"),await this.notifySettingsChange()}catch(e){throw l.popup.error("Failed to save settings:",e),e}}async notifySettingsChange(){try{const t=(await chrome.tabs.query({url:["https://*.backlog.jp/*","https://*.backlog.com/*"]})).map(async n=>{if(n.id)try{await chrome.tabs.sendMessage(n.id,{type:"SETTINGS_CHANGED",settings:this.settings}),l.popup.debug(`Settings change notified to tab ${n.id}`)}catch(a){l.popup.debug(`Failed to notify tab ${n.id}:`,a)}});await Promise.allSettled(t),l.popup.info("Settings change notifications sent to all Backlog tabs")}catch(e){l.popup.warn("Failed to notify some tabs of settings change:",e)}}setupEventListeners(){this.setupToggleListener("boardAccordionEnabled","boardAccordion","enabled"),this.setupToggleListener("shortcutKeysEnabled","shortcutKeys","enabled"),this.setupToggleListener("issuePendingEnabled","issuePending","enabled"),this.setupToggleListener("commentUrlCopyEnabled","commentUrlCopy","enabled"),this.setupToggleListener("issuePendingAutoResolve","issuePending","autoResolve");const e=document.getElementById("openOptionsButton");e&&e.addEventListener("click",()=>this.handleOpenOptions());const t=document.getElementById("prFormatConfigButton");t&&t.addEventListener("click",()=>this.handleOpenPrFormatConfig())}setupToggleListener(e,t,n){const a=document.getElementById(e);a&&a.addEventListener("change",async c=>{const d=c.target;await this.handleToggleChange(t,n,d.checked),t==="issuePending"&&n==="enabled"&&this.updateSubSettingsVisibility("issuePendingSubSettings",d.checked)})}async handleToggleChange(e,t,n){if(!this.settings){l.popup.error("No settings available for toggle change");return}try{if(this.settings&&e in this.settings){const c=this.settings[e];c[t]=n}const a=document.querySelector(`#${this.getElementIdForSetting(e,t)} + .slider`);a&&a.setAttribute("aria-checked",n.toString()),await this.saveSettings(),l.popup.debug(`Setting ${e}.${t} changed to ${n}`)}catch(a){l.popup.error(`Failed to update setting ${e}.${t}:`,a),this.updateUI()}}getElementIdForSetting(e,t){return{"boardAccordion.enabled":"boardAccordionEnabled","shortcutKeys.enabled":"shortcutKeysEnabled","issuePending.enabled":"issuePendingEnabled","issuePending.autoResolve":"issuePendingAutoResolve","commentUrlCopy.enabled":"commentUrlCopyEnabled"}[`${e}.${t}`]||""}async handleOpenOptions(){try{await chrome.runtime.openOptionsPage(),window.close()}catch(e){l.popup.error("Failed to open options page:",e)}}async handleOpenPrFormatConfig(){try{await chrome.runtime.openOptionsPage(),setTimeout(async()=>{try{await chrome.runtime.sendMessage({type:"FOCUS_PR_FORMAT_SETTINGS"})}catch(e){l.popup.debug("Failed to focus PR format settings:",e)}},500),window.close()}catch(e){l.popup.error("Failed to open PR format settings:",e)}}updateUI(){if(!this.settings){l.popup.warn("No settings available for UI update");return}this.updateToggle("boardAccordionEnabled",this.settings.boardAccordion.enabled),this.updateToggle("shortcutKeysEnabled",this.settings.shortcutKeys.enabled),this.updateToggle("issuePendingEnabled",this.settings.issuePending.enabled),this.updateToggle("commentUrlCopyEnabled",this.settings.commentUrlCopy.enabled),this.updateToggle("issuePendingAutoResolve",this.settings.issuePending.autoResolve),this.updateSubSettingsVisibility("issuePendingSubSettings",this.settings.issuePending.enabled),this.updatePrFormatStatus()}updateToggle(e,t){const n=document.getElementById(e);if(n){n.checked=t;const a=n.nextElementSibling;a&&a.setAttribute("aria-checked",t.toString())}}updateSubSettingsVisibility(e,t){const n=document.getElementById(e);n&&(t?n.classList.add("enabled"):n.classList.remove("enabled"),n.querySelectorAll('input[type="checkbox"]').forEach(c=>{c.disabled=!t}))}updatePrFormatStatus(){if(!this.settings)return;const e=document.getElementById("prFormatStatus");if(e){const t=this.settings.prFormat.enabled,n=Object.keys(this.settings.prFormat.projectTemplates).length;t&&n>0?(e.textContent=`機能が有効 (${n}件のテンプレート)`,e.className="status-text enabled"):t&&n===0?(e.textContent="機能は有効 (テンプレートなし)",e.className="status-text enabled"):(e.textContent="機能が無効です",e.className="status-text disabled")}}destroy(){l.popup.info("Popup manager destroyed")}}document.addEventListener("DOMContentLoaded",async()=>{const o=new Z;await o.init(),window.addEventListener("beforeunload",()=>{o.destroy()})}),typeof chrome<"u"&&chrome.runtime&&((B=chrome.runtime.onSuspend)==null||B.addListener(()=>{l.popup.debug("Popup suspended")}))})();
