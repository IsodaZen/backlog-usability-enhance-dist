var pe=Object.defineProperty;var ye=(A,I,L)=>I in A?pe(A,I,{enumerable:!0,configurable:!0,writable:!0,value:L}):A[I]=L;var y=(A,I,L)=>ye(A,typeof I!="symbol"?I+"":I,L);(function(){"use strict";var A=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function I(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var L={exports:{}};(function(l){(function(e,t){l.exports?l.exports=t():e.log=t()})(A,function(){var e=function(){},t="undefined",s=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),o=["trace","debug","info","warn","error"],n={},r=null;function a(f,v){var u=f[v];if(typeof u.bind=="function")return u.bind(f);try{return Function.prototype.bind.call(u,f)}catch{return function(){return Function.prototype.apply.apply(u,[f,arguments])}}}function d(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function g(f){return f==="debug"&&(f="log"),typeof console===t?!1:f==="trace"&&s?d:console[f]!==void 0?a(console,f):console.log!==void 0?a(console,"log"):e}function b(){for(var f=this.getLevel(),v=0;v<o.length;v++){var u=o[v];this[u]=v<f?e:this.methodFactory(u,f,this.name)}if(this.log=this.debug,typeof console===t&&f<this.levels.SILENT)return"No console available for logging"}function m(f){return function(){typeof console!==t&&(b.call(this),this[f].apply(this,arguments))}}function G(f,v,u){return g(f)||m.apply(this,arguments)}function O(f,v){var u=this,j,W,_,P="loglevel";typeof f=="string"?P+=":"+f:typeof f=="symbol"&&(P=void 0);function ge(h){var C=(o[h]||"silent").toUpperCase();if(!(typeof window===t||!P)){try{window.localStorage[P]=C;return}catch{}try{window.document.cookie=encodeURIComponent(P)+"="+C+";"}catch{}}}function Z(){var h;if(!(typeof window===t||!P)){try{h=window.localStorage[P]}catch{}if(typeof h===t)try{var C=window.document.cookie,q=encodeURIComponent(P),J=C.indexOf(q+"=");J!==-1&&(h=/^([^;]+)/.exec(C.slice(J+q.length+1))[1])}catch{}return u.levels[h]===void 0&&(h=void 0),h}}function fe(){if(!(typeof window===t||!P)){try{window.localStorage.removeItem(P)}catch{}try{window.document.cookie=encodeURIComponent(P)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function D(h){var C=h;if(typeof C=="string"&&u.levels[C.toUpperCase()]!==void 0&&(C=u.levels[C.toUpperCase()]),typeof C=="number"&&C>=0&&C<=u.levels.SILENT)return C;throw new TypeError("log.setLevel() called with invalid level: "+h)}u.name=f,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=v||G,u.getLevel=function(){return _??W??j},u.setLevel=function(h,C){return _=D(h),C!==!1&&ge(_),b.call(u)},u.setDefaultLevel=function(h){W=D(h),Z()||u.setLevel(h,!1)},u.resetLevel=function(){_=null,fe(),b.call(u)},u.enableAll=function(h){u.setLevel(u.levels.TRACE,h)},u.disableAll=function(h){u.setLevel(u.levels.SILENT,h)},u.rebuild=function(){if(r!==u&&(j=D(r.getLevel())),b.call(u),r===u)for(var h in n)n[h].rebuild()},j=D(r?r.getLevel():"WARN");var X=Z();X!=null&&(_=D(X)),b.call(u)}r=new O,r.getLogger=function(v){if(typeof v!="symbol"&&typeof v!="string"||v==="")throw new TypeError("You must supply a name when creating a logger.");var u=n[v];return u||(u=n[v]=new O(v,r.methodFactory)),u};var H=typeof window!==t?window.log:void 0;return r.noConflict=function(){return typeof window!==t&&window.log===r&&(window.log=H),r},r.getLoggers=function(){return n},r.default=r,r})})(L);var Q=L.exports;const S=I(Q),Y={level:"info",prefix:"[Backlog Enhancement]",timestamp:!0},T={boardAccordion:"error",issuePending:"error",shortcutKeys:"error",storage:"error",backlog:"error",background:"error",options:"error",content:"error"},U=new Map;function ee(l){S.setLevel(l)}function E(l,e){const t=U.get(l);t&&t.setLevel(e),T[l]=e}function te(l){return T[l]||"info"}function se(){return{...T}}function oe(l){const e=U.get(l);if(e)return e;const t=S.getLogger(l),s=T[l]||"info";t.setLevel(s);const o=t.methodFactory;return t.methodFactory=function(n,r,a){const d=o(n,r,a);return function(...g){const b=`[${new Date().toISOString()}]`,m=`${Y.prefix}`,G=`[${n.toUpperCase()}]`,O=`[${l.charAt(0).toUpperCase()+l.slice(1)}]`,H=[`${b} ${m} ${G} ${O}`,...g].filter(Boolean);d(...H)}},t.setLevel(t.getLevel()),U.set(l,t),t}function R(){if(typeof window>"u"||typeof chrome>"u")return!0;try{return window.location.hostname==="localhost"||window.location.hostname.includes("dev")||chrome.runtime.getManifest().version.includes("dev")}catch{return!0}}function ne(l){const e=S.methodFactory;S.methodFactory=function(t,s,o){const n=e(t,s,o);return function(...r){const a=l.timestamp?`[${new Date().toISOString()}]`:"",d=l.prefix?`${l.prefix}`:"",g=`[${t.toUpperCase()}]`,b=[`${a} ${d} ${g}`,...r].filter(Boolean);n(...b)}},S.setLevel(S.getLevel())}function re(l){const e={...Y,...l};R()?e.level="debug":e.level="warn",ne(e),ee(e.level),S.info("Logger initialized",{level:e.level,isDev:R()})}function x(l){const e=oe(l);return{debug:(...t)=>e.debug(...t),info:(...t)=>e.info(...t),warn:(...t)=>e.warn(...t),error:(...t)=>e.error(...t)}}const i={debug:(...l)=>S.debug(...l),info:(...l)=>S.info(...l),warn:(...l)=>S.warn(...l),error:(...l)=>S.error(...l),boardAccordion:x("boardAccordion"),issuePending:x("issuePending"),shortcutKeys:x("shortcutKeys"),storage:x("storage"),backlog:x("backlog"),background:x("background"),options:x("options"),content:x("content"),popup:x("popup")},ie={setLevel:E,getLevel:te,showAll:()=>{console.table(se())},enable:l=>{E(l,"debug"),console.log(`✅ ${l} logging enabled (debug level)`)},disable:l=>{E(l,"silent"),console.log(`❌ ${l} logging disabled`)},enableAll:()=>{Object.keys(T).forEach(l=>{E(l,"debug")}),console.log("✅ All feature logging enabled")},disableAll:()=>{Object.keys(T).forEach(l=>{E(l,"error")}),console.log("❌ All feature logging disabled (error only)")}};typeof window<"u"&&R()&&(window.__backlogLoggerControl__=ie),re();class c{static isBacklogPage(){const e=window.location.hostname;return e.includes(".backlog.jp")||e.includes(".backlog.com")}static getPageInfo(){const e=window.location.href,t=window.location.pathname;let s;const o=t.match(/\/view\/([A-Z0-9_]+)/),n=t.match(/\/board\/([A-Z0-9_]+)/);o?s=o[1]:n&&(s=n[1]);let r="other";t.includes("/ProjectBoard")||t.includes("/board/")?r="board":t.includes("/view/")&&t.includes("#")?r="issue":t.includes("/projects/")?r="project":t.includes("/wiki/")?r="wiki":t.includes("/git/")&&(r="git");let a;if(r==="issue"){const d=t.match(/\/view\/([A-Z0-9_]+-\d+)/);a=d?d[1]:void 0}return{type:r,projectKey:s,issueKey:a,url:e}}static waitForElement(e,t=5e3){return new Promise(s=>{const o=document.querySelector(e);if(o){s(o);return}const n=new MutationObserver(()=>{const r=document.querySelector(e);r&&(n.disconnect(),s(r))});n.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{n.disconnect(),s(null)},t)})}static findElementByCandidates(e){for(const t of e){const s=document.querySelector(t);if(s)return s}return null}static findElementsByCandidates(e){for(const t of e){const s=Array.from(document.querySelectorAll(t));if(s.length>0)return s}return[]}static observeChanges(e,t={childList:!0,subtree:!0}){const s=new MutationObserver(e);return s.observe(document.body,t),s}static log(e,...t){window.__backlog_usability_enhance_dev__&&i.backlog.debug(e,...t)}}const N={boardAccordion:{enabled:!0},shortcutKeys:{enabled:!0},issuePending:{enabled:!0,autoResolve:!0}};class F{static async getSettings(){try{const t=(await chrome.storage.sync.get(this.SETTINGS_KEY))[this.SETTINGS_KEY];return t?this.mergeWithDefaults(t):N}catch(e){return i.storage.error("Failed to get settings:",e),N}}static async saveSettings(e){try{await chrome.storage.sync.set({[this.SETTINGS_KEY]:e})}catch(t){throw i.storage.error("Failed to save settings:",t),t}}static onSettingsChanged(e){chrome.storage.onChanged.addListener((t,s)=>{if(s==="sync"&&t[this.SETTINGS_KEY]){const o=t[this.SETTINGS_KEY].newValue;o&&e(this.mergeWithDefaults(o))}})}static mergeWithDefaults(e){return{boardAccordion:{...N.boardAccordion,...e.boardAccordion},shortcutKeys:{...N.shortcutKeys,...e.shortcutKeys},issuePending:{...N.issuePending,...e.issuePending}}}}y(F,"SETTINGS_KEY","backlog_usability_enhance_settings");class K{static async get(e){try{return!chrome.storage||!chrome.storage.local?(i.storage.warn("Extension context invalidated, skipping storage access"),null):(await chrome.storage.local.get(e))[e]||null}catch(t){return t instanceof Error&&t.message.includes("Extension context invalidated")?(i.storage.warn(`Extension context invalidated for key: ${e}`),null):(i.storage.error(`Failed to get local storage data for key: ${e}`,t),null)}}static async set(e,t){try{if(!chrome.storage||!chrome.storage.local){i.storage.warn("Extension context invalidated, skipping storage save");return}await chrome.storage.local.set({[e]:t})}catch(s){if(s instanceof Error&&s.message.includes("Extension context invalidated")){i.storage.warn(`Extension context invalidated for key: ${e}`);return}throw i.storage.error(`Failed to set local storage data for key: ${e}`,s),s}}static async remove(e){try{await chrome.storage.local.remove(e)}catch(t){throw i.storage.error(`Failed to remove local storage data for key: ${e}`,t),t}}}class ae{constructor(){y(this,"observer",null);y(this,"keyboardHandler");y(this,"debounceTimeout",null);y(this,"abortController",new AbortController);y(this,"config",{COLLAPSED_WIDTH:"72px",BUTTON_DELAY:500,INIT_DELAY:1e3});this.keyboardHandler=this.handleKeyboardShortcuts.bind(this)}init(){if(i.boardAccordion.info("Initializing"),c.getPageInfo().type!=="board"){i.boardAccordion.debug("Not a board page, skipping");return}setTimeout(()=>{this.addCollapseButtons(),this.setupKeyboardShortcuts()},this.config.INIT_DELAY),this.observeChanges()}destroy(){i.boardAccordion.info("Destroying"),this.observer&&(this.observer.disconnect(),this.observer=null),this.debounceTimeout&&(clearTimeout(this.debounceTimeout),this.debounceTimeout=null),this.abortController.abort(),this.abortController=new AbortController,document.removeEventListener("keydown",this.keyboardHandler),this.removeCollapseButtons()}addCollapseButtons(){const t=document.querySelectorAll('.css-hrpltn-col, [data-testid="board-column"], .board-column, [class*="column"], .lane');if(t.length>0&&i.boardAccordion.debug(`Found ${t.length} columns using optimized selector`),t.length===0){i.boardAccordion.warn("No status columns found");return}i.boardAccordion.info(`Found ${t.length} status columns`);const s=[];t.forEach((o,n)=>{const r=o.querySelector('.css-ujzck4-row, [class*="header"], [class*="title"], h1, h2, h3, h4, h5, h6');if(!r||r.querySelector(".collapse-button"))return;const a=this.createCollapseButton();s.push({column:o,button:a,index:n});const d=r.querySelector('h3.SlotHead, h3, h2, h1, [class*="title"], [class*="header"]');if(d){d.appendChild(a);const g=o.querySelector(".css-15rua0m-box.SlotBox");g&&this.setupHeaderClickExpand(g,o,a,n),this.restoreColumnState(o,a)}else{r.appendChild(a);const g=o.querySelector(".css-15rua0m-box.SlotBox");g?this.setupHeaderClickExpand(g,o,a,n):this.setupHeaderClickExpand(r,o,a,n),this.restoreColumnState(o,a)}}),requestAnimationFrame(()=>{s.forEach(({column:o,button:n,index:r})=>{this.setupButtonInteractions(o,n,r)})})}createCollapseButton(){const e=document.createElement("button");return e.className="collapse-button",e.textContent="▼",e.title="ステータス列を折りたたむ",e.setAttribute("aria-label","ステータス列を折りたたむ"),e.setAttribute("type","button"),e.style.cssText=`
      background: none;
      border: none;
      cursor: pointer;
      font-size: 12px;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background-color 0.2s;
      align-self: center;
      margin-left: 4px;
    `,e}setupButtonInteractions(e,t,s){const o=new AbortController;t.addEventListener("mouseenter",()=>{t.style.backgroundColor="#f0f0f0"},{signal:o.signal}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="transparent"},{signal:o.signal}),t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),this.toggleColumn(e,t,s)},{signal:o.signal}),t.__abortController=o}setupHeaderClickExpand(e,t,s,o){e.dataset.expandClickSetup!=="true"&&(e.addEventListener("click",n=>{const r=n.target;if(r.classList.contains("collapse-button")||r.tagName==="A"||r.tagName==="BUTTON"||r.tagName==="SVG"||r.tagName==="USE"||r.closest("a")||r.closest("button:not(.collapse-button)")||r.closest("svg"))return;const a=this.getColumnElements(t);a.issueList&&a.issueList.style.display==="none"&&(n.preventDefault(),n.stopPropagation(),this.toggleColumn(t,s,o))}),e.addEventListener("mouseenter",()=>{const n=this.getColumnElements(t);if(n.issueList&&n.issueList.style.display==="none"){e.style.cursor="pointer";const r=e.querySelector(".StatusIcon");r&&(r.style.cursor="pointer")}}),e.addEventListener("mouseleave",()=>{const n=this.getColumnElements(t);n.issueList&&n.issueList.style.display,e.style.cursor=""}),e.dataset.expandClickSetup="true")}toggleColumn(e,t,s){const o=this.getColumnElements(e);if(!o.issueList)return;const n=o.issueList.style.display==="none",r=this.getStatusName(e)||`column_${s}`;i.boardAccordion.debug(`Toggling column '${r}', isCollapsed: ${n}`),n?this.expandColumn(e,t,o):this.collapseColumn(e,t,o),this.saveColumnState(e,!n)}getColumnElements(e){const t=s=>{for(const o of s){const n=e.querySelector(o);if(n)return n}return null};return{issueList:t(["ul.SlotBox",'[class*="issue-list"]','[class*="card-list"]',"ul, ol",'[class*="list"]']),statusName:t(["h3.SlotHead > div:nth-child(2)",'[class*="status-name"]','[class*="column-title"]',"h1, h2, h3, h4, h5, h6"]),expandArea:t(["h3.SlotHead > div:nth-child(3)",'[class*="expand"]','[class*="action"]']),addIssueButton:t([".css-oslcxi-row",'[class*="add-issue"]','[class*="add-button"]','button[class*="add"]']),descriptionArea:t([".css-1vsmiu0-box",'[class*="description"]','[class*="summary"]'])}}expandColumn(e,t,s){var n,r,a,d,g;(n=s.issueList)!=null&&n.style&&(s.issueList.style.display=""),(r=s.statusName)!=null&&r.style&&(s.statusName.style.display=""),(a=s.expandArea)!=null&&a.style&&(s.expandArea.style.display=""),(d=s.addIssueButton)!=null&&d.style&&(s.addIssueButton.style.display=""),(g=s.descriptionArea)!=null&&g.style&&(s.descriptionArea.style.display=""),t.textContent="▼",t.title="ステータス列を折りたたむ",t.setAttribute("aria-label","ステータス列を折りたたむ"),e.style.width="",e.style.minWidth="",e.style.maxWidth="",e.style.paddingRight="";const o=e.firstElementChild;o&&(o.style.height=""),this.removeIconTooltip(e),this.refreshPendingStatesInColumn()}collapseColumn(e,t,s){var n,r,a,d,g;(n=s.issueList)!=null&&n.style&&(s.issueList.style.display="none"),(r=s.statusName)!=null&&r.style&&(s.statusName.style.display="none"),(a=s.expandArea)!=null&&a.style&&(s.expandArea.style.display="none"),(d=s.addIssueButton)!=null&&d.style&&(s.addIssueButton.style.display="none"),(g=s.descriptionArea)!=null&&g.style&&(s.descriptionArea.style.display="none"),t.textContent="▶",t.title="ステータス列を展開する",t.setAttribute("aria-label","ステータス列を展開する"),e.style.width=this.config.COLLAPSED_WIDTH,e.style.minWidth=this.config.COLLAPSED_WIDTH,e.style.maxWidth=this.config.COLLAPSED_WIDTH,e.matches(".css-hrpltn-col:last-of-type")&&(e.style.paddingRight="0");const o=e.firstElementChild;o&&(o.style.height="100%"),this.addIconTooltip(e,s)}addIconTooltip(e,t){var o;const s=e.querySelector(".StatusIcon");if(s&&t.statusName){const n=((o=t.statusName.textContent)==null?void 0:o.trim())||"";s.title=n,s.style.cursor="pointer"}}removeIconTooltip(e){const t=e.querySelector(".StatusIcon");t&&(t.title="",t.style.cursor="")}getStatusName(e){var n,r;const t=this.getColumnElements(e);if(t.statusName){const a=(n=t.statusName.textContent)==null?void 0:n.trim();if(a)return a}const s=e.dataset.statusName;return s||`column_${Array.from(((r=e.parentElement)==null?void 0:r.children)||[]).indexOf(e)}`}async saveColumnState(e,t){const s=this.getStatusName(e);if(!s){i.boardAccordion.warn("Cannot save state - status name not found");return}const n=`backlog_column_${c.getPageInfo().projectKey||"unknown"}_${s}`;try{await K.set(n,t),i.boardAccordion.debug(`Saved column '${s}' state: ${t}`)}catch(r){i.boardAccordion.error("Failed to save column state:",r)}}async restoreColumnState(e,t){const s=this.getStatusName(e);if(!s){i.boardAccordion.warn("Cannot restore state - status name not found");return}const n=`backlog_column_${c.getPageInfo().projectKey||"unknown"}_${s}`;try{if(await K.get(n)){const a=this.getColumnElements(e);this.collapseColumn(e,t,a),i.boardAccordion.debug(`Restored column '${s}' as collapsed`)}}catch(r){i.boardAccordion.error("Failed to restore column state:",r)}}observeChanges(){this.observer=c.observeChanges(e=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=window.setTimeout(()=>{e.some(s=>s.type==="childList"&&s.addedNodes.length>0&&Array.from(s.addedNodes).some(o=>o.nodeType===Node.ELEMENT_NODE&&o.matches('.css-hrpltn-col, [data-testid="board-column"], .board-column')))&&c.getPageInfo().type==="board"&&this.addCollapseButtons()},this.config.BUTTON_DELAY)})}setupKeyboardShortcuts(){document.addEventListener("keydown",this.keyboardHandler,{signal:this.abortController.signal})}refreshPendingStatesInColumn(){var e;try{const t=window.__backlog_usability_enhance__;if(!t){i.boardAccordion.debug("Global instance not available for pending state refresh");return}const s=(e=t.getFeature("issuePending"))==null?void 0:e._instance;if(!s||typeof s.refreshAllVisibleCards!="function"){i.boardAccordion.debug("IssuePending feature not available or method not found");return}setTimeout(()=>{s.refreshAllVisibleCards().catch(o=>{i.boardAccordion.error("Failed to refresh pending states in column:",o)}),i.boardAccordion.debug("Refreshed pending states in expanded column")},50)}catch(t){i.boardAccordion.error("Error while refreshing pending states:",t)}}handleKeyboardShortcuts(e){const t=document.activeElement;t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)||(e.ctrlKey&&e.shiftKey&&e.key==="E"&&(e.preventDefault(),this.expandAllColumns(),i.boardAccordion.info("Expand all columns via shortcut")),e.ctrlKey&&e.shiftKey&&e.key==="C"&&(e.preventDefault(),this.collapseAllColumns(),i.boardAccordion.info("Collapse all columns via shortcut")))}expandAllColumns(){document.querySelectorAll(".css-hrpltn-col").forEach((t,s)=>{const o=t.querySelector(".collapse-button");o&&o.textContent==="▶"&&this.toggleColumn(t,o,s)}),this.refreshAllPendingStates()}refreshAllPendingStates(){var e;try{const t=window.__backlog_usability_enhance__;if(!t){i.boardAccordion.debug("Global instance not available for pending state refresh");return}const s=(e=t.getFeature("issuePending"))==null?void 0:e._instance;if(!s||typeof s.refreshAllVisibleCards!="function"){i.boardAccordion.debug("IssuePending feature not available or method not found");return}setTimeout(()=>{s.refreshAllVisibleCards().catch(o=>{i.boardAccordion.error("Failed to refresh all pending states:",o)}),i.boardAccordion.debug("Refreshed all pending states after column operations")},100)}catch(t){i.boardAccordion.error("Error while refreshing all pending states:",t)}}collapseAllColumns(){document.querySelectorAll(".css-hrpltn-col").forEach((t,s)=>{const o=t.querySelector(".collapse-button");o&&o.textContent==="▼"&&this.toggleColumn(t,o,s)})}removeCollapseButtons(){document.querySelectorAll(".collapse-button").forEach(t=>{var n;const s=t.__abortController;s&&s.abort();const o=(n=t.closest(".css-hrpltn-col"))==null?void 0:n.querySelector('[data-expand-click-setup="true"]');o&&(o.removeAttribute("data-expand-click-setup"),o.style.cursor=""),t.remove()})}}const B=class B{constructor(){y(this,"observer",null);y(this,"originalLabels",new Map);y(this,"isUpdating",!1);i.shortcutKeys.debug("constructor()")}init(){try{const e=this.findProjectNavList();if(!e){i.shortcutKeys.debug("Project navigation list not found, retrying..."),setTimeout(()=>{this.retryInitialization()},300);return}this.integrateShortcutKeys(e),this.observeNavigationChanges(e),setTimeout(()=>{this.integrateShortcutKeys(e)},100),i.shortcutKeys.info("Feature initialized")}catch(e){i.shortcutKeys.error("Failed to initialize:",e)}}retryInitialization(){const e=this.findProjectNavList();e?(i.shortcutKeys.debug("Project navigation found on retry, initializing..."),this.integrateShortcutKeys(e),this.observeNavigationChanges(e)):i.shortcutKeys.warn("Project navigation still not found after retry")}destroy(){i.shortcutKeys.debug("destroy()");try{this.observer&&(this.observer.disconnect(),this.observer=null),this.restoreOriginalLabels(),i.shortcutKeys.info("Feature destroyed")}catch(e){i.shortcutKeys.error("Failed to destroy:",e)}}findProjectNavList(){const e=["#projectNavList",".project-nav-list",'[role="navigation"][aria-label*="プロジェクト"]'];for(const t of e){const s=document.querySelector(t);if(s)return s}return null}integrateShortcutKeys(e){var t;if(!this.isUpdating){this.isUpdating=!0;try{this.restoreOriginalLabels();const s=e.querySelectorAll(".project-nav-list__item a, .project-nav-list__item span");for(const o of s){const n=o,r=n.id;i.shortcutKeys.debug(`Processing nav item: id="${r}", href="${n.getAttribute("href")}", text="${(t=n.textContent)==null?void 0:t.trim()}"`);let a=B.SHORTCUT_MAPPINGS.find(d=>d.elementId===r);if(r==="navi-file"){const d=n.getAttribute("href");d&&d.includes("/git/")&&(a=B.SHORTCUT_MAPPINGS.find(g=>g.elementId==="navi-git"),i.shortcutKeys.debug("Detected Git menu with navi-file ID, using Git mapping"))}a&&this.integrateShortcutKeyToLabel(n,a)}}finally{setTimeout(()=>{this.isUpdating=!1},200)}}}integrateShortcutKeyToLabel(e,t){try{const s=e.querySelector(".project-nav-list__text span");if(!s||!s.textContent)return;const o=this.getUniqueElementKey(e,t);this.originalLabels.has(o)||this.originalLabels.set(o,s.textContent);const n=this.originalLabels.get(o)||s.textContent;if(n.includes(`(${t.key.toUpperCase()})`))return;const r=`${n} (${t.key.toUpperCase()})`;s.textContent=r,e.title=r;const a=e.getAttribute("data-tooltip");if(a&&!a.includes(`(${t.key.toUpperCase()})`)){e.hasAttribute("data-original-tooltip")||e.setAttribute("data-original-tooltip",a);const d=`${a} (${t.key.toUpperCase()})`;e.setAttribute("data-tooltip",d),i.shortcutKeys.debug(`Updated data-tooltip: ${a} -> ${d}`)}i.shortcutKeys.debug(`Integrated shortcut key '${t.key}' into label: ${n} -> ${r}`)}catch(s){i.shortcutKeys.error(`Failed to integrate shortcut key to ${t.elementId}:`,s)}}getUniqueElementKey(e,t){const s=e.getAttribute("href");return e.id==="navi-file"&&s&&s.includes("/git/")?"navi-git":t.elementId}restoreOriginalLabels(){for(const[e,t]of this.originalLabels)try{let s=null;if(e==="navi-git"){const o=document.querySelectorAll("#navi-file");for(const n of o){const r=n.getAttribute("href");if(r&&r.includes("/git/")){s=n;break}}}else s=document.getElementById(e);if(s){const o=s.querySelector(".project-nav-list__text span");if(o){o.textContent=t,s.title=s.getAttribute("data-tooltip")||"";const n=s.getAttribute("data-original-tooltip");n&&(s.setAttribute("data-tooltip",n),s.removeAttribute("data-original-tooltip"),i.shortcutKeys.debug(`Restored data-tooltip to: ${n}`))}}}catch(s){i.shortcutKeys.error(`Failed to restore label for ${e}:`,s)}this.originalLabels.clear()}observeNavigationChanges(e){this.observer=new MutationObserver(t=>{if(this.isUpdating)return;let s=!1;for(const o of t)if(o.type==="childList"&&o.addedNodes.length>0){for(const n of o.addedNodes)if(n.nodeType===Node.ELEMENT_NODE){const r=n;if(r.classList.contains("project-nav-list__item")||r.querySelector(".project-nav-list__item")){s=!0;break}}if(s)break}s&&setTimeout(()=>{this.integrateShortcutKeys(e)},100)}),this.observer.observe(e,{childList:!0,subtree:!0})}};y(B,"SHORTCUT_MAPPINGS",[{key:"h",description:"ホーム",elementId:"navi-home"},{key:"a",description:"課題の追加",elementId:"navi-add"},{key:"f",description:"課題",elementId:"navi-find"},{key:"r",description:"ボード",elementId:"navi-board"},{key:"g",description:"ガントチャート",elementId:"navi-gantt"},{key:"w",description:"Wiki",elementId:"navi-wiki"},{key:"s",description:"ファイル",elementId:"navi-file"},{key:"v",description:"Subversion",elementId:"navi-subversion"},{key:"t",description:"Git",elementId:"navi-git"}]);let z=B;class k{static getStorageKey(e){return`${this.STORAGE_KEY_PREFIX}${e}`}static async getPendingIssues(e){if(!this.validateProjectKey(e))return i.storage.warn(`Invalid project key: ${e}`),[];try{const t=this.getStorageKey(e),s=await K.get(t);return!s||!Array.isArray(s)?[]:s}catch(t){return i.storage.error(`Failed to get pending issues for project ${e}:`,t),[]}}static async savePendingIssues(e,t){if(!this.validateProjectKey(e))throw new Error(`Invalid project key: ${e}`);const s=t.filter(o=>this.validatePendingIssue(o));s.length!==t.length&&i.storage.warn(`Filtered invalid issues: ${t.length-s.length} removed`);try{const o=this.getStorageKey(e);await K.set(o,s)}catch(o){throw i.storage.error(`Failed to save pending issues for project ${e}:`,o),o}}static async setPendingIssue(e,t){if(!this.validatePendingIssue(t))throw new Error(`Invalid pending issue data: ${JSON.stringify(t)}`);try{const o=(await this.getPendingIssues(e)).filter(n=>n.issueKey!==t.issueKey);o.push(t),await this.savePendingIssues(e,o)}catch(s){throw i.storage.error(`Failed to set pending issue ${t.issueKey}:`,s),s}}static async removePendingIssue(e,t){if(!this.validateIssueKey(t))throw new Error(`Invalid issue key: ${t}`);try{const o=(await this.getPendingIssues(e)).filter(n=>n.issueKey!==t);await this.savePendingIssues(e,o)}catch(s){throw i.storage.error(`Failed to remove pending issue ${t}:`,s),s}}static async isPendingIssue(e,t){try{return(await this.getPendingIssues(e)).some(o=>o.issueKey===t)}catch(s){return i.storage.error(`Failed to check pending status for ${t}:`,s),!1}}static async clearPendingIssues(e){if(!this.validateProjectKey(e))throw new Error(`Invalid project key: ${e}`);try{const t=this.getStorageKey(e);await K.remove(t)}catch(t){throw i.storage.error(`Failed to clear pending issues for project ${e}:`,t),t}}static validateProjectKey(e){return typeof e=="string"&&e.length>0&&/^[A-Z0-9_]+$/.test(e)}static validateIssueKey(e){return typeof e=="string"&&/^[A-Z0-9_]+-\d+$/.test(e)}static validatePendingIssue(e){return e&&typeof e=="object"&&this.validateIssueKey(e.issueKey)&&this.validateProjectKey(e.projectKey)}static async getAllPendingData(){return i.storage.warn("getAllPendingData is for debugging purposes only"),{}}}y(k,"STORAGE_KEY_PREFIX","backlog_pending_issues_");const le=["li.css-1og413z-box.card",".css-1og413z-box.card","li.card",".card:not(.card-label):not(.card-summary):not(.card-status)",".IssueCard","[data-issue-key]"],ce=[".card-label",'a[href*="/view/"]',"[data-issue-key]",".IssueKey"],p={className:"pending-toggle-button",activeClassName:"pending-toggle-button--active",icon:{pending:`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="4" y="4" width="2.25" height="8" fill="currentColor" rx="0.5"/>
      <rect x="9" y="4" width="2.25" height="8" fill="currentColor" rx="0.5"/>
    </svg>`,normal:`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="padding-left: 2px;">
      <path d="M4 3L12 8L4 13V3Z" fill="currentColor"/>
    </svg>`},tooltip:{pending:"Pending状態を解除",normal:"課題をPending状態にする"}},M={pending:"issue-card--pending",normal:"issue-card--normal"},$={className:"pending-card-tooltip",delay:200,width:250};class w{static findIssueCards(e=document.body){const t=[];for(const s of le){e.matches&&e.matches(s)&&(c.log(`[PendingDom] Container itself matches selector: ${s}`),t.includes(e)||(c.log(`[PendingDom] Container element classes: ${e.className}`),t.push(e)));const o=e.querySelectorAll(s);if(o.length>0){c.log(`[PendingDom] Found ${o.length} child elements with selector: ${s}`);for(const n of o)t.includes(n)||(c.log(`[PendingDom] Child element classes: ${n.className}`),t.push(n))}}return c.log(`[PendingDom] Total ${t.length} unique cards found`),t}static extractIssueKey(e){var r;const t=e.getAttribute("data-issue-key");if(t&&this.validateIssueKey(t))return t;const s=e.querySelector(".card-label");if(s&&s.href){const a=s.href.match(/\/view\/([A-Z0-9_]+-\d+)/);if(a&&a[1])return a[1]}if(s&&s.textContent){const a=s.textContent.trim();if(this.validateIssueKey(a))return a}for(const a of ce){const d=e.querySelector(a);if(d){const g=d.getAttribute("href");if(g){const m=g.match(/\/view\/([A-Z0-9_]+-\d+)/);if(m&&m[1])return m[1]}const b=(r=d.textContent)==null?void 0:r.trim();if(b&&this.validateIssueKey(b))return b}}const n=(e.textContent||"").match(/\b([A-Z0-9_]+-\d+)\b/);return n&&n[1]?n[1]:null}static createPendingButton(e=!1){const t=document.createElement("button");return t.className=p.className,e&&t.classList.add(p.activeClassName),t.innerHTML=e?p.icon.pending:p.icon.normal,t.title=e?p.tooltip.pending:p.tooltip.normal,this.applyButtonStyles(t),e&&this.updatePendingButton(t,!0),t}static applyButtonStyles(e){const t={position:"absolute",top:"8px",right:"40px",width:"22px",height:"22px",borderRadius:"11px",padding:"0",background:"transparent",color:"var(--iconColorDefault, #9c9c9c)",border:"1px solid var(--borderColorDefault, rgba(78, 78, 78, 0.6))",cursor:"pointer",fontSize:"0",display:"flex",pointerEvents:"auto",alignItems:"center",justifyContent:"center",transition:"all 0.15s ease",boxShadow:"var(--shadowModuleSmall, 0 2px 6px 0 rgba(0, 0, 0, 0.1))"};Object.assign(e.style,t),e.addEventListener("mouseenter",()=>{e.classList.contains(p.activeClassName)?(e.style.background="var(--backgroundColorHover, rgba(158, 128, 18, 0.15))",e.style.borderColor="var(--commonColorYellow, #9e8012)",e.style.color="var(--commonColorYellow, #9e8012)"):(e.style.background="var(--backgroundColorHover, rgba(189, 189, 189, 0.1))",e.style.borderColor="var(--borderColorPrimary, #737373)",e.style.color="var(--textColorDefault, #dadada)"),e.style.transform="scale(1.05)"}),e.addEventListener("mouseleave",()=>{e.style.transform="scale(1)",e.classList.contains(p.activeClassName)?(e.style.background="rgba(158, 128, 18, 0.08)",e.style.borderColor="var(--commonColorYellow, #9e8012)",e.style.color="var(--commonColorYellow, #9e8012)"):(e.style.background="transparent",e.style.borderColor="var(--borderColorDefault, rgba(78, 78, 78, 0.6))",e.style.color="var(--iconColorDefault, #9c9c9c)")})}static applyPendingVisual(e,t){var s;if(t){e.classList.add(M.pending),e.classList.remove(M.normal),e.style.borderLeft="4px solid var(--borderColorWeak, #9e8012)",e.style.backgroundColor="var(--backgroundColorWeak, rgba(76, 71, 54, 0.6))",e.style.boxShadow="0 0 0 1px rgba(158, 128, 18, 0.3), var(--shadowModuleSmall, 0 2px 6px 0 rgba(0, 0, 0, 0.8))";const o=e.querySelector(".card-summary");if(o){o.style.display="none";const a=(s=o.textContent)==null?void 0:s.trim();a&&this.setupCustomTooltip(e,a)}const n=e.querySelector(".card-status");n&&(n.style.display="none");const r=document.createElement("style");r.textContent=`
        .issue-card--pending [data-tooltip]:before,
        .issue-card--pending [data-tooltip]:after,
        .issue-card--pending .simptip-position-top:before,
        .issue-card--pending .simptip-position-top:after {
          background-color: var(--backgroundColorSchemeBase, #333333) !important;
          color: var(--textColorDefault, #dadada) !important;
          opacity: 0.95 !important;
        }
        .issue-card--pending .calendar__ttip {
          background-color: var(--backgroundColorSchemeBase, #333333) !important;
          color: var(--textColorDefault, #dadada) !important;
          opacity: 0.95 !important;
        }
      `,document.querySelector("#pending-tooltip-fix")||(r.id="pending-tooltip-fix",document.head.appendChild(r))}else{e.classList.remove(M.pending),e.classList.add(M.normal),e.style.borderLeft="",e.style.backgroundColor="",e.style.boxShadow="";const o=e.querySelector(".card-summary");o&&(o.style.display="");const n=e.querySelector(".card-status");n&&(n.style.display=""),this.cleanupCustomTooltip(e)}}static addPendingButton(e,t,s){if(!e||typeof s!="function")return null;const o=e.querySelector(`.${p.className}`);if(o)return c.log(`[PendingDom] Button already exists in card: ${e.className}`),o;c.log(`[PendingDom] Checking direct parent for existing button: ${e.className}`);const n=e.parentElement;if(n){const a=n.querySelectorAll(`.${p.className}`);for(const d of a)if(d.closest("li.css-1og413z-box.card, .css-1og413z-box.card")===e)return c.log("[PendingDom] Button already exists in same card - ABORTING"),null}c.log(`[PendingDom] Direct parent check passed for card: ${e.className}`),getComputedStyle(e).position==="static"&&(e.style.position="relative");const r=this.createPendingButton(t);return r.addEventListener("click",a=>{c.log(`[PendingDom] Button clicked for card: ${e.className}`),a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),setTimeout(()=>{try{s(),c.log("[PendingDom] Button onClick executed successfully")}catch(d){i.issuePending.error("Error in onClick:",d)}},10)},!0),r.addEventListener("dragstart",a=>(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1)),r.addEventListener("drag",a=>(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1)),e.appendChild(r),c.log(`[PendingDom] Added button to card: ${e.className}`),r}static updatePendingButton(e,t){t?(e.classList.add(p.activeClassName),e.innerHTML=p.icon.pending,e.title=p.tooltip.pending,e.setAttribute("aria-label",p.tooltip.pending),e.style.background="rgba(158, 128, 18, 0.08)",e.style.borderColor="var(--commonColorYellow, #9e8012)",e.style.color="var(--commonColorYellow, #9e8012)"):(e.classList.remove(p.activeClassName),e.innerHTML=p.icon.normal,e.title=p.tooltip.normal,e.setAttribute("aria-label",p.tooltip.normal),e.style.background="transparent",e.style.borderColor="var(--borderColorDefault, rgba(78, 78, 78, 0.6))",e.style.color="var(--iconColorDefault, #9c9c9c)")}static removePendingButton(e){const t=e.querySelector(`.${p.className}`);t&&t.remove()}static validateIssueKey(e){return!e||typeof e!="string"||e.length>100||/<|>|&|'|"|\n|\r|\t|javascript:|data:/.test(e)?!1:/^[A-Z0-9_]+-\d+$/.test(e)}static getMutationObserverConfig(){return{childList:!0,subtree:!0,attributes:!1,characterData:!1}}static isCompletedOrPostCompletionStatus(e){var t;try{const s=[".css-hrpltn-col",'[data-testid="board-column"]',".board-column",'[class*="column"]',".lane"];let o=null;for(const m of s)if(o=e.closest(m),o)break;if(!o)return i.issuePending.debug("Card not in a valid column (tried all selectors)"),!1;if(o.getAttribute("data-statusid")==="4")return!0;const r=["h3.SlotHead",".status-name",'[class*="status"]',"h1, h2, h3, h4, h5, h6",'[class*="title"]','[class*="header"]'];let a=null;for(const m of r)if(a=o.querySelector(m),a)break;const d=((t=a==null?void 0:a.textContent)==null?void 0:t.trim())||"";return["完了","Done","Completed","Complete","Closed"].some(m=>d.includes(m))}catch(s){return i.issuePending.error("Error in isCompletedOrPostCompletionStatus:",s),!1}}static findNewIssueCards(e,t){const s=[];for(const o of e)if(o.type==="childList"){for(const n of o.addedNodes)if(n.nodeType===Node.ELEMENT_NODE){const r=n;c.log(`[PendingDom] findNewIssueCards() check new item: ${r.className} ${r.tagName}`);const a=this.findIssueCards(r);for(const d of a)t.has(d)||(c.log(`[PendingDom] Found new card: ${d.className}`),s.push(d))}}return s}static createCustomTooltip(e){const t=document.createElement("div");return t.className=$.className,t.textContent=e,Object.assign(t.style,{position:"absolute",zIndex:"10000",background:"var(--backgroundColorSchemeBase, #333333)",color:"var(--textColorDefault, #dadada)",padding:"8px 12px",borderRadius:"4px",fontSize:"13px",lineHeight:"1.4",width:`${$.width}px`,overflowWrap:"break-word",whiteSpace:"normal",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.3)",border:"1px solid var(--borderColorDefault, rgba(78, 78, 78, 0.6))",opacity:"0",transform:"translateY(10px)",transition:"opacity 0.2s ease, transform 0.2s ease",pointerEvents:"none",visibility:"visible",display:"block"}),t}static positionTooltip(e,t){const s=t.getBoundingClientRect(),o=window.innerWidth,n=window.pageYOffset||document.documentElement.scrollTop,r=window.pageXOffset||document.documentElement.scrollLeft,a=$.width,d=50;let g=s.left+r+s.width/2-a/2,b=s.bottom+n+8;g<r+8&&(g=r+8);const m=r+o-8;g+a>m&&(g=m-a,g<r+8&&(g=r+8)),b+d>n+window.innerHeight-8&&(b=s.top+n-d-8),e.style.left=`${g}px`,e.style.top=`${b}px`}static setupCustomTooltip(e,t){let s=null,o=null,n=null;const r=()=>{n&&(clearTimeout(n),n=null),o=setTimeout(()=>{const d=document.querySelector(`.${$.className}`);d&&d.remove(),s=this.createCustomTooltip(t),document.body.appendChild(s),this.positionTooltip(s,e),requestAnimationFrame(()=>{s&&(s.style.opacity="1",s.style.transform="translateY(0)")})},$.delay)},a=()=>{o&&(clearTimeout(o),o=null),s&&(n=setTimeout(()=>{s&&(s.remove(),s=null)},100))};e.addEventListener("mouseenter",r),e.addEventListener("mouseleave",a),e._tooltipCleanup=()=>{o&&clearTimeout(o),n&&clearTimeout(n),s&&s.remove(),e.removeEventListener("mouseenter",r),e.removeEventListener("mouseleave",a)}}static cleanupCustomTooltip(e){const t=e._tooltipCleanup;t&&(t(),delete e._tooltipCleanup);const s=document.querySelector(`.${$.className}`);s&&s.remove()}}class de{constructor(){y(this,"observer",null);y(this,"pendingStore",new Map);y(this,"issueCardMap",new Map);y(this,"projectKey",null);y(this,"settings",null);i.issuePending.debug("constructor()")}async init(){var e;try{const t=c.getPageInfo();if(t.type!=="board"){c.log("IssuePendingFeature: Not a board page, skipping initialization");return}if(this.projectKey=t.projectKey||null,!this.projectKey){c.log("IssuePendingFeature: No project key found");return}if(c.log(`IssuePendingFeature: Initializing for project ${this.projectKey}`),await this.loadSettings(),!((e=this.settings)!=null&&e.enabled)){c.log("IssuePendingFeature: Feature is disabled, skipping");return}this.setupSettingsWatcher(),await this.loadPendingData(),this.scheduleButtonAddition(),this.observeIssueCards(),i.issuePending.info("Initialization completed")}catch(t){i.issuePending.error("Failed to initialize:",t)}}async loadSettings(){try{const e=await F.getSettings();this.settings=e.issuePending,i.issuePending.debug("Settings loaded:",this.settings)}catch(e){i.issuePending.error("Failed to load settings:",e),this.settings={enabled:!0,autoResolve:!0}}}setupSettingsWatcher(){F.onSettingsChanged(e=>{var s,o;const t=e.issuePending;i.issuePending.debug("Settings changed:",t),!t.enabled&&((s=this.settings)!=null&&s.enabled)&&(i.issuePending.info("Feature disabled, removing buttons"),this.removeAllPendingButtons(),this.disconnect()),t.enabled&&!((o=this.settings)!=null&&o.enabled)&&(i.issuePending.info("Feature enabled, reinitializing"),this.reconnect()),this.settings=t})}destroy(){i.issuePending.debug("destroy()"),this.observer&&(this.observer.disconnect(),this.observer=null),this.pendingStore.clear(),this.issueCardMap.clear(),this.projectKey=null,i.issuePending.info("Destroyed")}removeAllPendingButtons(){document.querySelectorAll(".pending-toggle-button").forEach(t=>t.remove()),i.issuePending.debug("All pending buttons removed")}disconnect(){this.observer&&(this.observer.disconnect(),this.observer=null),i.issuePending.debug("Observer disconnected")}async reconnect(){try{await this.loadPendingData(),this.scheduleButtonAddition(),this.observeIssueCards(),i.issuePending.info("Reconnected successfully")}catch(e){i.issuePending.error("Failed to reconnect:",e)}}async togglePending(e){if(!(!this.projectKey||!w.validateIssueKey(e)))try{const t=await this.isPending(e);if(t)await k.removePendingIssue(this.projectKey,e),this.pendingStore.delete(e);else{const s={issueKey:e,projectKey:this.projectKey};await k.setPendingIssue(this.projectKey,s),this.pendingStore.set(e,s)}await this.updateCardVisualState(e),i.issuePending.info(`Toggled pending state for ${e}, new state: ${!t}`)}catch(t){i.issuePending.error(`Failed to toggle pending state for ${e}:`,t)}}async removePendingState(e){if(!(!this.projectKey||!w.validateIssueKey(e)))try{await k.removePendingIssue(this.projectKey,e),this.pendingStore.delete(e),await this.updateCardVisualState(e),i.issuePending.debug(`Removed pending state for ${e}`)}catch(t){i.issuePending.error(`Failed to remove pending state for ${e}:`,t)}}async isPending(e){if(!this.projectKey||!w.validateIssueKey(e))return!1;try{return await k.isPendingIssue(this.projectKey,e)}catch(t){return i.issuePending.error(`Failed to check pending status for ${e}:`,t),!1}}getPendingIssues(){return Array.from(this.pendingStore.values())}getProjectKey(){return this.projectKey}async loadPendingData(){if(this.projectKey)try{const e=await k.getPendingIssues(this.projectKey);this.pendingStore.clear();for(const t of e)this.pendingStore.set(t.issueKey,t);i.issuePending.debug(`Loaded ${e.length} pending issues`)}catch(e){i.issuePending.error("Failed to load pending data:",e)}}scheduleButtonAddition(){requestAnimationFrame(async()=>{await this.addPendingButtonsToCards(!0),setTimeout(async()=>{await this.addPendingButtonsToCards(!0)},1e3)})}async addPendingButtonsToCards(e=!1){const t=w.findIssueCards();i.issuePending.debug(`Found ${t.length} cards during initialization`);let s=0;for(const o of t){const n=w.extractIssueKey(o);if(n){const r=this.issueCardMap.has(n),a=o.querySelector(".pending-toggle-button");c.log(`[IssuePendingFeature] Processing card ${n}: inMap=${r}, hasButton=${!!a}, forceAdd=${e}`),(e||!r)&&!a?(await this.addPendingButtonToCard(o),s++,c.log(`[IssuePendingFeature] Successfully added button to ${n}`)):c.log(`[IssuePendingFeature] Skipped ${n}: inMap=${r}, hasButton=${!!a}`)}else c.log(`[IssuePendingFeature] Could not extract issue key from card: ${o.className}`)}i.issuePending.info(`Added pending buttons to ${s} new cards (${t.length} total found)`)}async addPendingButtonToCard(e){var n;const t=w.extractIssueKey(e);if(!t){c.log(`[IssuePendingFeature] Failed to extract issue key from card: ${e.className}`);return}c.log(`[IssuePendingFeature] Attempting to add button to ${t}`),this.issueCardMap.set(t,e);let s=await this.isPending(t);c.log(`[IssuePendingFeature] ${t} isPending: ${s}`),s&&((n=this.settings)!=null&&n.autoResolve)&&w.isCompletedOrPostCompletionStatus(e)&&(i.issuePending.info(`Auto-resolving pending state for ${t} (completed or post-completion status)`),await this.removePendingState(t),s=!1),w.addPendingButton(e,s,()=>{this.togglePending(t)})?(w.applyPendingVisual(e,s),i.issuePending.debug(`Successfully added pending button to ${t}`)):i.issuePending.warn(`Failed to add button to ${t} - button creation returned null`)}async updateCardVisualState(e){const t=this.issueCardMap.get(e);if(!t)return;const s=await this.isPending(e),o=t.querySelector(".pending-toggle-button");o&&w.updatePendingButton(o,s),w.applyPendingVisual(t,s)}async refreshCardVisualState(e){const t=w.extractIssueKey(e);if(!t)return;const s=await this.isPending(t);w.applyPendingVisual(e,s),i.issuePending.debug(`Refreshed visual state for ${t}, isPending: ${s}`)}async refreshAllVisibleCards(){const e=document.querySelectorAll(".css-1og413z-box.card, .card"),t=[];e.forEach(s=>{t.push(this.refreshCardVisualState(s))}),await Promise.all(t),i.issuePending.debug(`Refreshed visual state for ${e.length} visible cards`)}observeIssueCards(){this.observer=c.observeChanges(e=>{this.handleMutations(e)})}async handleMutations(e){const t=new Set(this.issueCardMap.values()),s=w.findNewIssueCards(e,t);for(const o of s)await this.addPendingButtonToCard(o);s.length>0&&i.issuePending.debug(`Added buttons to ${s.length} new cards`)}}class ue{constructor(){y(this,"settings",null);y(this,"features",new Map);this.init(),this.setupMessageListener()}getFeature(e){return this.features.get(e)||null}async init(){try{if(!c.isBacklogPage()){c.log("Not a Backlog page, skipping initialization");return}c.log("Initializing Backlog Usability Enhance"),await this.loadSettings(),this.watchSettingsChanges(),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.onDOMReady()):this.onDOMReady(),c.log("Initialization completed")}catch(e){i.error("Failed to initialize Backlog Usability Enhance:",e)}}async loadSettings(){this.settings=await F.getSettings(),c.log("Settings loaded:",this.settings)}watchSettingsChanges(){F.onSettingsChanged(e=>{c.log("Settings changed (from storage):",e),this.handleSettingsChange(e)})}setupMessageListener(){typeof chrome<"u"&&chrome.runtime&&(chrome.runtime.onMessage.addListener((e,t,s)=>(this.handleExtensionMessage(e,t,s),!0)),i.content.info("Extension message listener setup complete"))}async handleExtensionMessage(e,t,s){try{if(i.content.debug("Received extension message:",e),!e||typeof e.type!="string"){i.content.warn("Invalid message format:",e),s({success:!1,error:"Invalid message format"});return}switch(e.type){case"SETTINGS_CHANGED":{const o=e;if(!o.settings){i.content.warn("Missing settings in SETTINGS_CHANGED message"),s({success:!1,error:"Missing settings data"});return}i.content.info("Settings changed (from popup):",o.settings),this.handleSettingsChange(o.settings),s({success:!0});break}default:i.content.warn("Unknown message type:",e.type),s({success:!1,error:"Unknown message type"})}}catch(o){i.content.error("Error in handleExtensionMessage:",o);const n=o instanceof Error?o.message:"Unknown error";s({success:!1,error:n})}}handleSettingsChange(e){const t=this.settings;this.settings=e,this.updateFeatureSettings(t,e),this.applySettings()}updateFeatureSettings(e,t){if(!e)return;const s={boardAccordion:e.boardAccordion.enabled!==t.boardAccordion.enabled,shortcutKeys:e.shortcutKeys.enabled!==t.shortcutKeys.enabled,issuePending:e.issuePending.enabled!==t.issuePending.enabled};if(s.boardAccordion){const o=this.features.get("boardAccordion");o&&(o.destroy(),this.features.delete("boardAccordion"),c.log("Destroyed boardAccordion feature due to enabled status change"))}if(s.shortcutKeys){const o=this.features.get("shortcutKeys");o&&(o.destroy(),this.features.delete("shortcutKeys"),c.log("Destroyed shortcutKeys feature due to enabled status change"))}if(s.issuePending){const o=this.features.get("issuePending");o&&(o.destroy(),this.features.delete("issuePending"),c.log("Destroyed issuePending feature due to enabled status change"))}for(const[o,n]of this.features)if(n.updateSettings)try{n.updateSettings(t),c.log(`Updated settings for feature '${o}'`)}catch(r){i.error(`Failed to update settings for feature '${o}':`,r)}}onDOMReady(){if(!this.settings){c.log("Settings not loaded yet");return}c.log("DOM ready, applying settings"),this.applySettings(),this.watchPageChanges()}applySettings(){if(!this.settings)return;const e=c.getPageInfo();c.log("Current page info:",e),this.toggleFeature("boardAccordion",this.settings.boardAccordion.enabled,()=>{if(e.type==="board"){c.log("Initializing board accordion feature");const t=new ae;t.init(),this.features.set("boardAccordion",{init:()=>t.init(),destroy:()=>t.destroy(),updateSettings:()=>{},_instance:t})}}),this.toggleFeature("shortcutKeys",this.settings.shortcutKeys.enabled,()=>{c.log("Initializing shortcut keys feature");const t=new z;t.init(),this.features.set("shortcutKeys",{init:()=>t.init(),destroy:()=>t.destroy()})}),this.toggleFeature("issuePending",this.settings.issuePending.enabled,()=>{if(e.type==="board"){c.log("Initializing issue pending feature");const t=new de;t.init(),this.features.set("issuePending",{init:()=>t.init(),destroy:()=>t.destroy(),_instance:t})}})}toggleFeature(e,t,s){const o=this.features.get(e);if(t){if(!o)try{s(),c.log(`Feature '${e}' enabled`)}catch(n){i.error(`Failed to enable feature '${e}':`,n)}}else if(o)try{o.destroy(),this.features.delete(e),c.log(`Feature '${e}' disabled`)}catch(n){i.error(`Failed to disable feature '${e}':`,n)}}watchPageChanges(){let e=window.location.href;c.observeChanges(()=>{const t=window.location.href;t!==e&&(e=t,c.log("Page changed:",t),setTimeout(()=>{this.applySettings()},100))})}destroy(){c.log("Destroying Backlog Usability Enhance");for(const[e,t]of this.features)try{t.destroy(),c.log(`Feature '${e}' destroyed`)}catch(s){i.error(`Failed to destroy feature '${e}':`,s)}this.features.clear()}}const V=new ue;window.__backlog_usability_enhance__=V,window.__backlog_usability_enhance_dev__=!0,window.addEventListener("beforeunload",()=>{V.destroy()})})();
